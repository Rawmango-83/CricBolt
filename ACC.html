<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hand Cricket - Fixed</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background:#f3f7fb; padding:20px; text-align:center; }
    .section { margin:20px auto; max-width:900px; padding:15px; background:#fff; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    input, select, textarea, button { font-size:15px; padding:6px 10px; margin:6px; }
    .number-buttons button { width:60px; height:44px; margin:6px; font-size:16px; }
    #log, #ballLog, #bowlerStats { max-height:160px; overflow:auto; border:1px solid #ddd; background:#fafafa; padding:10px; text-align:left; font-family:monospace; }
    #resultBox { margin-top:16px; padding:12px; font-weight:bold; display:none; border-radius:6px; }
    #resultBox.win { background:#d1fae5; color:#065f46; }
    #resultBox.draw { background:#fef3c7; color:#92400e; }
    #resultBox.tie { background:#e0e7ff; color:#3730a3; }
    #dayOversDisplay { margin-top:6px; font-weight:600; }
  </style>
</head>
<body>

  <h1>Hand Cricket</h1>
  <h3>Predefined Teams</h3>
<select id="predefinedTeams" onchange="selectPredefinedTeam()">
  <option value="">--Select Team--</option>
  <option value="india">India</option>
  <option value="australia">Australia</option>
  <option value="england">England</option>
  <option value="pakistan">Pakistan</option>
  <option value="southafrica">South Africa</option>
</select>

<div id="celebrationOverlay" style="
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.8);
  color: white;
  display: none;
  justify-content: center;
  align-items: center;
  font-size: 3rem;
  z-index: 9999;
  text-align: center;
  animation: fadeInOut 2s ease-in-out;
">
  <span id="celebrationText"></span>
</div>

<style>
@keyframes fadeInOut {
  0% { opacity: 0; transform: scale(0.8); }
  20% { opacity: 1; transform: scale(1.2); }
  50% { opacity: 1; transform: scale(1); }
  80% { opacity: 1; transform: scale(1.2); }
  100% { opacity: 0; transform: scale(0.8); }
}
</style>


  <div class="section" id="setup-section">
    <h2>Setup Match</h2>
    <input id="team1" placeholder="Your Team Name" />
    <input id="team2" placeholder="Computer Team Name" value="Computer" />
    <input id="overs" type="number" min="1" max="50" value="2" /> Overs

    <h3>Players (comma-separated)</h3>
    <textarea id="team1Players" rows="4" cols="40" placeholder="Your players (11 recommended)"></textarea><br>
    <textarea id="team2Players" rows="4" cols="40" placeholder="Computer players (11 recommended)"></textarea><br>

    <button onclick="startGame()">Start Game</button>

    <h3>Mode</h3>
    <select id="matchMode" onchange="setMode()">
      <option value="custom">Custom</option>
      <option value="t20i">T20I (4 overs)</option>
      <option value="odi">ODI (10 overs)</option>
      <option value="test">Test (12 overs/day, up to 5 days)</option>
      <option value="rct">RCT (15 overs)</option>
    </select>
  </div>

  <div class="section" id="game-section" style="display:none;">
    <h2 id="matchTitle"></h2>
    <h3 id="batsmenStatus"></h3>
    <p id="overInfo"></p>
<button id="continueDayBtn" style="display:none;" onclick="continueNextDay()">Continue Next Day</button>
<div id="dayOversDisplay">Day 1 | Over 0.0</div>

    <label>Select Bowler:</label>
    <select id="bowlerSelect" onchange="setBowler()"></select>

    <div class="number-buttons">
      <button onclick="playBall(0)">0</button>
      <button onclick="playBall(1)">1</button>
      <button onclick="playBall(2)">2</button>
      <button onclick="playBall(3)">3</button>
      <button onclick="playBall(4)">4</button>
      <button onclick="playBall(5)">5</button>
      <button onclick="playBall(6)">6</button>
    </div>

    <div id="ballLog"></div>
    <div id="log"></div>
    <div id="bowlerStats"></div>
    <div id="resultBox"></div>
  </div>
<script>
/* ========= Game State ========= */
let teamNames = ["",""];
let overs = 2, ballsPerOver = 6, totalBallsPerInnings = 0;
let currentInnings = 0;
let striker = 0, nonStriker = 1;

let teamPlayers = [[], []];
let scores = [0,0,0,0];
let wickets = [0,0,0,0];
let ballsBowled = [0,0,0,0];
let batsmenStats = [[],[],[],[]];
let ballByBall = [[],[],[],[]];
let bowlerStats = [[], []];
let currentBowler = null;
let lastBowler = null;
let recentUserRuns = [];
let targets = [null,null,null,null];

/* Toss & control */
let userTeamIndex = 0;
let compTeamIndex = 1;
let userBattingFirst = true;
let tossWinner = null;

/* Test match universal tracking */
const dayOvers = 12;        // overs per day
const maxDays = 5;
const totalMatchOvers = dayOvers * maxDays; // 60
const totalMatchBallsLimit = totalMatchOvers * ballsPerOver; // 360
let totalMatchBalls = 0;   // universal balls across match (never reset)

let celebrationQueue = [];
let celebrationInProgress = false;

/* ========= Predefined Teams ========= */
const predefinedTeams = {
  india: ["Rohit Sharma","Virat Kohli","KL Rahul","Shreyas Iyer","Rishabh Pant","Hardik Pandya","Jasprit Bumrah","Bhuvneshwar Kumar","Yuzvendra Chahal","Mohammed Shami","Shardul Thakur"],
  australia: ["David Warner","Aaron Finch","Steve Smith","Glenn Maxwell","Pat Cummins","Mitchell Starc","Josh Hazlewood","Alex Carey","Marcus Stoinis","Nathan Lyon","Travis Head"],
  england: ["Joe Root","Ben Stokes","Jos Buttler","Jonny Bairstow","Eoin Morgan","Jofra Archer","Chris Woakes","Moeen Ali","Sam Curran","Mark Wood","Liam Livingstone"],
  pakistan: ["Babar Azam","Shaheen Afridi","Mohammad Rizwan","Fakhar Zaman","Shadab Khan","Haris Rauf","Mohammad Nawaz","Imad Wasim","Asif Ali","Shaheen Shah Afridi","Hassan Ali"],
  southafrica: ["Quinton de Kock","Faf du Plessis","Temba Bavuma","Rassie van der Dussen","Kagiso Rabada","Anrich Nortje","Lungi Ngidi","David Miller","Aiden Markram","Dwaine Pretorius","Heinrich Klaasen"]
};

function selectPredefinedTeam(){
  const teamKey = document.getElementById('predefinedTeams').value;
  if(!teamKey) return;
  document.getElementById('team2Players').value = predefinedTeams[teamKey].join(', ');
}

/* ========= Utilities ========= */
function getBattingTeamIndexForInnings(inn) {
  return (inn === 0 || inn === 2) ? (userBattingFirst ? userTeamIndex : compTeamIndex)
                                  : (userBattingFirst ? compTeamIndex : userTeamIndex);
}

function log(msg) {
  const l = document.getElementById('log');
  l.innerHTML += `<p>${msg}</p>`;
  l.scrollTop = l.scrollHeight;
}

/* ========= Toss ========= */
function doToss(){
  tossWinner = Math.random() < 0.5 ? userTeamIndex : compTeamIndex;
  const decision = tossWinner === userTeamIndex ? 
      (confirm(`${teamNames[userTeamIndex]} won toss! Bat first? OK=Bat, Cancel=Bowl`) ? "bat" : "bowl") :
      (Math.random() < 0.5 ? "bat" : "bowl");

  if(tossWinner === userTeamIndex){
    userBattingFirst = (decision === "bat");
    log(`${teamNames[userTeamIndex]} won toss and chose to ${decision} first.`);
  } else {
    userBattingFirst = (decision === "bowl");
    log(`${teamNames[compTeamIndex]} won toss and chose to ${decision} first.`);
  }
}

/* ========= Setup ========= */
function setMode(){
  const mode = document.getElementById('matchMode').value;
  const oversInput = document.getElementById('overs');
  if(mode === 't20i'){ oversInput.value = 4; oversInput.disabled = true; }
  else if(mode === 'odi'){ oversInput.value = 10; oversInput.disabled = true; }
  else if(mode === 'test'){ oversInput.value = 12; oversInput.disabled = true; }
  else if(mode === 'rct'){ oversInput.value = 15; oversInput.disabled = true; }
  else { oversInput.disabled = false; }
}

function startGame(){
  teamNames[0] = document.getElementById('team1').value || "User Team";
  teamNames[1] = document.getElementById('team2').value || "Computer";
  overs = parseInt(document.getElementById('overs').value);
  totalBallsPerInnings = overs * ballsPerOver;

  teamPlayers[0] = document.getElementById('team1Players').value.split(',').map(p=>p.trim()).filter(Boolean);
  teamPlayers[1] = document.getElementById('team2Players').value.split(',').map(p=>p.trim()).filter(Boolean);

  if(teamPlayers[0].length < 2 || teamPlayers[1].length < 2) { alert('Enter at least 2 players per team.'); return; }

  for(let inn=0; inn<4; inn++){
    batsmenStats[inn] = [];
    for(let p=0; p<11; p++){
      batsmenStats[inn].push({ runs: 0, balls: 0, fiftyShown: false, hundredShown: false });
    }
    ballByBall[inn] = [];
    scores[inn] = 0; 
    wickets[inn] = 0; 
    ballsBowled[inn] = 0; 
    targets[inn] = null;
  }

  for(let t=0; t<2; t++){
    bowlerStats[t] = [];
    for(let j=0;j<11;j++){
      bowlerStats[t].push({ name: teamPlayers[t][j] || `Bowler ${j+1}`, runs:0, balls:0, wickets:0, hatTrickShown:false, threeWktShown:false, fiveWktShown:false, tenWktShown:false, consecutiveWickets:0 });
    }
  }

  doToss();

  currentInnings = 0; striker = 0; nonStriker = 1;
  currentBowler = null; lastBowler = null; recentUserRuns = [];
  totalMatchBalls = 0;

  document.getElementById('setup-section').style.display = 'none';
  document.getElementById('game-section').style.display = 'block';
  document.getElementById('resultBox').style.display = 'none';

  const firstBattingTeam = getBattingTeamIndexForInnings(0);
  log(`${teamNames[firstBattingTeam]} batting first!`);

  updateBowlerOptions();
  updateUI();
  updateDayOversDisplay();
}

/* ========= UI ========= */
function updateUI(){
  // innings-specific overs
  const inningsBalls = ballsBowled[currentInnings];
  const oversCompleted = Math.floor(inningsBalls / ballsPerOver);
  const ballsInOver = inningsBalls % ballsPerOver;

  const battingTeamIndex = getBattingTeamIndexForInnings(currentInnings);
  const playerNames = teamPlayers[battingTeamIndex];

  const strikerName = playerNames[striker] || `Batsman ${striker+1}`;
  const nonStrikerName = playerNames[nonStriker] || `Batsman ${nonStriker+1}`;

  document.getElementById('batsmenStatus').innerText =
    `On Strike: ${strikerName} (${batsmenStats[currentInnings][striker]?.runs||0} - ${batsmenStats[currentInnings][striker]?.balls||0}) | Non-striker: ${nonStrikerName} (${batsmenStats[currentInnings][nonStriker]?.runs||0} - ${batsmenStats[currentInnings][nonStriker]?.balls||0})`;

  let info = `Over: ${oversCompleted}.${ballsInOver} | Wkts: ${wickets[currentInnings]} | Runs: ${scores[currentInnings]}`;
  if(targets[currentInnings]){
    const rem = targets[currentInnings] - scores[currentInnings];
    info += ` | Target: ${targets[currentInnings]} | To Win: ${rem}`;
  }
  document.getElementById('overInfo').innerText = info;

  // Ball Log with lead/target
  let ballLogText = `Ball-by-Ball: ${ballByBall[currentInnings].join(", ")}`;
  if(document.getElementById('matchMode').value === 'test'){
      if(currentInnings % 2 === 1){
          const lead = scores[battingTeamIndex] - scores[currentInnings-1];
          ballLogText += ` | Lead: ${lead}`;
      }
  } else {
      if(targets[currentInnings]){
          const rem = targets[currentInnings] - scores[currentInnings];
          ballLogText += ` | Target: ${targets[currentInnings]} | To Win: ${rem}`;
      }
  }
  document.getElementById('ballLog').innerText = ballLogText;

  // Bowler Stats
  let statsHTML = `<strong>Bowler Stats</strong><br/>`;
  if(currentBowler !== null){
    const bowlingTeamIdx = 1 - battingTeamIndex;
    const b = bowlerStats[bowlingTeamIdx][currentBowler];
    const oversB = `${Math.floor(b.balls/6)}.${b.balls%6}`;
    statsHTML += `${b.name}: ${oversB} ov, ${b.runs}r, ${b.wickets}w`;
  } else { statsHTML += `No bowler selected.`; }
  document.getElementById('bowlerStats').innerHTML = statsHTML;

  updateDayOversDisplay();
}

/* ========= Day/Overs display ========= */
function updateDayOversDisplay(){
    const completedBalls = totalMatchBalls; // total balls bowled in match
    const oversCompleted = Math.floor(completedBalls / ballsPerOver);
    const ballsInOver = completedBalls % ballsPerOver;
    const currDay = Math.floor(completedBalls / (dayOvers * ballsPerOver)) + 1;
    document.getElementById('dayOversDisplay').innerText = `Day ${currDay} | Over ${oversCompleted}.${ballsInOver}`;
}

/* ========= Bowler selection ========= */
function updateBowlerOptions(){
  const sel = document.getElementById('bowlerSelect');
  const bowlTeam = 1 - getBattingTeamIndexForInnings(currentInnings);
  sel.innerHTML = '';
  bowlerStats[bowlTeam].forEach((b, idx) => {
    const opt = document.createElement('option');
    opt.value = idx;
    opt.text = b.name;
    sel.appendChild(opt);
  });

  sel.disabled = (currentBowler !== null);
  sel.value = currentBowler!==null ? currentBowler : '';
  togglePlayButtons(currentBowler !== null);
}

function setBowler(){
  const val = document.getElementById('bowlerSelect').value;
  const sel = parseInt(val);
  if(isNaN(sel)){ return; }
  if(sel === lastBowler){ alert('Same bowler cannot bowl consecutive overs.'); return; }
  currentBowler = sel;
  document.getElementById('bowlerSelect').disabled = true;
  togglePlayButtons(true);
  updateUI();
}

function togglePlayButtons(enable){
  document.querySelectorAll('.number-buttons button').forEach(b => b.disabled = !enable);
}

/* ========= Smart Opponent Run ========= */
function getSmartBattingRun(){
    const battingTeamIndex = getBattingTeamIndexForInnings(currentInnings);
    const isComputerBatting = (battingTeamIndex === compTeamIndex);
    if(!isComputerBatting) return null;

    const ballsLeft = totalBallsPerInnings - ballsBowled[currentInnings];
    const wicketsLeft = 10 - wickets[currentInnings];
    const runsNeeded = targets[currentInnings] ? targets[currentInnings] - scores[currentInnings] : 0;
    const rpo = ballsLeft > 0 ? runsNeeded / (ballsLeft/ballsPerOver) : 0;

    let run;

    if(wicketsLeft > 5){ 
        const r = Math.random();
        if(r < 0.6) run = 6;
        else if(r < 0.85) run = Math.random() < 0.5 ? 4 : 5;
        else run = 2 + Math.floor(Math.random()*3);
    } else {
        const r = Math.random();
        if(r < 0.4) run = 2 + Math.floor(Math.random()*3);
        else run = 4 + Math.floor(Math.random()*2);
    }

    if(targets[currentInnings]){
        if(rpo > 8) run = Math.random() < 0.7 ? 6 : run;
        if(ballsLeft <= 6) run = Math.random() < 0.75 ? 6 : run;
    }

    return run;
}

function getSmartBowlingRun() {
    const battingTeamIndex = getBattingTeamIndexForInnings(currentInnings);
    const isComputerBatting = (battingTeamIndex === compTeamIndex);

    if(isComputerBatting) return null;

    let predictedRun = null;
    const lastTwoUserRuns = recentUserRuns.slice(-2);
    if(lastTwoUserRuns.length === 2 && lastTwoUserRuns[0] === lastTwoUserRuns[1]){
        predictedRun = lastTwoUserRuns[1];
    }

    let delivery;

    if(predictedRun !== null){
        delivery = predictedRun;
    } else {
        const r = Math.random();
        if(r < 0.6) delivery = 6;
        else if(r < 0.8) delivery = Math.random() < 0.5 ? 4 : 5;
        else delivery = Math.floor(Math.random()*4);
    }

    const ballsLeft = totalBallsPerInnings - ballsBowled[currentInnings];
    const runsNeeded = targets[currentInnings] ? targets[currentInnings] - scores[currentInnings] : 0;
    const rpo = ballsLeft > 0 ? runsNeeded / (ballsLeft/ballsPerOver) : 0;

    if(targets[currentInnings]){
        if(ballsLeft <= 6 || rpo > 8) delivery = Math.random() < 0.75 ? 6 : delivery;
        else if(rpo > 5) delivery = Math.random() < 0.5 ? 6 : delivery;
    }

    return delivery;
}

/* ========= Play Ball ========= */
function playBall(userRun){
  if(currentBowler === null) { alert('Please select a bowler.'); return; }
  if(document.getElementById('continueDayBtn').style.display !== 'none') { alert('Day ended ‚Äî click Continue Next Day to proceed.'); return; }

  const battingTeamIndex = getBattingTeamIndexForInnings(currentInnings);
  const bowlingTeamIndex = 1 - battingTeamIndex;
  const strikerStats = batsmenStats[currentInnings][striker];
  const bowler = bowlerStats[bowlingTeamIndex][currentBowler];

  let batsRun = 0;
  let out = false;
  const isComputerBatting = (battingTeamIndex === compTeamIndex);

  // ===== Determine runs & out (use state BEFORE incrementing balls) =====
  if(isComputerBatting){
      batsRun = getSmartBattingRun();
      out = (userRun === batsRun);
  } else {
      batsRun = userRun;
      const compDelivery = getSmartBowlingRun();
      out = (batsRun === compDelivery);

      recentUserRuns.push(batsRun);
      if(recentUserRuns.length > 5) recentUserRuns.shift();
  }

  // ===== Increment counters ONCE =====
  ballsBowled[currentInnings]++;
  totalMatchBalls++;
  // bowler ball counted
  bowler.balls++;

  // Prepare celebration queue for this ball
  const thisBallQueue = [];

  if(out){
      strikerStats.balls++;
      wickets[currentInnings]++;
      bowler.wickets++;
      bowler.consecutiveWickets = (bowler.consecutiveWickets || 0) + 1;

      // fake run attempt text
      let fakeRun = 0;
      if(Math.random() < 0.3){ fakeRun = [2,3,4,5,6][Math.floor(Math.random()*5)]; }
      log(`${teamPlayers[battingTeamIndex][striker]} is OUT!${fakeRun ? ` (tried to hit ${fakeRun} runs before getting caught)` : ''}`);
      striker = wickets[currentInnings] + 1;

      thisBallQueue.push("üéØ WICKET!");

      if(bowler.consecutiveWickets === 3 && !bowler.hatTrickShown){ bowler.hatTrickShown = true; thisBallQueue.push(`üé© HAT-TRICK by ${bowler.name}!`); }
      if(!bowler.threeWktShown && bowler.wickets >= 3){ bowler.threeWktShown = true; thisBallQueue.push(`üî• 3 WKT HAUL by ${bowler.name}!`); }
      if(!bowler.fiveWktShown && bowler.wickets >= 5){ bowler.fiveWktShown = true; thisBallQueue.push(`üî•üî• 5 WKT HAUL by ${bowler.name}!`); }
      if(!bowler.tenWktShown && bowler.wickets >= 10){ bowler.tenWktShown = true; thisBallQueue.push(`üí• LEGENDARY 10 WKT HAUL by ${bowler.name}!`); }

  } else {
      strikerStats.runs += batsRun;
      strikerStats.balls++;
      scores[currentInnings] += batsRun;

      // Immediate chase check for limited overs
      if(targets[currentInnings] && scores[currentInnings] >= targets[currentInnings]){
          ballByBall[currentInnings].push(batsRun);
          updateUI();
          enqueueAndPlay(thisBallQueue, endInnings);
          return; // stop further processing
      }

      bowler.runs += batsRun;
      bowler.consecutiveWickets = 0;

      if(batsRun === 1 || batsRun === 3) [striker, nonStriker] = [nonStriker, striker];

      if(strikerStats.runs >= 50 && !strikerStats.fiftyShown){ strikerStats.fiftyShown = true; thisBallQueue.push(`üèè ${teamPlayers[battingTeamIndex][striker]} reaches 50!`); }
      if(strikerStats.runs >= 100 && !strikerStats.hundredShown){ strikerStats.hundredShown = true; thisBallQueue.push(`üèè ${teamPlayers[battingTeamIndex][striker]} reaches 100!`); }

      if(batsRun === 6){ thisBallQueue.push("üí• SIX!"); }
  }

  ballByBall[currentInnings].push(out ? 'W' : batsRun);
  updateUI();

  // ===== Test Mode: Innings-End (all-out) first, then day-end =====
  if(document.getElementById('matchMode').value === 'test'){
      // 1) Innings ends only on all-out
      if(wickets[currentInnings] >= 10){
          enqueueAndPlay(thisBallQueue, endInnings);
          return;
      }

      // 2) Day end (stumps) ‚Äî compute day that just ended correctly
      if(totalMatchBalls % (dayOvers * ballsPerOver) === 0 && totalMatchBalls < totalMatchBallsLimit){
          const endedDay = Math.floor((totalMatchBalls - 1) / (dayOvers * ballsPerOver)) + 1;
          log(`--- Stumps: Day ${endedDay} Ends ---`);
          document.querySelectorAll('.number-buttons button').forEach(b => b.disabled = true);
          document.getElementById('bowlerSelect').disabled = true;
          document.getElementById('continueDayBtn').style.display = "inline-block";
          return;
      }

      // 3) Match draw if total balls reached
      if(totalMatchBalls >= totalMatchBallsLimit){
          enqueueAndPlay(thisBallQueue, () => finishMatch("Match Drawn - 60 overs completed","draw"));
          return;
      }
  }

  // ===== End of over logic =====
  if(document.getElementById('matchMode').value === 'test'){
      if(totalMatchBalls % ballsPerOver === 0){
          [striker, nonStriker] = [nonStriker, striker];
          lastBowler = currentBowler;
          currentBowler = null;
          document.getElementById('bowlerSelect').disabled = false;
          log('End of over. Select next bowler.');
      }
  } else {
      if(ballsBowled[currentInnings] % ballsPerOver === 0){
          [striker, nonStriker] = [nonStriker, striker];
          lastBowler = currentBowler;
          currentBowler = null;
          document.getElementById('bowlerSelect').disabled = false;
          log('End of over. Select next bowler.');
      }
  }

  // ===== End Innings check for limited overs =====n
  if(wickets[currentInnings] >= 10 || (ballsBowled[currentInnings] >= totalBallsPerInnings && document.getElementById('matchMode').value !== 'test')){
      enqueueAndPlay(thisBallQueue, endInnings);
      return;
  }

  // ===== Safety: max balls in tests (draw) =====
  if(document.getElementById('matchMode').value === 'test' && totalMatchBalls >= totalMatchBallsLimit){
      enqueueAndPlay(thisBallQueue, () => finishMatch("Match Drawn - 360 balls (5 days) completed","draw"));
      return;
  }

  // Finally, if nothing above stopped the game, display this ball's celebrations
  enqueueAndPlay(thisBallQueue);
}

/* ========= helper to enqueue and optionally call callback after queue drains ========= */
function enqueueAndPlay(queue, callback){
    if(queue && queue.length){
        queue.forEach(m => celebrationQueue.push(m));
        if(!celebrationInProgress) displayNextCelebration();
        if(callback){
            const checkInterval = setInterval(() => {
                if(!celebrationInProgress && celebrationQueue.length === 0){
                    clearInterval(checkInterval);
                    callback();
                }
            }, 200);
        }
    } else {
        if(callback) callback();
    }
}

/* ========= End Innings & Result ========= */
function endInnings(){
  const battingTeamIndex = getBattingTeamIndexForInnings(currentInnings);
  log(`${teamNames[battingTeamIndex]} innings over: ${scores[currentInnings]}/${wickets[currentInnings]}`);

  if(document.getElementById('matchMode').value==='test'){
    if(currentInnings<3){
      currentInnings++; striker=0; nonStriker=1; // DO NOT reset totalMatchBalls or day counters
      log(`${teamNames[getBattingTeamIndexForInnings(currentInnings)]} start batting for innings ${currentInnings+1}`);
      updateBowlerOptions(); updateUI();
    } else {
      const team1Total = scores[0]+scores[2];
      const team2Total = scores[1]+scores[3];
      if(team1Total===team2Total) finishMatch('Match TIED ü§ù','tie');
      else if(team1Total>team2Total) finishMatch(`${teamNames[userTeamIndex]} WIN by ${team1Total-team2Total} runs`,'win');
      else finishMatch(`${teamNames[compTeamIndex]} WIN by ${team2Total-team1Total} runs`,'win');
    }
  } else {
    if(currentInnings===0){
      targets[1]=scores[0]+1; currentInnings=1; striker=0; nonStriker=1;
      log(`${teamNames[getBattingTeamIndexForInnings(1)]} need ${targets[1]} to win.`);
      updateBowlerOptions(); updateUI();
    } else {
      if(scores[1]===scores[0]) finishMatch('Match TIED ü§ù','tie');
      else if(scores[1]<scores[0]) finishMatch(`${teamNames[getBattingTeamIndexForInnings(0)]} WIN by ${scores[0]-scores[1]} runs`,'win');
      else finishMatch(`${teamNames[getBattingTeamIndexForInnings(1)]} WIN by ${10-wickets[1]} wickets`,'win');
    }
  }
}

function showScorecard(){
  const scoreDiv = document.getElementById('log');
  scoreDiv.innerHTML += `<hr><h3>Final Scorecard</h3>`;

  for(let inn=0; inn<4; inn++){
    const teamIndex = getBattingTeamIndexForInnings(inn);
    if(scores[inn]===0 && wickets[inn]===0) continue;

    scoreDiv.innerHTML += `<h4>${teamNames[teamIndex]} - Innings ${ (inn%2)+1 }: ${scores[inn]}/${wickets[inn]}</h4>`;

    let batsHTML = '<strong>Batsmen:</strong><br>';
    for(let i=0;i<teamPlayers[teamIndex].length;i++){
      const stats = batsmenStats[inn][i];
      if(stats) batsHTML += `${teamPlayers[teamIndex][i]}: ${stats.runs}(${stats.balls})<br>`;
    }
    scoreDiv.innerHTML += batsHTML;

    let bowlHTML = '<strong>Bowlers:</strong><br>';
    const bowlingTeamIdx = 1 - teamIndex;
    bowlerStats[bowlingTeamIdx].forEach(b=>{
      if(b.balls>0){
        const overs = Math.floor(b.balls/6) + '.' + (b.balls%6);
        bowlHTML += `${b.name}: ${overs} ov, ${b.runs}r, ${b.wickets}w<br>`;
      }
    });
    scoreDiv.innerHTML += bowlHTML;
  }
}

/* ========= Finish Match ========= */
function finishMatch(resultText, resultType){
  log(`<strong>${resultText}</strong>`);
  showScorecard();
  document.querySelectorAll("button").forEach(btn => btn.disabled = true);
  document.getElementById("bowlerSelect").disabled = true;
  const pdfBtn = document.createElement("button");
  pdfBtn.textContent = "üìÑ Download Scorecard (PDF)";
  pdfBtn.onclick = downloadPDF;
  const rb = document.getElementById("resultBox");
  rb.innerHTML = ''; rb.appendChild(pdfBtn); rb.style.display = "block";
}

function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 20; 
  doc.setFontSize(16); 
  doc.text("Final Scorecard", 80, y); 
  y += 10;

  for(let inn=0; inn<4; inn++){
    const teamIndex = getBattingTeamIndexForInnings(inn);
    if(scores[inn]===0 && wickets[inn]===0) continue;

    doc.setFontSize(14); 
    doc.text(`${teamNames[teamIndex]} - Innings ${ (inn%2)+1 }: ${scores[inn]}/${wickets[inn]}`, 20, y); 
    y += 8;

    doc.setFontSize(12);
    doc.text("Batsmen:", 20, y); 
    y += 6;
    for(let i=0; i<teamPlayers[teamIndex].length; i++){
      const stats = batsmenStats[inn][i];
      if(stats) {
        doc.text(`${teamPlayers[teamIndex][i]}: ${stats.runs} (${stats.balls})`, 30, y);
        y += 6;
      }
    }

    y += 4;
    doc.text("Bowlers:", 20, y); 
    y += 6;
    const bowlingTeamIdx = 1 - teamIndex;
    bowlerStats[bowlingTeamIdx].forEach(b=>{
      if(b.balls>0){
        const overs = Math.floor(b.balls/6) + '.' + (b.balls%6);
        doc.text(`${b.name}: ${overs} ov, ${b.runs}r, ${b.wickets}w`, 30, y);
        y += 6;
      }
    });
    y += 10;
  }

  doc.save("Scorecard.pdf");
}


/* ========= Celebrations (queue) ========= */
function showCelebration(message){
    celebrationQueue.push(message);
    if(!celebrationInProgress){ displayNextCelebration(); }
}
function displayNextCelebration(){
    if(celebrationQueue.length === 0){ celebrationInProgress = false; return; }
    celebrationInProgress = true;
    const overlay = document.getElementById('celebrationOverlay');
    const text = document.getElementById('celebrationText');
    const msg = celebrationQueue.shift();
    text.innerHTML = msg; overlay.style.display = 'flex';
    setTimeout(() => { overlay.style.display = 'none'; setTimeout(displayNextCelebration, 300); }, 2500);
}

function continueNextDay() {
    // Just re-enable play ‚Äî days are calculated from totalMatchBalls
    currentBowler = null;
    lastBowler = null;
    document.getElementById('bowlerSelect').disabled = false;
    togglePlayButtons(false);

    document.getElementById('continueDayBtn').style.display = 'none';
    const nextDay = Math.floor(totalMatchBalls / (dayOvers * ballsPerOver)) + 1;
    log(`--- Day ${nextDay} Starts ---`);
    updateUI();
    updateDayOversDisplay();
}

</script>

</body>
</html>
