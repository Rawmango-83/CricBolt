<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Content Security Policy for basic XSS hardening -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdnjs.cloudflare.com https://www.gstatic.com https://www.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firestore.googleapis.com; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https:;">
  <title>Hand Cricket - Tournament Edition</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;text-align:center}
    .container{max-width:1200px;margin:0 auto}
    h1{color:white;margin-bottom:10px;font-size:2.5rem;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
    .section{margin:20px auto;max-width:95%;width:100%;padding:20px;background:#fff;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.1)}
    .section h2{color:#667eea;margin-bottom:15px}
    input,select,textarea,button{font-size:16px;padding:12px;margin:6px 0;width:100%;border:2px solid #e2e8f0;border-radius:8px;font-family:inherit;transition:all 0.3s ease}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}
    button{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;cursor:pointer;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
    button:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.4)}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .number-buttons{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:10px;margin:20px 0}
    .number-buttons button{font-size:24px;font-weight:bold;padding:15px;aspect-ratio:1;border-radius:50%}
    #log,#ballLog,#bowlerStats{max-height:200px;overflow-y:auto;border:2px solid #e2e8f0;background:#f8fafc;padding:15px;text-align:left;font-family:'Courier New',monospace;border-radius:8px;margin:10px 0;font-size:14px;line-height:1.6}
    #resultBox{margin-top:20px;padding:15px;font-weight:bold;display:none;border-radius:8px;font-size:18px}
    #resultBox.win{background:#d1fae5;color:#065f46}
    #resultBox.draw{background:#fef3c7;color:#92400e}
    #resultBox.tie{background:#e0e7ff;color:#3730a3}
    #dayOversDisplay{margin:10px 0;font-weight:600;font-size:16px;color:#4a5568;padding:10px;background:#edf2f7;border-radius:8px}
    #celebrationOverlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);color:white;display:none;justify-content:center;align-items:center;font-size:3rem;z-index:9999;text-align:center;font-weight:bold}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:15px 0}
    .stat-card{background:#f8fafc;padding:15px;border-radius:8px;border-left:4px solid #667eea}
    .stat-label{font-size:12px;color:#718096;text-transform:uppercase;letter-spacing:0.5px}
    .stat-value{font-size:24px;font-weight:bold;color:#2d3748;margin-top:5px}
    .tournament-nav{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
    .tournament-nav button{flex:1;min-width:150px}
    .points-table{width:100%;border-collapse:collapse;margin:20px 0}
    .points-table th,.points-table td{padding:12px;text-align:left;border-bottom:1px solid #e2e8f0}
    .points-table th{background:#667eea;color:white;font-weight:600}
    .points-table tr:hover{background:#f7fafc}
    .qualified{background:#d1fae5 !important}
    .match-card{background:white;border:2px solid #e2e8f0;border-radius:8px;padding:15px;margin:10px 0;cursor:pointer;transition:all 0.3s ease}
    .match-card:hover{border-color:#667eea;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    .match-card.completed{opacity:0.7}
    .trophy-animation{position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:none;justify-content:center;align-items:center;flex-direction:column;z-index:10000}
    .trophy-animation.active{display:flex}
    .trophy{font-size:150px;animation:bounce 1s infinite}
    .confetti{position:absolute;width:10px;height:10px;background:#ffd700;animation:confettiFall 3s linear infinite}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-30px)}}
    @keyframes confettiFall{0%{transform:translateY(-100vh) rotateZ(0deg);opacity:1}100%{transform:translateY(100vh) rotateZ(720deg);opacity:0}}
    @keyframes winCelebration{0%{opacity:0;transform:scale(0.5)}50%{opacity:1;transform:scale(1.2)}100%{opacity:1;transform:scale(1)}}
    .win-celebration{animation:winCelebration 0.8s ease-out;background:linear-gradient(135deg,#48bb78 0%,#38a169 100%);color:white;padding:30px;border-radius:16px;font-size:2rem;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
    #globalHomeBtn{position:fixed;top:15px;left:15px;z-index:5000;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:10px 20px;border-radius:50px;cursor:pointer;font-weight:700;font-size:14px;box-shadow:0 4px 12px rgba(102,126,234,0.5);display:none;width:auto;text-transform:uppercase}
    #globalHomeBtn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(102,126,234,0.6)}
    #globalHistoryBtn{position:fixed;top:15px;right:15px;z-index:5000;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:none;padding:10px 20px;border-radius:50px;cursor:pointer;font-weight:700;font-size:14px;box-shadow:0 4px 12px rgba(245,158,11,0.5);width:auto;text-transform:uppercase}
    #globalHistoryBtn:hover{transform:translateY(-2px)}
    /* Music button */
    #musicToggleBtn{position:fixed;bottom:20px;right:20px;z-index:5000;background:linear-gradient(135deg,#48bb78,#38a169);color:white;border:none;padding:12px 18px;border-radius:50px;cursor:pointer;font-weight:700;font-size:14px;box-shadow:0 4px 12px rgba(72,187,120,0.5);width:auto;text-transform:uppercase}
    #musicToggleBtn:hover{transform:translateY(-2px)}
    .hmodal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:flex-start;z-index:8000;overflow-y:auto;padding:20px}
    .hmodal-bg.open{display:flex}
    .hmodal-box{background:white;border-radius:16px;width:100%;max-width:900px;max-height:90vh;overflow-y:auto;padding:30px;position:relative;margin:auto}
    .hmodal-close{position:absolute;top:15px;right:15px;background:#ef4444;color:white;border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:18px;font-weight:bold;line-height:1;width:auto;padding:6px 12px}
    .htab-btn{padding:10px 20px;margin:4px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;width:auto;text-transform:none;background:#667eea;color:white}
    .htab-btn.active{background:#764ba2}
    .mhi{background:#f7fafc;padding:18px;margin:12px 0;border-radius:10px;border-left:5px solid #667eea;text-align:left}
    .mhi.won{border-left-color:#48bb78;background:#f0fff4}
    .mhi.lost{border-left-color:#ef4444;background:#fef2f2}
    .mhi.draw{border-left-color:#f59e0b;background:#fffbeb}
    .rmodal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:7000;padding:20px}
    .rmodal-bg.open{display:flex}
    .rmodal-box{background:white;border-radius:16px;width:100%;max-width:700px;max-height:85vh;overflow-y:auto;padding:30px}
    .tournament-card{border:2px solid #e2e8f0;border-radius:12px;padding:20px;margin:12px 0;cursor:pointer;transition:all 0.3s;text-align:left;background:white;display:block;width:100%;text-transform:none;letter-spacing:0}
    .tournament-card:hover{border-color:#667eea;transform:translateY(-2px);box-shadow:0 4px 16px rgba(102,126,234,0.2)}
    /* Leaderboard */
    .lb-card{background:linear-gradient(135deg,#f7fafc,#edf2f7);border:2px solid #e2e8f0;border-radius:12px;padding:20px;margin:12px 0;text-align:left}
    .lb-rank-1{border-color:#ffd700;background:linear-gradient(135deg,#fffbeb,#fef3c7)}
    .lb-rank-2{border-color:#9ca3af;background:linear-gradient(135deg,#f9fafb,#f3f4f6)}
    .lb-rank-3{border-color:#cd7c2f;background:linear-gradient(135deg,#fdf6ec,#fde8c8)}
    @media(max-width:768px){h1{font-size:2rem}.number-buttons{grid-template-columns:repeat(4,1fr)}.number-buttons button{font-size:20px}#celebrationOverlay{font-size:2rem;padding:20px}.trophy{font-size:80px}#globalHomeBtn,#globalHistoryBtn{padding:8px 14px;font-size:12px}}
    @media(max-width:480px){.section{padding:15px}.number-buttons button{font-size:18px;padding:12px}}
    /* Toss overlay */
    #tossOverlay{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:9500;display:none;align-items:center;justify-content:center;animation:tossIn .35s ease}
    #tossOverlay.show{display:flex}
    @keyframes tossIn{from{opacity:0;transform:scale(.7)}to{opacity:1;transform:scale(1)}}
    #tossBox{background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);border:2px solid #667eea;border-radius:20px;padding:40px 50px;text-align:center;color:white;min-width:300px;max-width:90vw;box-shadow:0 0 60px rgba(102,126,234,.5);animation:tossSlide .4s cubic-bezier(.175,.885,.32,1.275)}
    @keyframes tossSlide{from{transform:translateY(-60px);opacity:0}to{transform:translateY(0);opacity:1}}
    #tossIcon{font-size:64px;display:block;animation:tossCoin 1s ease-in-out}
    @keyframes tossCoin{0%{transform:rotateY(0)}25%{transform:rotateY(180deg)}50%{transform:rotateY(360deg)}75%{transform:rotateY(540deg)}100%{transform:rotateY(720deg)}}
    #tossTitle{font-size:1.6em;font-weight:700;margin:12px 0 6px;color:#a5b4fc}
    #tossMsg{font-size:1.15em;color:#e2e8f0;margin-bottom:6px;line-height:1.5}
    #tossSubMsg{font-size:.95em;color:#94a3b8;margin-bottom:20px}
    .toss-choice-row{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;margin-top:10px}
    .toss-choice-btn{padding:12px 32px;border:none;border-radius:50px;font-size:1em;font-weight:700;cursor:pointer;transition:all .2s;letter-spacing:.5px}
    .toss-choice-btn.bat{background:linear-gradient(135deg,#48bb78,#38a169);color:white;box-shadow:0 4px 14px rgba(72,187,120,.4)}
    .toss-choice-btn.bat:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(72,187,120,.6)}
    .toss-choice-btn.bowl{background:linear-gradient(135deg,#f6ad55,#ed8936);color:white;box-shadow:0 4px 14px rgba(237,137,54,.4)}
    .toss-choice-btn.bowl:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(237,137,54,.6)}
    .toss-choice-btn.ok{background:linear-gradient(135deg,#667eea,#764ba2);color:white;box-shadow:0 4px 14px rgba(102,126,234,.4)}
    .toss-choice-btn.ok:hover{transform:translateY(-2px)}
    .toss-choice-btn.followon{background:linear-gradient(135deg,#f6ad55,#ed8936);color:white;box-shadow:0 4px 14px rgba(237,137,54,.4)}
    .toss-choice-btn.followon:hover{transform:translateY(-2px)}
    .toss-choice-btn.nofollow{background:linear-gradient(135deg,#667eea,#764ba2);color:white;box-shadow:0 4px 14px rgba(102,126,234,.4)}
    .toss-choice-btn.nofollow:hover{transform:translateY(-2px)}
    /* Music visualizer bars */
    .music-bars{display:inline-flex;gap:2px;align-items:flex-end;height:16px;margin-left:6px;vertical-align:middle}
    .music-bars span{display:inline-block;width:3px;background:white;border-radius:2px;animation:barAnim 0.8s ease-in-out infinite}
    .music-bars span:nth-child(1){height:6px;animation-delay:0s}
    .music-bars span:nth-child(2){height:12px;animation-delay:0.15s}
    .music-bars span:nth-child(3){height:8px;animation-delay:0.3s}
    .music-bars span:nth-child(4){height:14px;animation-delay:0.1s}
    .music-bars span:nth-child(5){height:5px;animation-delay:0.45s}
    @keyframes barAnim{0%,100%{transform:scaleY(0.3)}50%{transform:scaleY(1)}}
    .music-bars.paused span{animation-play-state:paused}
  </style>
</head>
<body>

<!-- FIXED GLOBAL BUTTONS -->
<button id="globalHomeBtn" onclick="returnToHome()">üè† Home</button>
<button id="musicToggleBtn" onclick="toggleMusic()" title="Toggle Background Music">üéµ Music<span class="music-bars paused" id="musicBars"><span></span><span></span><span></span><span></span><span></span></span></button>

<!-- TOSS / ANNOUNCEMENT OVERLAY -->
<div id="tossOverlay">
  <div id="tossBox">
    <span id="tossIcon">ü™ô</span>
    <div id="tossTitle">Toss Time!</div>
    <div id="tossMsg"></div>
    <div id="tossSubMsg"></div>
    <div class="toss-choice-row" id="tossChoiceRow"></div>
  </div>
</div>
<button id="globalHistoryBtn" onclick="openHistoryModal()">üìä History</button>

<!-- HISTORY MODAL -->
<div class="hmodal-bg" id="historyModal">
  <div class="hmodal-box">
    <button class="hmodal-close" onclick="closeHistoryModal()">‚úï Close</button>
    <h2 style="color:#667eea;margin-bottom:20px">üìä Match &amp; Tournament History</h2>
    <div style="margin-bottom:20px;display:flex;flex-wrap:wrap;gap:8px">
      <button class="htab-btn active" id="htab-all" onclick="showHistoryTab('all')">üèè All Matches</button>
      <button class="htab-btn" id="htab-tournaments" onclick="showHistoryTab('tournaments')">üèÜ Tournaments</button>
      <button class="htab-btn" id="htab-stats" onclick="showHistoryTab('stats')">üìà Career Stats</button>
      <button class="htab-btn" id="htab-leaderboard" onclick="showHistoryTab('leaderboard')">ü•á Leaderboard</button>
      <button class="htab-btn" onclick="clearAllHistoryData()" style="background:#ef4444">üóë Clear All</button>
    </div>
    <div id="historyTabContent"></div>
  </div>
</div>

<!-- RESUME TOURNAMENT MODAL -->
<div class="rmodal-bg" id="resumeModal">
  <div class="rmodal-box">
    <h2 style="color:#667eea;margin-bottom:10px">‚ñ∂Ô∏è Resume Tournament</h2>
    <p style="color:#718096;margin-bottom:20px">Select a saved tournament to continue:</p>
    <div id="resumeList"></div>
    <button onclick="closeResumeModal()" style="margin-top:20px;background:#718096">Cancel</button>
  </div>
</div>

<div class="container">
  <!-- WELCOME PAGE -->
  <div class="section" id="welcome-section" style="text-align:center;max-width:900px;margin:0 auto">
    <h1 style="font-size:3em;margin:30px 0;color:#667eea">üèè Hand Cricket</h1>
    <p style="font-size:1.3em;color:#666;margin-bottom:40px">The Ultimate Cricket Tournament Simulator</p>
    <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:40px;border-radius:20px;margin:30px 0">
      <h2 style="color:white;margin-bottom:20px">üéÆ Welcome to Hand Cricket!</h2>
      <p style="font-size:1.1em;line-height:1.8">Experience the thrill of international cricket tournaments. Choose your team, compete in multiple formats, and lead your nation to glory!</p>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:30px 0;text-align:left">
      <div style="background:#f7fafc;padding:25px;border-radius:15px;border-left:5px solid #48bb78">
        <h3 style="color:#48bb78;margin-bottom:15px">üìã How to Play</h3>
        <ul style="line-height:2;color:#4a5568">
          <li>Choose a number (0-6) to bat</li>
          <li>If you match AI's number = OUT!</li>
          <li>Otherwise, score that many runs</li>
          <li>Select bowlers strategically</li>
          <li>Win matches to advance</li>
        </ul>
      </div>
      <div style="background:#f7fafc;padding:25px;border-radius:15px;border-left:5px solid #f59e0b">
        <h3 style="color:#f59e0b;margin-bottom:15px">üèÜ Tournament Formats</h3>
        <ul style="line-height:2;color:#4a5568">
          <li><strong>ODI World Cup:</strong> 10 overs</li>
          <li><strong>T20 World Cup:</strong> 4 overs</li>
          <li><strong>WTC:</strong> Test matches</li>
          <li><strong>IPL:</strong> 5 overs franchise</li>
        </ul>
      </div>
    </div>
    <div id="historySection" style="background:#edf2f7;padding:30px;border-radius:15px;margin:30px 0">
      <h3 style="color:#2d3748;margin-bottom:20px">üèÖ Your Tournament History</h3>
      <div id="historyContent"><p style="font-style:italic;color:#718096">No tournaments won yet. Start playing!</p></div>
    </div>
    <!-- Google Sign-In -->
    <div id="authSection" style="background:white;padding:30px;border-radius:15px;margin:30px 0;box-shadow:0 4px 12px rgba(0,0,0,0.1)">
      <div id="signedOutView">
        <h3 style="color:#2d3748;margin-bottom:15px">‚òÅÔ∏è Save Your Progress</h3>
        <p style="color:#718096;margin-bottom:20px">Sign in with Google to save tournament progress to the cloud and join the global leaderboard!</p>
        <button onclick="signInWithGoogle()" style="background:white;color:#444;padding:12px 30px;border:2px solid #ddd;border-radius:5px;cursor:pointer;font-size:16px;display:inline-flex;align-items:center;gap:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1);width:auto;text-transform:none">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" height="20" alt="G">Sign in with Google
        </button>
      </div>
      <div id="signedInView" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:15px">
          <div style="display:flex;align-items:center;gap:15px">
            <img id="userPhoto" src="" alt="User" style="width:50px;height:50px;border-radius:50%;border:2px solid #667eea">
            <div style="text-align:left">
              <p style="color:#2d3748;font-weight:bold;margin:0" id="userName">User Name</p>
              <p style="color:#718096;font-size:14px;margin:5px 0 0 0" id="userEmail">email</p>
            </div>
          </div>
          <div style="display:flex;gap:10px">
            <button onclick="saveProgressToCloud()" style="padding:10px 20px;background:#48bb78;color:white;border:none;border-radius:5px;cursor:pointer;width:auto">üíæ Save</button>
            <button onclick="signOutUser()" style="padding:10px 20px;background:#718096;color:white;border:none;border-radius:5px;cursor:pointer;width:auto">Sign Out</button>
          </div>
        </div>
        <p id="lastSyncTime" style="color:#a0aec0;font-size:14px;margin-top:15px"></p>
      </div>
    </div>
    <button onclick="startHandCricket()" style="padding:20px 60px;font-size:1.5em;border-radius:50px;margin:20px 0;box-shadow:0 10px 30px rgba(102,126,234,0.4)">üéÆ Try Hand Cricket</button>
    <br>
    <button id="resumeTournamentBtn" onclick="openResumeModal()" style="display:none;background:linear-gradient(135deg,#48bb78,#38a169);padding:15px 40px;font-size:1.2em;border-radius:50px;margin:10px 0 30px 0;box-shadow:0 6px 20px rgba(72,187,120,0.4)">‚ñ∂Ô∏è Resume Tournament</button>
    <p style="color:#a0aec0;margin-top:30px">Made with ‚ù§Ô∏è for Cricket Fans | Version 3.3</p>
  </div>

  <h1 style="display:none" id="main-title">üèè Hand Cricket - Tournament Edition</h1>
  <div id="celebrationOverlay"><span id="celebrationText"></span></div>
  <div id="trophyAnimation" class="trophy-animation">
    <div class="trophy">üèÜ</div>
    <h1 style="color:white;margin-top:20px" id="trophyText">CHAMPION!</h1>
    <button onclick="closeTrophy()" style="margin-top:30px;padding:15px 40px">Continue</button>
  </div>

  <!-- SETUP SECTION -->
  <div class="section" id="setup-section" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
      <h2>‚öôÔ∏è Setup Match</h2>
      <button onclick="returnToHome()" style="width:auto;padding:8px 18px;background:#718096;font-size:13px">üè† Home</button>
    </div>
    <h3>Select Mode</h3>
    <select id="matchMode" onchange="handleModeChange()">
      <option value="custom">Custom Match</option>
      <option value="t20i">T20I (4 overs)</option>
      <option value="odi">ODI (10 overs)</option>
      <option value="test">Test (25 overs/day, 5 days)</option>
      <option value="rct">RCT (15 overs)</option>
      <option value="ipl">IPL (5 overs)</option>
      <option value="tournament">üèÜ Tournament Mode</option>
    </select>
    <div id="customMatchSetup">
      <h3>Predefined Teams</h3>
      <select id="predefinedTeams" onchange="handleTeamSelection()">
        <option value="">--Select Team--</option>
      </select>
      <h3>Team Names</h3>
      <div class="team-inputs" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px">
        <input id="team1" placeholder="Your Team Name" maxlength="50"/>
        <input id="team2" placeholder="Computer Team Name" value="Computer" maxlength="50"/>
      </div>
      <label for="overs">Number of Overs</label>
      <input id="overs" type="number" min="1" max="50" value="2"/>
      <h3>Players (comma-separated)</h3>
      <textarea id="team1Players" rows="3" placeholder="Your players" maxlength="2000"></textarea>
      <textarea id="team2Players" rows="3" placeholder="Computer players" maxlength="2000"></textarea>
      <button onclick="startGame()">üéÆ Start Match</button>
    </div>
    <div id="tournamentSetup" style="display:none">
      <h3>üèÜ Select Tournament Format</h3>
      <select id="tournamentFormat" onchange="handleTournamentFormatChange()" style="margin:15px 0">
        <option value="">--Select Format--</option>
        <option value="odiWorldCup">ODI World Cup (10 overs)</option>
        <option value="t20WorldCup">T20 World Cup (4 overs)</option>
        <option value="wtc">WTC - World Test Championship (25 overs)</option>
        <option value="ipl">IPL (5 overs)</option>
      </select>
      <div id="tournamentFormatDetails" style="display:none">
        <p id="formatDescription" style="margin:15px 0;color:#666"></p>
        <h4>Your Team</h4>
        <select id="userTournamentTeam"><option value="">--Select Your Team--</option></select>
        <button onclick="startTournament()">üöÄ Start Tournament</button>
      </div>
    </div>
  </div>

  <!-- TOURNAMENT SECTION -->
  <div class="section" id="tournament-section" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:15px">
      <h2 id="tournamentTitle">üèÜ ODI World Cup</h2>
      <button onclick="returnToHome()" style="width:auto;padding:8px 18px;background:#718096;font-size:13px">üè† Home</button>
    </div>
    <div class="tournament-nav" id="tournamentNav">
      <button onclick="showTournamentStage('challengeLeague')">Challenge League</button>
      <button onclick="showTournamentStage('qualifier')">Qualifier</button>
      <button onclick="showTournamentStage('worldCup')">World Cup</button>
      <button onclick="showTournamentStage('standings')">Standings</button>
      <button onclick="showStatsCorner()" style="background:#f59e0b">üìä Stats</button>
    </div>
    <div id="statsCornerBtn" style="display:none;margin:10px 0">
      <button onclick="showStatsCorner()" style="width:100%;padding:12px;background:#f59e0b">üìä Stats Corner</button>
    </div>
    <div id="tournamentContent"></div>
  </div>

  <!-- GAME SECTION -->
  <div class="section" id="game-section" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:10px">
      <h2 id="matchTitle">Match</h2>
      <div style="display:flex;gap:8px">
        <button id="pauseMatchBtn" style="display:none;background:#f59e0b;width:auto;padding:8px 16px;font-size:13px" onclick="pauseMatch()">‚è∏Ô∏è Pause</button>
        <button onclick="returnToHome()" style="width:auto;padding:8px 16px;background:#718096;font-size:13px">üè† Home</button>
      </div>
    </div>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-label">Score</div><div class="stat-value" id="scoreDisplay">0/0</div></div>
      <div class="stat-card"><div class="stat-label">Overs</div><div class="stat-value" id="oversDisplay">0.0</div></div>
      <div class="stat-card"><div class="stat-label">Target</div><div class="stat-value" id="targetDisplay">-</div></div>
    </div>
    <h3 id="batsmenStatus"></h3>
    <div id="dayOversDisplay">Day 1 | Over 0.0</div>
    <label for="bowlerSelect">Select Bowler:</label>
    <select id="bowlerSelect" onchange="handleBowlerSelection()"></select>
    <div class="number-buttons">
      <button onclick="playBall(0)">0</button>
      <button onclick="playBall(1)">1</button>
      <button onclick="playBall(2)">2</button>
      <button onclick="playBall(3)">3</button>
      <button onclick="playBall(4)">4</button>
      <button onclick="playBall(5)">5</button>
      <button onclick="playBall(6)">6</button>
    </div>
    <button id="continueDayBtn" style="display:none" onclick="continueNextDay()">‚ñ∂Ô∏è Continue Next Day</button>
    <button id="declareBtn" style="display:none;background:linear-gradient(135deg,#e53e3e,#c53030);color:white;border:none;padding:10px 28px;border-radius:50px;font-weight:700;font-size:14px;cursor:pointer;margin:6px 4px;box-shadow:0 4px 12px rgba(229,62,62,.4)" onclick="declareBattingInnings()">üè≥Ô∏è Declare</button>
    <div id="ballLog"></div>
    <div id="bowlerStats"></div>
    <div id="log"></div>
    <div id="resultBox"></div>
  </div>
</div>

<script>
'use strict';

// ====== DATA VERSION & MIGRATION ======
const APP_VERSION = '3.3.0';
const DATA_VERSION_KEY = 'hc_data_version';

const DataMigration = {
  run() {
    const stored = localStorage.getItem(DATA_VERSION_KEY) || '0.0.0';
    if (stored === APP_VERSION) return;
    console.log(`üîÑ Migrating data from v${stored} to v${APP_VERSION}`);
    try {
      this._applyMigrations(stored);
      localStorage.setItem(DATA_VERSION_KEY, APP_VERSION);
      console.log('‚úÖ Data migration complete');
    } catch(e) {
      console.error('Migration error (data preserved, marking current):', e);
      localStorage.setItem(DATA_VERSION_KEY, APP_VERSION);
    }
  },

  _applyMigrations(fromVersion) {
    const csKey = 'hc_careerStats';
    let cs = {};
    try { cs = JSON.parse(localStorage.getItem(csKey)) || {}; } catch(e) { cs = {}; }
    const defaults = {
      totalMatches:0, won:0, lost:0, drawn:0,
      totalRuns:0, totalWickets:0, highestScore:0,
      hattricks:0, centuries:0, fifties:0
    };
    let changed = false;
    Object.keys(defaults).forEach(k => {
      if (cs[k] === undefined) { cs[k] = defaults[k]; changed = true; }
    });
    if (changed) localStorage.setItem(csKey, JSON.stringify(cs));

    const mhKey = 'hc_matchHistory';
    let mh = [];
    try { mh = JSON.parse(localStorage.getItem(mhKey)) || []; } catch(e) { mh = []; }
    let mhChanged = false;
    mh.forEach(m => {
      if (m.userWkTaken === undefined) {
        m.userWkTaken = 0;
        mhChanged = true;
      }
    });
    if (mhChanged) localStorage.setItem(mhKey, JSON.stringify(mh));
    console.log(`‚úÖ Migration applied.`);
  }
};

// ====== FIREBASE CONFIG ======

const firebaseConfig = {

  apiKey: "AIzaSyD846b0cpScA0dms4ZlgxoZr8NnDudK7WE",

  authDomain: "hc-ai-9e557.firebaseapp.com",

  projectId: "hc-ai-9e557",

  storageBucket: "hc-ai-9e557.firebasestorage.app",

  messagingSenderId: "1048313925900",

  appId: "1:1048313925900:web:3bf3a38c3b12963e4ef929",

  measurementId: "G-187PW5TZB9"

};

let app, auth, db, currentUser = null, firebaseInitialized = false;

// ====== SECURITY UTILITIES ======
const Security = {
  escapeHtml(str) {
    if (typeof str !== 'string') return '';
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  },
  sanitizeInput(s) {
    if (typeof s !== 'string') return '';
    return s.trim()
      .replace(/<[^>]*>/g, '')
      .replace(/[<>"'`]/g, '')
      .substring(0, 200);
  },
  validateNumber(val, min, max, def) {
    const n = parseInt(val, 10);
    if (isNaN(n) || n < min || n > max) return def;
    return n;
  },
  _saveQueue: {},
  debouncedSave(key, fn, delay = 300) {
    clearTimeout(this._saveQueue[key]);
    this._saveQueue[key] = setTimeout(fn, delay);
  }
};

// ====== BACKGROUND MUSIC ======
const Music = {
  ctx: null,
  gainNode: null,
  isPlaying: false,
  oscillators: [],

  _initCtx() {
    if (this.ctx) return;
    try {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      this.gainNode = this.ctx.createGain();
      this.gainNode.gain.setValueAtTime(0.06, this.ctx.currentTime);
      this.gainNode.connect(this.ctx.destination);
    } catch(e) { console.log('Web Audio API not available'); }
  },

  _createAmbientTone(freq, type, gain) {
    if (!this.ctx) return null;
    const osc = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
    g.gain.setValueAtTime(gain, this.ctx.currentTime);
    osc.connect(g);
    g.connect(this.gainNode);
    return { osc, g };
  },

  _createPercussion() {
    if (!this.ctx) return;
    const scheduleHit = (time, freq, dur) => {
      const osc = this.ctx.createOscillator();
      const env = this.ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, time);
      osc.frequency.exponentialRampToValueAtTime(freq * 0.1, time + dur);
      env.gain.setValueAtTime(0.3, time);
      env.gain.exponentialRampToValueAtTime(0.001, time + dur);
      osc.connect(env);
      env.connect(this.gainNode);
      osc.start(time);
      osc.stop(time + dur);
    };

    const bpm = 90;
    const beat = 60 / bpm;
    const startTime = this.ctx.currentTime + 0.1;
    const bars = 4;
    const beats = bars * 4;

    this._scheduleNext = () => {
      if (!this.isPlaying) return;
      const now = this.ctx.currentTime;
      const loopStart = startTime + Math.floor((now - startTime) / (beats * beat)) * (beats * beat);
      const nextLoop = loopStart + beats * beat;
      for (let b = 0; b < beats; b++) {
        const t = nextLoop + b * beat;
        if (b % 4 === 0 || b % 4 === 2) scheduleHit(t, 80, 0.3);
        if (b % 4 === 1 || b % 4 === 3) scheduleHit(t, 200, 0.15);
        scheduleHit(t, 800, 0.05);
        scheduleHit(t + beat * 0.5, 800, 0.05);
      }
      this._loopTimer = setTimeout(this._scheduleNext, (beats * beat - 0.1) * 1000);
    };
    this._scheduleNext();
  },

  start() {
    if (this.isPlaying) return;
    this._initCtx();
    if (!this.ctx) { showToast('üîá Audio not supported in this browser', '#718096'); return; }
    if (this.ctx.state === 'suspended') this.ctx.resume();

    const tones = [
      { freq: 130.81, type: 'sine', gain: 0.4 },
      { freq: 261.63, type: 'triangle', gain: 0.25 },
      { freq: 392.00, type: 'sine', gain: 0.2 },
      { freq: 523.25, type: 'triangle', gain: 0.15 },
    ];

    this.oscillators = tones.map(t => this._createAmbientTone(t.freq, t.type, t.gain)).filter(Boolean);
    this.oscillators.forEach(({ osc }) => {
      osc.start();
      const lfo = this.ctx.createOscillator();
      const lfoGain = this.ctx.createGain();
      lfo.frequency.value = 0.15;
      lfoGain.gain.value = 3;
      lfo.connect(lfoGain);
      lfoGain.connect(osc.frequency);
      lfo.start();
      osc._lfo = lfo;
    });

    this._createPercussion();
    this.isPlaying = true;
    this._updateBtn();
  },

  stop() {
    if (!this.isPlaying) return;
    this.isPlaying = false;
    clearTimeout(this._loopTimer);
    this.oscillators.forEach(({ osc, g }) => {
      try {
        if (osc._lfo) osc._lfo.stop();
        g.gain.setValueAtTime(g.gain.value, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.3);
        osc.stop(this.ctx.currentTime + 0.35);
      } catch(e) {}
    });
    this.oscillators = [];
    this._updateBtn();
  },

  _updateBtn() {
    const btn = document.getElementById('musicToggleBtn');
    if (!btn) return;
    if (this.isPlaying) {
      btn.innerHTML = 'üéµ Music<span class="music-bars" id="musicBars"><span></span><span></span><span></span><span></span><span></span></span>';
      btn.style.background = 'linear-gradient(135deg,#48bb78,#38a169)';
    } else {
      btn.innerHTML = 'üéµ Music<span class="music-bars paused" id="musicBars"><span></span><span></span><span></span><span></span><span></span></span>';
      btn.style.background = 'linear-gradient(135deg,#718096,#4a5568)';
    }
  },

  playSFX(type) {
    if (!this.ctx || this.ctx.state !== 'running') return;
    const now = this.ctx.currentTime;
    const sfx = {
      wicket: [[400, 0, 0.4], [200, 0.05, 0.3], [100, 0.1, 0.4]],
      four:   [[600, 0, 0.15], [800, 0.05, 0.1], [1000, 0.1, 0.1]],
      six:    [[800, 0, 0.1], [1000, 0.04, 0.1], [1200, 0.08, 0.1], [1500, 0.12, 0.12]],
      win:    [[523, 0, 0.3], [659, 0.15, 0.3], [784, 0.3, 0.4], [1047, 0.5, 0.5]],
    };
    const seq = sfx[type];
    if (!seq) return;
    seq.forEach(([freq, delay, dur]) => {
      const o = this.ctx.createOscillator();
      const g = this.ctx.createGain();
      o.frequency.value = freq;
      o.type = 'sine';
      g.gain.setValueAtTime(0.3, now + delay);
      g.gain.exponentialRampToValueAtTime(0.001, now + delay + dur);
      o.connect(g); g.connect(this.gainNode || this.ctx.destination);
      o.start(now + delay);
      o.stop(now + delay + dur + 0.01);
    });
  }
};

function toggleMusic() {
  if (Music.isPlaying) Music.stop();
  else Music.start();
}

// ====== PERSISTENT DATA MANAGER ======
const DataManager = {
  KEYS: {
    matchHistory: 'hc_matchHistory',
    careerStats:  'hc_careerStats',
    tournaments:  'hc_tournaments',
    winHistory:   'handCricketHistory'
  },

  saveMatch(data) {
    const h = this.getMatchHistory();
    h.push({ id: Date.now(), date: new Date().toLocaleString(), ...data });
    if (h.length > 500) h.splice(0, h.length - 500);
    localStorage.setItem(this.KEYS.matchHistory, JSON.stringify(h));
    this._updateCareerStats(data);
  },

  getMatchHistory() {
    try { return JSON.parse(localStorage.getItem(this.KEYS.matchHistory)) || []; } catch(e) { return []; }
  },

  _updateCareerStats(d) {
    const s = this.getCareerStats();
    s.totalMatches++;
    if (d.result === 'won') s.won++;
    else if (d.result === 'lost') s.lost++;
    else s.drawn++;
    s.totalRuns += (d.userRuns || 0);
    s.totalWickets += (d.userWkTaken !== undefined ? d.userWkTaken : 0);
    if ((d.userRuns || 0) > s.highestScore) s.highestScore = d.userRuns;
    s.hattricks  = (s.hattricks  || 0) + (d.hattricksInMatch  || 0);
    s.centuries  = (s.centuries  || 0) + (d.centuriesInMatch   || 0);
    s.fifties    = (s.fifties    || 0) + (d.fiftiesInMatch     || 0);
    localStorage.setItem(this.KEYS.careerStats, JSON.stringify(s));
  },

  getCareerStats() {
    try {
      const cs = JSON.parse(localStorage.getItem(this.KEYS.careerStats)) || {};
      const defaults = { totalMatches:0, won:0, lost:0, drawn:0, totalRuns:0, totalWickets:0, highestScore:0, hattricks:0, centuries:0, fifties:0 };
      return { ...defaults, ...cs };
    } catch(e) {
      return { totalMatches:0, won:0, lost:0, drawn:0, totalRuns:0, totalWickets:0, highestScore:0, hattricks:0, centuries:0, fifties:0 };
    }
  },

  getTournaments() {
    try { return JSON.parse(localStorage.getItem(this.KEYS.tournaments)) || []; } catch(e) { return []; }
  },

  saveTournamentSlot(tournamentState) {
    const slots = this.getTournaments();
    const format = tournamentState.format;
    const teamKey = tournamentState.userTeam;
    let teamName = teamKey;
    try {
      if (format === 'ipl') { if (typeof IPL_TEAMS !== 'undefined' && IPL_TEAMS[teamKey]) teamName = IPL_TEAMS[teamKey].name; }
      else { if (typeof CRICKET_TEAMS !== 'undefined' && CRICKET_TEAMS[teamKey]) teamName = CRICKET_TEAMS[teamKey].name; }
    } catch(e) {}
    const slotId = tournamentState._slotId || Date.now();
    const startDate = tournamentState._startDate || new Date().toLocaleString();
    let idx = slots.findIndex(s => s.id === slotId);
    const ts = JSON.parse(JSON.stringify(tournamentState));
    ts._slotId = slotId;
    ts._startDate = startDate;
    const slot = {
      id: slotId, format, teamKey, teamName,
      stage: tournamentState.currentStage,
      startDate, lastSaved: new Date().toLocaleString(),
      dataVersion: APP_VERSION,
      tournamentState: ts
    };
    if (idx >= 0) slots[idx] = slot; else slots.push(slot);
    localStorage.setItem(this.KEYS.tournaments, JSON.stringify(slots));
    localStorage.setItem('handCricket_tournament', JSON.stringify({ tournamentState: ts }));
    return slotId;
  },

  loadTournamentSlot(id) {
    const slots = this.getTournaments();
    return slots.find(s => s.id === id) || null;
  },

  deleteTournamentSlot(id) {
    let slots = this.getTournaments().filter(s => s.id !== id);
    localStorage.setItem(this.KEYS.tournaments, JSON.stringify(slots));
  },

  getPendingTournaments() { return this.getTournaments(); },

  getWinHistory() {
    try { return JSON.parse(localStorage.getItem(this.KEYS.winHistory)) || []; } catch(e) { return []; }
  },

  addWin(format, teamKey, teamName) {
    const h = this.getWinHistory();
    h.push({ format, teamKey, teamName, date: new Date().toISOString() });
    localStorage.setItem(this.KEYS.winHistory, JSON.stringify(h));
  },

  clearAll() {
    if (!confirm('Clear ALL history and saved tournaments? This cannot be undone!')) return;
    Object.values(this.KEYS).forEach(k => localStorage.removeItem(k));
    localStorage.removeItem('handCricket_tournament');
    localStorage.removeItem(DATA_VERSION_KEY);
    alert('All data cleared!');
    location.reload();
  }
};

// ====== AUTO-SAVE ======
function saveTournamentNow() {
  if (!TournamentState.format) return;
  Security.debouncedSave('tournament', () => {
    const id = DataManager.saveTournamentSlot(TournamentState);
    TournamentState._slotId = id;
    console.log('üíæ Tournament auto-saved, slot:', id);
  }, 500);
}

setInterval(() => { if (TournamentState.format) saveTournamentNow(); }, 60000);

function _onPageLeave() {
  if (isMatchLive && isMatchLive() && GameState.isTournament && GameState.currentMatch) {
    autoPauseIfLive();
  }
  if (TournamentState.format) DataManager.saveTournamentSlot(TournamentState);
}

window.addEventListener('beforeunload', _onPageLeave);
window.addEventListener('pagehide', _onPageLeave);
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    _onPageLeave();
  }
});

// ====== RESUME MODAL ======
function openResumeModal() {
  const slots = DataManager.getPendingTournaments();
  const listEl = document.getElementById('resumeList');
  if (slots.length === 0) {
    listEl.innerHTML = '<p style="color:#718096;text-align:center;padding:30px">No saved tournaments found.</p>';
  } else {
    const fmtNames = { odiWorldCup:'üèÜ ODI World Cup', t20WorldCup:'üèÜ T20 World Cup', wtc:'üèÜ WTC', ipl:'üèÜ IPL' };
    const stageNames = { challengeLeague:'Challenge League', super6:'Super 6', qualifier:'Qualifier', worldCup:'World Cup Final Stage', wtc:'WTC League', ipl:'IPL' };
    listEl.innerHTML = slots.map(s => `
      <button class="tournament-card" onclick="resumeTournamentSlot(${s.id})">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:1.2em;font-weight:700;color:#667eea">${Security.escapeHtml(fmtNames[s.format]||s.format)}</div>
            <div style="color:#2d3748;margin:6px 0">üèè Team: <strong>${Security.escapeHtml(s.teamName)}</strong></div>
            <div style="color:#718096;font-size:13px">Stage: ${Security.escapeHtml(stageNames[s.stage]||s.stage)}</div>
            <div style="color:#a0aec0;font-size:12px;margin-top:4px">Started: ${Security.escapeHtml(s.startDate)} &nbsp;|&nbsp; Saved: ${Security.escapeHtml(s.lastSaved)}</div>
          </div>
          <div style="text-align:right">
            <span style="background:#667eea;color:white;padding:6px 14px;border-radius:20px;font-size:13px">‚ñ∂Ô∏è Resume</span>
            <br><span onclick="event.stopPropagation();deleteTournamentSlot(${Number(s.id)})" style="color:#ef4444;font-size:12px;cursor:pointer;margin-top:6px;display:inline-block">üóë Delete</span>
          </div>
        </div>
      </button>`).join('');
  }
  document.getElementById('resumeModal').classList.add('open');
}
function closeResumeModal() { document.getElementById('resumeModal').classList.remove('open'); }
function deleteTournamentSlot(id) {
  if (!confirm('Delete this saved tournament?')) return;
  DataManager.deleteTournamentSlot(id);
  openResumeModal();
}
function resumeTournamentSlot(id) {
  const slot = DataManager.loadTournamentSlot(id);
  if (!slot) { alert('Saved data not found!'); return; }
  Object.assign(TournamentState, slot.tournamentState);
  if (!TournamentState.userStats.playerInnings) TournamentState.userStats.playerInnings = {};
  closeResumeModal();
  showSection('tournament');
  const titles = { odiWorldCup:'üèÜ ODI World Cup', t20WorldCup:'üèÜ T20 World Cup', wtc:'üèÜ World Test Championship', ipl:'üèÜ Indian Premier League' };
  Utils.setText('tournamentTitle', titles[TournamentState.format] || 'üèÜ Tournament');
  const navEl = document.getElementById('tournamentNav');
  const statBtn = document.getElementById('statsCornerBtn');
  if (TournamentState.format === 'wtc' || TournamentState.format === 'ipl') {
    navEl.style.display = 'none'; statBtn.style.display = 'block';
  } else { navEl.style.display = 'flex'; statBtn.style.display = 'none'; }
  if (TournamentState.currentStage === 'wtc') showWTCStage();
  else if (TournamentState.currentStage === 'ipl') showIPLStage();
  else showTournamentStage(TournamentState.currentStage);
  showToast('‚úÖ Tournament resumed!', '#48bb78');
}

// ====== SECTION MANAGER ======
function showSection(name) {
  ['welcome','setup','tournament','game'].forEach(s => {
    document.getElementById(s+'-section').style.display = 'none';
  });
  document.getElementById(name+'-section').style.display = 'block';
  const homeBtn = document.getElementById('globalHomeBtn');
  homeBtn.style.display = (name === 'welcome') ? 'none' : 'block';
  const titleEl = document.getElementById('main-title');
  titleEl.style.display = (name === 'welcome') ? 'none' : 'block';
}

function isMatchLive() {
  const gs = document.getElementById('game-section');
  if (!gs || gs.style.display === 'none') return false;
  const ballsBowled = GameState.ballsBowled.reduce((a,b) => a+b, 0);
  const rb = document.getElementById('resultBox');
  const resultVisible = rb && rb.style.display !== 'none' && rb.style.display !== '';
  return ballsBowled > 0 && !resultVisible;
}

function autoPauseIfLive() {
  if (!GameState.isTournament || !GameState.currentMatch) return false;
  if (!isMatchLive()) return false;
  try {
    const gsSnapshot = JSON.parse(JSON.stringify(GameState));
    gsSnapshot.currentMatch = null;
    const pausedState = {
      gameState: gsSnapshot,
      logContent: document.getElementById('log')?.innerHTML || '',
      ballLogContent: document.getElementById('ballLog')?.textContent || '',
      bowlerStatsContent: document.getElementById('bowlerStats')?.textContent || ''
    };
    GameState.currentMatch.pausedState = pausedState;
    _stampPausedState(pausedState, GameState.currentMatch,
                      TournamentState.currentStage, TournamentState.currentPhase);
    DataManager.saveTournamentSlot(TournamentState);
    return true;
  } catch(e) {
    console.error('autoPauseIfLive error:', e);
    if (TournamentState.format) DataManager.saveTournamentSlot(TournamentState);
    return false;
  }
}

function _stampPausedState(pausedState, match, stage, phase) {
  function mark(list) {
    if (!list) return;
    const idx = list.findIndex(m => m.team1===match.team1 && m.team2===match.team2 && !m.completed);
    if (idx >= 0) list[idx].pausedState = pausedState;
  }
  if (stage === 'challengeLeague') mark(phase==='groupA' ? TournamentState.challengeLeague.matchesA : TournamentState.challengeLeague.matchesB);
  else if (stage === 'super6') mark(TournamentState.super6.matches);
  else if (stage === 'qualifier') mark(phase==='groupA' ? TournamentState.qualifier.matchesA : TournamentState.qualifier.matchesB);
  else if (stage === 'worldCup') {
    if (phase==='main') mark(TournamentState.worldCup.matches);
    else if (phase==='semis') mark(TournamentState.worldCup.semiFinals);
    else if (phase==='final' && TournamentState.worldCup.final) TournamentState.worldCup.final.pausedState = pausedState;
  } else if (stage === 'wtc') {
    if (phase==='final' && TournamentState.wtc.final) {
      TournamentState.wtc.final.pausedState = pausedState;
    } else {
      Object.values(TournamentState.wtc.seriesProgress).forEach(s => {
        const i = s.matches.findIndex(m => m.team1===match.team1 && m.team2===match.team2 && !m.completed);
        if (i >= 0) s.matches[i].pausedState = pausedState;
      });
      const ai = TournamentState.wtc.allMatches.findIndex(m => m.team1===match.team1 && m.team2===match.team2 && !m.completed);
      if (ai >= 0) TournamentState.wtc.allMatches[ai].pausedState = pausedState;
    }
  } else if (stage === 'ipl') {
    if (phase === 'roundRobin') mark(TournamentState.ipl.roundRobinMatches);
    else {
      if (TournamentState.ipl.eliminator1&&!TournamentState.ipl.eliminator1.completed&&TournamentState.ipl.eliminator1.team1===match.team1) TournamentState.ipl.eliminator1.pausedState = pausedState;
      else if (TournamentState.ipl.eliminator2&&!TournamentState.ipl.eliminator2.completed&&TournamentState.ipl.eliminator2.team1===match.team1) TournamentState.ipl.eliminator2.pausedState = pausedState;
      else if (TournamentState.ipl.eliminator3&&!TournamentState.ipl.eliminator3.completed&&TournamentState.ipl.eliminator3.team1===match.team1) TournamentState.ipl.eliminator3.pausedState = pausedState;
      else if (TournamentState.ipl.final&&!TournamentState.ipl.final.completed) TournamentState.ipl.final.pausedState = pausedState;
    }
  }
}

function returnToHome() {
  const gameVisible = document.getElementById('game-section')?.style.display !== 'none';

  if (gameVisible && isMatchLive()) {
    if (GameState.isTournament && GameState.currentMatch) {
      autoPauseIfLive();
      if (TournamentState.format) DataManager.saveTournamentSlot(TournamentState);
      if (currentUser && firebaseInitialized) saveProgressToCloud(true);
      showSection('welcome');
      TournamentHistory.displayHistory();
      checkResumeBtnVisibility();
      showToast('‚è∏Ô∏è Match paused & saved! Tap "Resume Tournament" to continue.', '#f59e0b');
      return;
    } else {
      if (!confirm('A match is in progress. Leave and abandon it?')) return;
    }
  }

  if (TournamentState.format) saveTournamentNow();
  if (currentUser && firebaseInitialized) saveProgressToCloud(true);
  showSection('welcome');
  TournamentHistory.displayHistory();
  checkResumeBtnVisibility();
}
window.returnToHome = returnToHome;

function checkResumeBtnVisibility() {
  const btn = document.getElementById('resumeTournamentBtn');
  btn.style.display = DataManager.getPendingTournaments().length > 0 ? 'inline-block' : 'none';
}

function showToast(msg, bg) {
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.cssText = `position:fixed;top:70px;right:20px;background:${bg||'#667eea'};color:white;padding:14px 24px;border-radius:8px;z-index:9998;box-shadow:0 4px 12px rgba(0,0,0,0.2);font-weight:600;max-width:300px`;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// ====== LEADERBOARD (Firebase-backed) ======
const Leaderboard = {
  categoryLabel: {
    totalRuns:     'üèè Most Runs',
    totalWickets:  '‚ö° Most Wickets Taken',
    hattricks:     'üé© Most Hat-Tricks',
    centuries:     'üíØ Most Centuries',
    fifties:       '5Ô∏è‚É£0Ô∏è‚É£ Most Half-Centuries',
    wins:          'üèÜ Most Wins',
    winRate:       'üìà Best Win Rate (min. 20 matches)'
  },

  async pushUserStats() {
    if (!firebaseInitialized || !db || !currentUser) return;
    try {
      const cs = DataManager.getCareerStats();
      const wh = DataManager.getWinHistory();
      const winRate = cs.totalMatches >= 20
        ? parseFloat(((cs.won / cs.totalMatches) * 100).toFixed(2))
        : 0;
      await db.collection('leaderboard').doc(currentUser.uid).set({
        displayName:  currentUser.displayName || 'Anonymous',
        photoURL:     currentUser.photoURL || '',
        totalRuns:    cs.totalRuns    || 0,
        totalWickets: cs.totalWickets || 0,
        hattricks:    cs.hattricks   || 0,
        centuries:    cs.centuries   || 0,
        fifties:      cs.fifties     || 0,
        wins:         cs.won         || 0,
        totalMatches: cs.totalMatches|| 0,
        winRate:      winRate,
        qualifiesForWinRate: cs.totalMatches >= 20,
        tournaments:  wh.length      || 0,
        lastUpdated:  firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    } catch(e) { console.error('Leaderboard push error:', e); }
  },

  async fetch(category) {
    if (!firebaseInitialized || !db) return this._localFallback(category);
    try {
      let q = db.collection('leaderboard');
      if (category === 'winRate') {
        q = q.where('qualifiesForWinRate', '==', true)
             .orderBy('winRate', 'desc')
             .limit(20);
      } else {
        q = q.orderBy(category, 'desc').limit(20);
      }
      const snap = await q.get();
      if (snap.empty) return this._localFallback(category);
      return snap.docs.map(d => ({ uid: d.id, ...d.data() }));
    } catch(e) {
      console.error('Leaderboard fetch error:', e);
      return this._localFallback(category);
    }
  },

  _localFallback(category) {
    const cs = DataManager.getCareerStats();
    const name = currentUser ? (currentUser.displayName || 'You') : 'You';
    const photo = currentUser ? (currentUser.photoURL || '') : '';
    const wr = cs.totalMatches >= 20 ? parseFloat(((cs.won/cs.totalMatches)*100).toFixed(2)) : null;
    return [{
      uid: currentUser ? currentUser.uid : 'local',
      displayName: name + ' (local)',
      photoURL: photo,
      totalRuns: cs.totalRuns || 0,
      totalWickets: cs.totalWickets || 0,
      hattricks: cs.hattricks || 0,
      centuries: cs.centuries || 0,
      fifties: cs.fifties || 0,
      wins: cs.won || 0,
      totalMatches: cs.totalMatches || 0,
      winRate: wr,
      _isLocal: true
    }];
  }
};

// ====== HISTORY MODAL ======
function openHistoryModal() {
  document.getElementById('historyModal').classList.add('open');
  showHistoryTab('all');
}
function closeHistoryModal() { document.getElementById('historyModal').classList.remove('open'); }

function showHistoryTab(tab) {
  ['all','tournaments','stats','leaderboard'].forEach(t => {
    const el = document.getElementById('htab-'+t);
    if (el) el.classList.toggle('active', t === tab);
  });
  const c = document.getElementById('historyTabContent');
  if (tab === 'all') renderAllMatches(c);
  else if (tab === 'tournaments') renderTournamentWins(c);
  else if (tab === 'stats') renderCareerStats(c);
  else if (tab === 'leaderboard') renderLeaderboard(c);
}

function renderAllMatches(c) {
  const h = [...DataManager.getMatchHistory()].reverse();
  if (!h.length) { c.innerHTML = '<p style="text-align:center;color:#718096;padding:40px">No matches yet! üèè</p>'; return; }
  c.innerHTML = '<h3 style="margin-bottom:15px">All Matches (' + h.length + ')</h3>' + h.map(m => `
    <div class="mhi ${m.result||'draw'}">
      <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:8px">
        <div>
          <strong>${m.result==='won'?'üèÜ':m.result==='lost'?'üòû':'ü§ù'} ${Security.escapeHtml((m.teamNames&&m.teamNames[0])||'You')} vs ${Security.escapeHtml((m.teamNames&&m.teamNames[1])||'CPU')}</strong><br>
          <span style="color:#718096;font-size:13px">${Security.escapeHtml(m.date||'')}</span>
        </div>
        <span style="background:${m.result==='won'?'#48bb78':m.result==='lost'?'#ef4444':'#f59e0b'};color:white;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;align-self:flex-start;text-transform:uppercase">${m.result||'?'}</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div style="background:white;padding:12px;border-radius:8px"><div style="font-size:12px;color:#718096">Your Score</div><div style="font-size:22px;font-weight:700">${m.userRuns||0}/${m.userWickets||0}</div></div>
        <div style="background:white;padding:12px;border-radius:8px"><div style="font-size:12px;color:#718096">Opponent Score</div><div style="font-size:22px;font-weight:700">${m.oppRuns||0}/${m.oppWickets||0}</div></div>
      </div>
      ${m.format?`<div style="margin-top:8px;font-size:13px;color:#667eea;font-weight:600">üìã ${Security.escapeHtml(m.format)}${m.tournament?' | üèÜ '+Security.escapeHtml(m.tournament):''}</div>`:''}
    </div>`).join('');
}

function renderTournamentWins(c) {
  const h = [...DataManager.getWinHistory()].reverse();
  if (!h.length) { c.innerHTML = '<p style="text-align:center;color:#718096;padding:40px">No tournament wins yet! üèÜ</p>'; return; }
  const fn = { odiWorldCup:'üèÜ ODI World Cup', t20WorldCup:'üèÜ T20 World Cup', wtc:'üèÜ WTC', ipl:'üèÜ IPL' };
  c.innerHTML = '<h3 style="margin-bottom:15px">Tournament Victories (' + h.length + ')</h3>' + h.map(w => `
    <div class="mhi won">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${fn[w.format]||Security.escapeHtml(w.format)}</strong><br><span style="color:#48bb78;font-weight:700">${Security.escapeHtml(w.teamName)}</span></div>
        <div style="text-align:right"><span style="color:#718096;font-size:13px">${new Date(w.date).toLocaleDateString()}</span><br><span style="background:#48bb78;color:white;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700">CHAMPION</span></div>
      </div>
    </div>`).join('');
}

function renderCareerStats(c) {
  const s = DataManager.getCareerStats();
  if (!s.totalMatches) { c.innerHTML = '<p style="text-align:center;color:#718096;padding:40px">Play some matches first! üìä</p>'; return; }
  const wr = s.totalMatches ? ((s.won/s.totalMatches)*100).toFixed(1) : 0;
  c.innerHTML = `
    <h3 style="margin-bottom:20px">üìä Career Statistics</h3>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:25px">
      ${[
        ['Total Matches', s.totalMatches, '#667eea'],
        ['Won', s.won+' ('+wr+'%)', '#48bb78'],
        ['Lost', s.lost, '#ef4444'],
        ['Drawn', s.drawn, '#f59e0b']
      ].map(([l,v,col]) => `
      <div style="background:${col};color:white;padding:18px;border-radius:12px;text-align:center">
        <div style="font-size:13px;opacity:0.9">${l}</div>
        <div style="font-size:28px;font-weight:700;margin-top:6px">${v}</div>
      </div>`).join('')}
    </div>
    <div style="background:#f7fafc;padding:18px;border-radius:12px;border-left:4px solid #667eea;margin-bottom:15px">
      <h4 style="color:#2d3748;margin-bottom:12px">üèè Batting</h4>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:15px">
        ${[
          ['Total Runs', s.totalRuns],
          ['Highest Score', s.highestScore],
          ['Centuries üíØ', s.centuries || 0],
          ['Half-Centuries 5Ô∏è‚É£0Ô∏è‚É£', s.fifties || 0],
          ['Avg Runs/Match', s.totalMatches?(s.totalRuns/s.totalMatches).toFixed(1):0]
        ].map(([l,v]) => `<div><div style="color:#718096;font-size:13px">${l}</div><div style="font-size:24px;font-weight:700;color:#2d3748">${v}</div></div>`).join('')}
      </div>
    </div>
    <div style="background:#f7fafc;padding:18px;border-radius:12px;border-left:4px solid #f59e0b">
      <h4 style="color:#2d3748;margin-bottom:12px">‚ö° Bowling</h4>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:15px">
        ${[
          ['Wickets Taken', s.totalWickets],
          ['Hat-Tricks üé©', s.hattricks || 0]
        ].map(([l,v]) => `<div><div style="color:#718096;font-size:13px">${l}</div><div style="font-size:24px;font-weight:700;color:#2d3748">${v}</div></div>`).join('')}
      </div>
    </div>`;
}

async function renderLeaderboard(c) {
  if (!currentUser && !firebaseInitialized) {
    c.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <p style="color:#718096;margin-bottom:10px">Sign in with Google to submit your stats to the global leaderboard!</p>
      </div>
      <h4 style="margin-bottom:12px;color:#2d3748">üìä Your Local Stats</h4>`;
    const cs = DataManager.getCareerStats();
    const cats = Object.keys(Leaderboard.categoryLabel);
    const labels = { totalRuns:'Runs', totalWickets:'Wickets', hattricks:'Hat-Tricks', centuries:'Centuries', fifties:'Half-Centuries', wins:'Wins', winRate:'Win Rate' };
    const vals = { totalRuns:cs.totalRuns||0, totalWickets:cs.totalWickets||0, hattricks:cs.hattricks||0, centuries:cs.centuries||0, fifties:cs.fifties||0, wins:cs.won||0, winRate:cs.totalMatches>=20?((cs.won/cs.totalMatches)*100).toFixed(1)+'%':'Need 20+ matches' };
    c.innerHTML += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px">` +
      cats.map(k=>`<div style="background:#f7fafc;border-radius:10px;padding:14px;text-align:center;border:2px solid #e2e8f0">
        <div style="font-size:1.5em;font-weight:800;color:#667eea">${vals[k]}</div>
        <div style="font-size:12px;color:#718096;margin-top:4px">${labels[k]}</div>
      </div>`).join('') + '</div>';
    return;
  }
  if (!currentUser) {
    c.innerHTML = '<div style="text-align:center;padding:40px"><p style="color:#718096;margin-bottom:15px">Sign in to view the global leaderboard!</p><button onclick="signInWithGoogle()" style="width:auto;padding:12px 30px">Sign in with Google</button></div>';
    return;
  }

  const cats = Object.keys(Leaderboard.categoryLabel);
  const tabs = cats.map((cat, i) =>
    `<button class="htab-btn${i===0?' active':''}" id="lbtab-${cat}" onclick="switchLbTab('${cat}')" style="font-size:12px;padding:7px 12px;margin:3px">${Leaderboard.categoryLabel[cat]}</button>`
  ).join('');

  c.innerHTML = `
    <h3 style="margin-bottom:8px">ü•á Global Leaderboard</h3>
    <p style="color:#718096;font-size:13px;margin-bottom:10px">Rankings update when you submit stats.</p>
    <button onclick="submitMyStats()" style="width:auto;padding:10px 20px;background:#48bb78;margin-bottom:16px">üì§ Submit My Stats to Leaderboard</button>
    <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:16px">${tabs}</div>
    <div id="lbContent"><div style="text-align:center;padding:40px;color:#718096">Loading...</div></div>`;

  loadLbCategory(cats[0]);
}

async function loadLbCategory(cat) {
  const lbContent = document.getElementById('lbContent');
  if (!lbContent) return;
  lbContent.innerHTML = '<div style="text-align:center;padding:30px;color:#718096">‚è≥ Loading rankings...</div>';
  const rows = await Leaderboard.fetch(cat);
  const isLocal = rows.length === 1 && rows[0]._isLocal;
  const medals = ['ü•á','ü•à','ü•â'];

  const formatVal = (r, k) => {
    if (k === 'winRate') {
      if (r.winRate === null || r.winRate === undefined) return 'N/A (< 20 matches)';
      if (!r.qualifiesForWinRate && !r._isLocal) return 'N/A';
      return (r.winRate || 0).toFixed(1) + '%';
    }
    return (r[k] || 0).toLocaleString();
  };

  let html = '';
  if (isLocal) {
    html += `<div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:12px;margin-bottom:16px;font-size:13px;color:#92400e">
      ‚ÑπÔ∏è Showing your local stats. Submit your stats and more players sign in to see a full leaderboard.
    </div>`;
  }
  if (!rows.length) {
    lbContent.innerHTML = '<p style="text-align:center;color:#718096;padding:30px">No data yet. Be the first! Submit your stats above.</p>';
    return;
  }
  html += rows.map((r, i) => {
    const isYou = currentUser && r.uid === currentUser.uid;
    return `<div class="lb-card ${i===0?'lb-rank-1':i===1?'lb-rank-2':i===2?'lb-rank-3':''}" style="display:flex;align-items:center;gap:12px;${isYou?'box-shadow:0 0 0 3px #667eea;':''}">
      <div style="font-size:1.6em;min-width:36px;text-align:center">${medals[i] || '#'+(i+1)}</div>
      ${r.photoURL
        ? `<img src="${Security.escapeHtml(r.photoURL)}" style="width:38px;height:38px;border-radius:50%;border:2px solid #667eea;flex-shrink:0" onerror="this.style.display='none'">`
        : `<div style="width:38px;height:38px;border-radius:50%;background:#667eea;display:flex;align-items:center;justify-content:center;color:white;font-size:1.1em;flex-shrink:0">üë§</div>`}
      <div style="flex:1;min-width:0">
        <div style="font-weight:700;color:#2d3748;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
          ${Security.escapeHtml(r.displayName || 'Anonymous')}${isYou?' <span style="background:#667eea;color:white;font-size:11px;padding:2px 7px;border-radius:10px">YOU</span>':''}
        </div>
        <div style="color:#718096;font-size:12px">${r.totalMatches||0} matches played</div>
      </div>
      <div style="font-size:1.5em;font-weight:800;color:#667eea;white-space:nowrap">${formatVal(r, cat)}</div>
    </div>`;
  }).join('');
  lbContent.innerHTML = html;
}

function switchLbTab(cat) {
  Object.keys(Leaderboard.categoryLabel).forEach(c => {
    const el = document.getElementById('lbtab-' + c);
    if (el) el.classList.toggle('active', c === cat);
  });
  loadLbCategory(cat);
}

async function submitMyStats() {
  await Leaderboard.pushUserStats();
  showToast('‚úÖ Stats submitted to leaderboard!', '#48bb78');
}

function clearAllHistoryData() { DataManager.clearAll(); }

// ====== FIREBASE ======
function signInWithGoogle() {
  if (!firebaseInitialized) { alert('Firebase not configured. Set up your Firebase config to enable cloud features.'); return; }
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then(r => { currentUser = r.user; updateAuthUI(); loadProgressFromCloud(); })
    .catch(e => alert('Sign-in failed: ' + e.message));
}

function signOutUser() {
  if (!firebaseInitialized || !auth) return;
  if (confirm('Sign out?')) auth.signOut().then(() => { currentUser = null; updateAuthUI(); });
}

function updateAuthUI() {
  const so = document.getElementById('signedOutView'), si = document.getElementById('signedInView');
  if (!so || !si) return;
  if (currentUser) {
    so.style.display = 'none'; si.style.display = 'block';
    document.getElementById('userName').textContent = currentUser.displayName || 'User';
    document.getElementById('userEmail').textContent = currentUser.email;
    document.getElementById('userPhoto').src = currentUser.photoURL || '';
  } else { so.style.display = 'block'; si.style.display = 'none'; }
}

async function saveProgressToCloud(silent) {
  if (!firebaseInitialized || !db || !currentUser) { if (!silent) alert('Not signed in or Firebase not set up.'); return; }
  try {
    await db.collection('users').doc(currentUser.uid).set({
      tournamentSlots: DataManager.getTournaments(),
      matchHistory: DataManager.getMatchHistory().slice(-200),
      careerStats: DataManager.getCareerStats(),
      winHistory: DataManager.getWinHistory(),
      dataVersion: APP_VERSION,
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    });
    await Leaderboard.pushUserStats();
    if (!silent) showToast('‚úÖ Progress saved to cloud!', '#48bb78');
    const ls = document.getElementById('lastSyncTime');
    if (ls) ls.textContent = '‚úÖ Cloud saved: ' + new Date().toLocaleString();
  } catch(e) { if (!silent) alert('Cloud save failed: ' + e.message); }
}

async function loadProgressFromCloud() {
  if (!firebaseInitialized || !db || !currentUser) return;
  try {
    const doc = await db.collection('users').doc(currentUser.uid).get();
    if (doc.exists) {
      const d = doc.data();
      if (d.tournamentSlots) localStorage.setItem(DataManager.KEYS.tournaments, JSON.stringify(d.tournamentSlots));
      if (d.matchHistory) localStorage.setItem(DataManager.KEYS.matchHistory, JSON.stringify(d.matchHistory));
      if (d.careerStats) localStorage.setItem(DataManager.KEYS.careerStats, JSON.stringify(d.careerStats));
      if (d.winHistory) localStorage.setItem(DataManager.KEYS.winHistory, JSON.stringify(d.winHistory));
      showToast('üì• Progress loaded from cloud!', '#667eea');
      checkResumeBtnVisibility();
      TournamentHistory.displayHistory();
    }
  } catch(e) { console.error('Cloud load error:', e); }
}

// ====== TOURNAMENT HISTORY (welcome page) ======
const TournamentHistory = {
  getHistory() { return DataManager.getWinHistory(); },
  addWin(format, teamKey, teamName) { DataManager.addWin(format, teamKey, teamName); },
  clearHistory() { localStorage.removeItem(DataManager.KEYS.winHistory); this.displayHistory(); },
  displayHistory() {
    const h = this.getHistory().slice().reverse();
    const el = document.getElementById('historyContent');
    if (!el) return;
    if (!h.length) { el.innerHTML = '<p style="font-style:italic;color:#718096">No tournaments won yet. Start playing!</p>'; return; }
    const fn = { odiWorldCup:'üèÜ ODI World Cup', t20WorldCup:'üèÜ T20 World Cup', wtc:'üèÜ WTC', ipl:'üèÜ IPL' };
    el.innerHTML = '<div style="display:grid;gap:12px">' + h.map(w => `
      <div style="background:white;padding:15px;border-radius:10px;border-left:4px solid #48bb78;display:flex;justify-content:space-between;align-items:center">
        <div><strong style="color:#2d3748">${fn[w.format]||Security.escapeHtml(w.format)}</strong><p style="color:#718096;margin:5px 0 0 0">${Security.escapeHtml(w.teamName)}</p></div>
        <span style="color:#a0aec0;font-size:0.9em">${new Date(w.date).toLocaleDateString()}</span>
      </div>`).join('') + '</div>' +
      `<button onclick="if(confirm('Clear?')){TournamentHistory.clearHistory()}" style="margin-top:15px;padding:10px 20px;background:#fc8181;color:white;border:none;border-radius:5px;cursor:pointer;width:auto;text-transform:none;font-size:14px">üóë Clear History</button>`;
  }
};

// ====== CRICKET TEAMS ======
const CRICKET_TEAMS = {
  india:{name:"India",players:["Rohit Sharma","Virat Kohli","KL Rahul","Shreyas Iyer","Rishabh Pant","Hardik Pandya","Jasprit Bumrah","Bhuvneshwar Kumar","Yuzvendra Chahal","Mohammed Shami","Shardul Thakur"],tier:1},
  australia:{name:"Australia",players:["David Warner","Aaron Finch","Steve Smith","Glenn Maxwell","Pat Cummins","Mitchell Starc","Josh Hazlewood","Alex Carey","Marcus Stoinis","Nathan Lyon","Travis Head"],tier:1},
  england:{name:"England",players:["Joe Root","Ben Stokes","Jos Buttler","Jonny Bairstow","Eoin Morgan","Jofra Archer","Chris Woakes","Moeen Ali","Sam Curran","Mark Wood","Liam Livingstone"],tier:1},
  pakistan:{name:"Pakistan",players:["Babar Azam","Shaheen Afridi","Mohammad Rizwan","Fakhar Zaman","Shadab Khan","Haris Rauf","Mohammad Nawaz","Imad Wasim","Asif Ali","Hassan Ali","Wahab Riaz"],tier:1},
  southafrica:{name:"South Africa",players:["Quinton de Kock","Faf du Plessis","Temba Bavuma","Rassie van der Dussen","Kagiso Rabada","Anrich Nortje","Lungi Ngidi","David Miller","Aiden Markram","Dwaine Pretorius","Heinrich Klaasen"],tier:1},
  newzealand:{name:"New Zealand",players:["Kane Williamson","Trent Boult","Tim Southee","Devon Conway","Glenn Phillips","Mitchell Santner","Lockie Ferguson","Daryl Mitchell","Tom Latham","Matt Henry","Rachin Ravindra"],tier:1},
  westindies:{name:"West Indies",players:["Shai Hope","Nicholas Pooran","Shimron Hetmyer","Jason Holder","Alzarri Joseph","Akeal Hosein","Romario Shepherd","Kyle Mayers","Brandon King","Gudakesh Motie","Shamarh Brooks"],tier:2},
  srilanka:{name:"Sri Lanka",players:["Kusal Mendis","Pathum Nissanka","Charith Asalanka","Wanindu Hasaranga","Maheesh Theekshana","Kasun Rajitha","Dushmantha Chameera","Dasun Shanaka","Dunith Wellalage","Dilshan Madushanka","Sadeera Samarawickrama"],tier:2},
  bangladesh:{name:"Bangladesh",players:["Shakib Al Hasan","Mushfiqur Rahim","Litton Das","Mustafizur Rahman","Taskin Ahmed","Mehidy Hasan","Najmul Hossain","Towhid Hridoy","Shoriful Islam","Tanzid Hasan","Mahmudullah"],tier:2},
  afghanistan:{name:"Afghanistan",players:["Rashid Khan","Mohammad Nabi","Rahmanullah Gurbaz","Ibrahim Zadran","Mujeeb Ur Rahman","Fazalhaq Farooqi","Azmatullah Omarzai","Hashmatullah Shahidi","Najibullah Zadran","Naveen-ul-Haq","Gulbadin Naib"],tier:2},
  ireland:{name:"Ireland",players:["Paul Stirling","Andy Balbirnie","Harry Tector","Curtis Campher","George Dockrell","Mark Adair","Josh Little","Lorcan Tucker","Gareth Delany","Barry McCarthy","Craig Young"],tier:3},
  zimbabwe:{name:"Zimbabwe",players:["Sikandar Raza","Sean Williams","Blessing Muzarabani","Richard Ngarava","Ryan Burl","Regis Chakabva","Craig Ervine","Tendai Chatara","Wesley Madhevere","Luke Jongwe","Innocent Kaia"],tier:3},
  netherlands:{name:"Netherlands",players:["Scott Edwards","Bas de Leede","Paul van Meekeren","Logan van Beek","Roelof van der Merwe","Max O'Dowd","Colin Ackermann","Aryan Dutt","Vikramjit Singh","Teja Nidamanuru","Wesley Barresi"],tier:3},
  scotland:{name:"Scotland",players:["Richie Berrington","Kyle Coetzer","Calum MacLeod","Matthew Cross","Mark Watt","Brad Wheal","Chris Greaves","Michael Leask","Safyaan Sharif","Brandon McMullen","Chris Sole"],tier:3},
  uae:{name:"UAE",players:["Vriitya Aravind","Chirag Suri","Muhammad Waseem","Basil Hameed","Rohan Mustafa","Zahoor Khan","Junaid Siddique","Karthik Meiyappan","Aayan Khan","Ali Naseer","Alishan Sharafu"],tier:3},
  oman:{name:"Oman",players:["Zeeshan Maqsood","Aqib Ilyas","Jatinder Singh","Ayaan Khan","Bilal Khan","Kaleemullah","Mohammad Nadeem","Kashyap Prajapati","Shoaib Khan","Jay Odedra","Naseem Khushi"],tier:3}
};

const IPL_TEAMS = {
  csk:{name:"Chennai Super Kings",players:["MS Dhoni","Ruturaj Gaikwad","Ravindra Jadeja","Moeen Ali","Deepak Chahar","Dwayne Bravo","Ambati Rayudu","Faf du Plessis","Shardul Thakur","Mitchell Santner","Devon Conway"]},
  mi:{name:"Mumbai Indians",players:["Rohit Sharma","Ishan Kishan","Suryakumar Yadav","Kieron Pollard","Jasprit Bumrah","Trent Boult","Hardik Pandya","Krunal Pandya","Rahul Chahar","Quinton de Kock","Tim David"]},
  rcb:{name:"Royal Challengers Bangalore",players:["Virat Kohli","Faf du Plessis","Glenn Maxwell","Mohammed Siraj","Wanindu Hasaranga","Dinesh Karthik","Harshal Patel","Josh Hazlewood","Shahbaz Ahmed","Rajat Patidar","David Willey"]},
  kkr:{name:"Kolkata Knight Riders",players:["Shreyas Iyer","Andre Russell","Sunil Narine","Varun Chakravarthy","Nitish Rana","Venkatesh Iyer","Pat Cummins","Rahmanullah Gurbaz","Rinku Singh","Harshit Rana","Vaibhav Arora"]},
  dc:{name:"Delhi Capitals",players:["David Warner","Rishabh Pant","Axar Patel","Kuldeep Yadav","Anrich Nortje","Mitchell Marsh","Prithvi Shaw","Khaleel Ahmed","Ishant Sharma","Phil Salt","Mukesh Kumar"]},
  srh:{name:"Sunrisers Hyderabad",players:["Aiden Markram","Abhishek Sharma","Travis Head","Heinrich Klaasen","Abdul Samad","Bhuvneshwar Kumar","T Natarajan","Umran Malik","Washington Sundar","Marco Jansen","Mayank Agarwal"]},
  pbks:{name:"Punjab Kings",players:["Shikhar Dhawan","Jonny Bairstow","Liam Livingstone","Kagiso Rabada","Arshdeep Singh","Jitesh Sharma","Sam Curran","Rahul Chahar","Shahrukh Khan","Harpreet Brar","Shashank Singh"]},
  rr:{name:"Rajasthan Royals",players:["Sanju Samson","Jos Buttler","Yashasvi Jaiswal","Yuzvendra Chahal","Trent Boult","Ravichandran Ashwin","Shimron Hetmyer","Riyan Parag","Prasidh Krishna","Dhruv Jurel","Sandeep Sharma"]}
};

const PREDEFINED_TEAMS = {};
Object.keys(CRICKET_TEAMS).forEach(k => { PREDEFINED_TEAMS[k] = CRICKET_TEAMS[k].players; });

// ====== UTILS ======
const Utils = {
  getElement(id) { return document.getElementById(id); },
  getValue(id, def='') { const e=document.getElementById(id); return e?e.value:def; },
  setText(id, t) { const e=document.getElementById(id); if(e) e.textContent=t; },
  setHTML(id, h) { const e=document.getElementById(id); if(e) e.innerHTML=h; },
  sanitizeInput(s) { return Security.sanitizeInput(s); },
  parsePlayerList(s) {
    return s.split(',')
      .map(p => Security.sanitizeInput(p))
      .filter(Boolean)
      .slice(0, 11);
  },
  log(msg) {
    const el=document.getElementById('log');
    if(el){const p=document.createElement('p');p.textContent=msg;el.appendChild(p);el.scrollTop=el.scrollHeight;}
  },
  getBattingTeamIndex(inn) {
    const i=inn??GameState.currentInnings;
    return (i===0||i===2)?(GameState.userBattingFirst?GameState.userTeamIndex:GameState.compTeamIndex):(GameState.userBattingFirst?GameState.compTeamIndex:GameState.userTeamIndex);
  },
  toggleButtons(sel, en) { document.querySelectorAll(sel).forEach(b=>b.disabled=!en); },
  simulateMatch(t1, t2, overs=10) {
    const s=[0,0],w=[0,0];
    for(let i=0;i<overs*6&&w[0]<10;i++){const b=[3,4,5,6][Math.floor(Math.random()*4)],bw=[4,5,6][Math.floor(Math.random()*3)];if(b===bw)w[0]++;else s[0]+=b;}
    for(let i=0;i<overs*6&&w[1]<10&&s[1]<s[0];i++){const b=[3,4,5,6][Math.floor(Math.random()*4)],bw=[4,5,6][Math.floor(Math.random()*3)];if(b===bw)w[1]++;else s[1]+=b;}
    return{team1Score:s[0],team1Wickets:w[0],team2Score:s[1],team2Wickets:w[1],winner:s[1]>s[0]?t2:s[1]<s[0]?t1:'tie'};
  }
};

// ====== GAME STATE ======
const GameState = {
  teamNames:["",""],teamPlayers:[[],[]],overs:2,ballsPerOver:6,totalBallsPerInnings:0,
  matchMode:'custom',currentInnings:0,striker:0,nonStriker:1,currentBowler:null,lastBowler:null,
  scores:[0,0,0,0],wickets:[0,0,0,0],ballsBowled:[0,0,0,0],targets:[null,null,null,null],
  batsmenStats:[[],[],[],[]],ballByBall:[[],[],[],[]],bowlerStats:[[],[]],
  userTeamIndex:0,compTeamIndex:1,userBattingFirst:true,tossWinner:null,
  dayOvers:25,maxDays:5,totalMatchBalls:0,
  recentUserRuns:[],lastBattingRuns:[],bannedRuns:[],bannedCounter:{},
  lastBowlingRuns:[],lastUserInputs:[],overKillMode:false,killOverNumber:null,
  celebrationQueue:[],celebrationInProgress:false,isTournament:false,currentMatch:null,
  _matchHattricks:0, _matchCenturies:0, _matchFifties:0,
  get totalMatchBallsLimit(){return this.dayOvers*this.maxDays*this.ballsPerOver;},
  reset(){
    this.currentInnings=0;this.striker=0;this.nonStriker=1;this.currentBowler=null;this.lastBowler=null;
    this.totalMatchBalls=0;this.scores=[0,0,0,0];this.wickets=[0,0,0,0];this.ballsBowled=[0,0,0,0];
    this.targets=[null,null,null,null];this.batsmenStats=[[],[],[],[]];this.ballByBall=[[],[],[],[]];
    this.bowlerStats=[[],[]];this.recentUserRuns=[];this.lastBattingRuns=[];this.bannedRuns=[];
    this.bannedCounter={};this.lastBowlingRuns=[];this.lastUserInputs=[];this.overKillMode=false;
    this.killOverNumber=null;this.celebrationQueue=[];this.celebrationInProgress=false;
    this._matchHattricks=0;this._matchCenturies=0;this._matchFifties=0;
  }
};

// ====== TOURNAMENT STATE ======
const TournamentState = {
  userTeam:null,format:null,matchOvers:10,remainingTeamsForQualifier:[],
  _slotId:null,_startDate:null,
  challengeLeague:{groupA:[],groupB:[],matchesA:[],matchesB:[],standingsA:{},standingsB:{}},
  super6:{teams:[],matches:[],standings:{}},
  qualifier:{groupA:[],groupB:[],matchesA:[],matchesB:[],standingsA:{},standingsB:{}},
  worldCup:{teams:[],matches:[],standings:{},semiFinals:[],final:null},
  wtc:{teams:[],standings:{},allMatches:[],seriesProgress:{},final:null},
  ipl:{teams:[],standings:{},roundRobinMatches:[],eliminator1:null,eliminator2:null,eliminator3:null,final:null},
  userStats:{playerInnings:{},players:{},highestScore:{runs:0,player:'',match:''},bestBowling:{wickets:0,runs:999,player:'',match:''},centuries:[],fifties:[],hatTricks:[],threeWickets:[],fiveWickets:[],tenWickets:[]},
  currentStage:'challengeLeague',currentPhase:'groupA',
  reset(){
    this.remainingTeamsForQualifier=[];this._slotId=null;this._startDate=null;
    this.challengeLeague={groupA:[],groupB:[],matchesA:[],matchesB:[],standingsA:{},standingsB:{}};
    this.super6={teams:[],matches:[],standings:{}};
    this.qualifier={groupA:[],groupB:[],matchesA:[],matchesB:[],standingsA:{},standingsB:{}};
    this.worldCup={teams:[],matches:[],standings:{},semiFinals:[],final:null};
    this.wtc={teams:[],standings:{},allMatches:[],seriesProgress:{},final:null};
    this.ipl={teams:[],standings:{},roundRobinMatches:[],eliminator1:null,eliminator2:null,eliminator3:null,final:null};
    this.userStats={playerInnings:{},players:{},highestScore:{runs:0,player:'',match:''},bestBowling:{wickets:0,runs:999,player:'',match:''},centuries:[],fifties:[],hatTricks:[],threeWickets:[],fiveWickets:[],tenWickets:[]};
    this.currentStage='challengeLeague';this.currentPhase='groupA';
  }
};

// ====== AI ======
const AI = {
  getSmartBattingRun(){
    let opts=[3,4,5,6].filter(r=>!GameState.bannedRuns.includes(r));
    if(GameState.lastBattingRuns.length>=2){const l=GameState.lastBattingRuns[GameState.lastBattingRuns.length-1],s=GameState.lastBattingRuns[GameState.lastBattingRuns.length-2];if(l===s)opts=opts.filter(r=>r!==l);}
    if(!opts.length)opts=[3,4,5,6];
    const run=opts[Math.floor(Math.random()*opts.length)];
    GameState.lastBattingRuns.push(run);if(GameState.lastBattingRuns.length>3)GameState.lastBattingRuns.shift();
    Object.keys(GameState.bannedCounter).forEach(r=>{GameState.bannedCounter[r]--;if(GameState.bannedCounter[r]<=0){GameState.bannedRuns=GameState.bannedRuns.filter(x=>x!=r);delete GameState.bannedCounter[r];}});
    return run;
  },
  banRunAfterWicket(run){if(!GameState.bannedRuns.includes(run)){GameState.bannedRuns.push(run);GameState.bannedCounter[run]=4;}},
  getSmartBowlingRun(){return Math.floor(Math.random()*7);}
};

// ====== TOURNAMENT FUNCTIONS ======
const Tournament = {
  initialize(){
    TournamentState.reset();
    const all=Object.keys(CRICKET_TEAMS);
    const shuffled=all.filter(t=>t!==TournamentState.userTeam).sort(()=>Math.random()-0.5);
    TournamentState.challengeLeague.groupA=[TournamentState.userTeam,...shuffled.slice(0,3)];
    TournamentState.challengeLeague.groupB=shuffled.slice(3,7);
    this.initStandings(TournamentState.challengeLeague.groupA,TournamentState.challengeLeague.standingsA);
    this.initStandings(TournamentState.challengeLeague.groupB,TournamentState.challengeLeague.standingsB);
    TournamentState.challengeLeague.matchesA=this.roundRobin(TournamentState.challengeLeague.groupA);
    TournamentState.challengeLeague.matchesB=this.roundRobin(TournamentState.challengeLeague.groupB);
    TournamentState.remainingTeamsForQualifier=shuffled.slice(7,15);
  },
  initStandings(teams,obj){teams.forEach(t=>{obj[t]={played:0,won:0,lost:0,tied:0,points:0,nrr:0,for:0,against:0};});},
  roundRobin(teams){const m=[];for(let i=0;i<teams.length;i++)for(let j=i+1;j<teams.length;j++)m.push({team1:teams[i],team2:teams[j],completed:false,result:null});return m;},
  updateStandings(st,t1,t2,r){
    st[t1].played++;st[t2].played++;st[t1].for+=r.team1Score;st[t1].against+=r.team2Score;st[t2].for+=r.team2Score;st[t2].against+=r.team1Score;
    if(r.winner===t1){st[t1].won++;st[t1].points+=2;st[t2].lost++;}
    else if(r.winner===t2){st[t2].won++;st[t2].points+=2;st[t1].lost++;}
    else{st[t1].tied++;st[t2].tied++;st[t1].points++;st[t2].points++;}
    const nrr=(s)=>s.played?((s.for/s.played)-(s.against/s.played))/100:0;
    st[t1].nrr=nrr(st[t1]);st[t2].nrr=nrr(st[t2]);
  },
  topTeams(st,n){return Object.keys(st).sort((a,b)=>st[b].points!==st[a].points?st[b].points-st[a].points:st[b].nrr-st[a].nrr).slice(0,n);},
  advanceToSuper6(){
    const t=[...this.topTeams(TournamentState.challengeLeague.standingsA,3),...this.topTeams(TournamentState.challengeLeague.standingsB,3)];
    TournamentState.super6.teams=t;this.initStandings(t,TournamentState.super6.standings);
    TournamentState.super6.matches=this.roundRobin(t);TournamentState.currentStage='super6';TournamentState.currentPhase='main';
  },
  advanceToQualifier(){
    const top4=this.topTeams(TournamentState.super6.standings,4);
    const newT=TournamentState.remainingTeamsForQualifier.slice(0,6);
    const all=[...top4,...newT].sort(()=>Math.random()-0.5);
    const ui=all.indexOf(TournamentState.userTeam);if(ui>=5)[all[0],all[ui]]=[all[ui],all[0]];
    TournamentState.qualifier.groupA=all.slice(0,5);TournamentState.qualifier.groupB=all.slice(5,10);
    this.initStandings(TournamentState.qualifier.groupA,TournamentState.qualifier.standingsA);
    this.initStandings(TournamentState.qualifier.groupB,TournamentState.qualifier.standingsB);
    TournamentState.qualifier.matchesA=this.roundRobin(TournamentState.qualifier.groupA);
    TournamentState.qualifier.matchesB=this.roundRobin(TournamentState.qualifier.groupB);
    TournamentState.currentStage='qualifier';TournamentState.currentPhase='groupA';
  },
  advanceToWorldCup(){
    const t=[...this.topTeams(TournamentState.qualifier.standingsA,3),...this.topTeams(TournamentState.qualifier.standingsB,3)];
    TournamentState.worldCup.teams=t;this.initStandings(t,TournamentState.worldCup.standings);
    TournamentState.worldCup.matches=this.roundRobin(t);TournamentState.currentStage='worldCup';
  },
  generateSemiFinals(){
    const t=this.topTeams(TournamentState.worldCup.standings,4);
    TournamentState.worldCup.semiFinals=[{team1:t[0],team2:t[3],completed:false,result:null},{team1:t[1],team2:t[2],completed:false,result:null}];
  },
  generateFinal(){
    TournamentState.worldCup.final={team1:TournamentState.worldCup.semiFinals[0].result.winner,team2:TournamentState.worldCup.semiFinals[1].result.winner,completed:false,result:null};
  },
  async playMatch(match){
    if(match.team1===TournamentState.userTeam||match.team2===TournamentState.userTeam){
      GameState.isTournament=true;GameState.currentMatch=match;
      const u=match.team1===TournamentState.userTeam?match.team1:match.team2;
      const o=match.team1===TournamentState.userTeam?match.team2:match.team1;
      GameState.teamNames[0]=CRICKET_TEAMS[u].name;GameState.teamNames[1]=CRICKET_TEAMS[o].name;
      GameState.teamPlayers[0]=CRICKET_TEAMS[u].players;GameState.teamPlayers[1]=CRICKET_TEAMS[o].players;
      GameState.overs=TournamentState.matchOvers;GameState.totalBallsPerInnings=TournamentState.matchOvers*6;
      showSection('game');
      GameState.reset();initializeStats();
      const fmt=TournamentState.format==='t20WorldCup'?'T20 World Cup':'ODI World Cup';
      await TossAnim.show('üèÜ',fmt+' Match!',
        CRICKET_TEAMS[u].name+' vs '+CRICKET_TEAMS[o].name,
        TournamentState.matchOvers+' overs per side'
      );
      await performToss();
      Utils.log(GameState.teamNames[Utils.getBattingTeamIndex(0)]+' batting first!');
      updateBowlerOptions();updateUI();
      Utils.getElement('pauseMatchBtn').style.display='block';
    } else {
      const r=Utils.simulateMatch(match.team1,match.team2,TournamentState.matchOvers);
      match.completed=true;match.result=r;
      if(TournamentState.currentStage==='challengeLeague'){
        const st=TournamentState.currentPhase==='groupA'?TournamentState.challengeLeague.standingsA:TournamentState.challengeLeague.standingsB;
        this.updateStandings(st,match.team1,match.team2,r);
      } else if(TournamentState.currentStage==='super6') this.updateStandings(TournamentState.super6.standings,match.team1,match.team2,r);
      else if(TournamentState.currentStage==='qualifier'){
        const st=TournamentState.currentPhase==='groupA'?TournamentState.qualifier.standingsA:TournamentState.qualifier.standingsB;
        this.updateStandings(st,match.team1,match.team2,r);
      } else if(TournamentState.currentStage==='worldCup') this.updateStandings(TournamentState.worldCup.standings,match.team1,match.team2,r);
      showMatchAnimation(CRICKET_TEAMS[match.team1].name,CRICKET_TEAMS[match.team2].name,r);
    }
  }
};

// ====== SETUP FUNCTIONS ======
function startHandCricket(){showSection('setup');}
window.startHandCricket=startHandCricket;

function handleModeChange(){
  const m=Utils.getValue('matchMode');GameState.matchMode=m;
  if(m==='tournament'){
    Utils.getElement('customMatchSetup').style.display='none';
    Utils.getElement('tournamentSetup').style.display='block';
  } else {
    Utils.getElement('customMatchSetup').style.display='block';
    Utils.getElement('tournamentSetup').style.display='none';
    const o=Utils.getElement('overs');
    const ov={t20i:4,odi:10,test:25,rct:15,ipl:5};
    if(ov[m]){o.value=ov[m];o.disabled=true;}else{o.disabled=false;}
    updatePredefinedTeams(PREDEFINED_TEAMS);
  }
}

// ‚îÄ‚îÄ MODIFIED: auto-redirect to pending tournament if format has a saved slot ‚îÄ‚îÄ
function handleTournamentFormatChange(){
  const f=Utils.getValue('tournamentFormat'),d=Utils.getElement('tournamentFormatDetails');
  if(!f){d.style.display='none';return;}

  // Check if a pending tournament slot exists for this format
  const pending=DataManager.getTournaments().filter(s=>s.format===f);
  if(pending.length>0){
    const newest=pending[pending.length-1]; // most recently saved slot
    const fmtNames={odiWorldCup:'ODI World Cup',t20WorldCup:'T20 World Cup',wtc:'World Test Championship',ipl:'IPL'};
    const stageNames={challengeLeague:'Challenge League',super6:'Super 6',qualifier:'Qualifier',worldCup:'World Cup',wtc:'WTC League',ipl:'IPL Round Robin / Playoffs'};
    const msg=`You have a saved ${fmtNames[f]||f} tournament in progress!\n\nTeam: ${newest.teamName}\nStage: ${stageNames[newest.stage]||newest.stage}\nLast saved: ${newest.lastSaved}\n\nResume this tournament?`;
    if(confirm(msg)){
      // Resume directly ‚Äî close setup, go straight to tournament
      resumeTournamentSlot(newest.id);
      // Reset the select so it's clean if user comes back to setup
      Utils.getElement('tournamentFormat').value='';
      d.style.display='none';
      return;
    }
    // User chose "Cancel" ‚Äî fall through to normal new-tournament setup below
  }

  d.style.display='block';
  const info={
    odiWorldCup:{desc:'Challenge League ‚Üí Super 6 ‚Üí Qualifier ‚Üí World Cup. 10 overs.',teams:CRICKET_TEAMS,overs:10},
    t20WorldCup:{desc:'Same structure, 4 overs for fast action!',teams:CRICKET_TEAMS,overs:4},
    wtc:{desc:'3 TEST matches vs each of 9 teams. Win=4pts, Draw=2pts. Top 2 play Final.',teams:CRICKET_TEAMS,overs:25},
    ipl:{desc:'Round-robin with 8 IPL teams, then Eliminators + Final. 5 overs.',teams:IPL_TEAMS,overs:5}
  };
  const inf=info[f];
  Utils.getElement('formatDescription').textContent=inf.desc;
  TournamentState.format=f;TournamentState.matchOvers=inf.overs;
  const ts=Utils.getElement('userTournamentTeam');
  ts.innerHTML='<option value="">--Select Your Team--</option>';
  Object.keys(inf.teams).forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=inf.teams[k].name;ts.appendChild(o);});
}

function handleTournamentFormatChange_ORIGINAL(){} // kept for reference; not used

function updatePredefinedTeams(obj){
  const s=Utils.getElement('predefinedTeams');if(!s)return;
  s.innerHTML='<option value="">--Select Team--</option>';
  Object.keys(obj).forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=k.toUpperCase();s.appendChild(o);});
}

function handleTeamSelection(){
  const k=Utils.getValue('predefinedTeams');if(!k)return;
  const p=PREDEFINED_TEAMS[k];if(p)Utils.getElement('team2Players').value=p.join(', ');
}

async function startTournament(){
  if(!TournamentState.format){alert('Select tournament format!');return;}
  const u=Utils.getValue('userTournamentTeam');
  if(!u){alert('Select your team!');return;}
  TournamentState.userTeam=u;
  TournamentState._startDate=new Date().toLocaleString();
  TournamentState._slotId=null;
  const fmtNames={odiWorldCup:'ODI World Cup üèÜ',t20WorldCup:'T20 World Cup üèÜ',wtc:'World Test Championship üèÜ',ipl:'Indian Premier League üèÜ'};
  const tTeams={ipl:IPL_TEAMS,odiWorldCup:CRICKET_TEAMS,t20WorldCup:CRICKET_TEAMS,wtc:CRICKET_TEAMS};
  const teamObj=tTeams[TournamentState.format]||CRICKET_TEAMS;
  const tName=(teamObj[u]||{}).name||u;
  await TossAnim.show('üèÜ',fmtNames[TournamentState.format]||'Tournament Begins!',
    'Your team: '+tName,
    'Good luck! Let the tournament begin!'
  );
  showSection('tournament');
  const titles={odiWorldCup:'üèÜ ODI World Cup',t20WorldCup:'üèÜ T20 World Cup',wtc:'üèÜ World Test Championship',ipl:'üèÜ Indian Premier League'};
  Utils.setText('tournamentTitle',titles[TournamentState.format]||'üèÜ Tournament');
  const nav=Utils.getElement('tournamentNav'),sb=Utils.getElement('statsCornerBtn');
  if(TournamentState.format==='wtc'||TournamentState.format==='ipl'){nav.style.display='none';sb.style.display='block';}
  else{nav.style.display='flex';sb.style.display='none';}
  if(TournamentState.format==='odiWorldCup'||TournamentState.format==='t20WorldCup'){Tournament.initialize();showTournamentStage('challengeLeague');}
  else if(TournamentState.format==='wtc'){initializeWTC();showWTCStage();}
  else if(TournamentState.format==='ipl'){initializeIPL();showIPLStage();}
  saveTournamentNow();
}

async function startGame(){
  GameState.teamNames[0]=Security.sanitizeInput(Utils.getValue('team1'))||'User Team';
  GameState.teamNames[1]=Security.sanitizeInput(Utils.getValue('team2'))||'Computer';
  const ov=Security.validateNumber(Utils.getValue('overs'),1,50,2);
  GameState.overs=ov;GameState.totalBallsPerInnings=ov*GameState.ballsPerOver;
  GameState.teamPlayers[0]=Utils.parsePlayerList(Utils.getValue('team1Players'));
  GameState.teamPlayers[1]=Utils.parsePlayerList(Utils.getValue('team2Players'));
  if(GameState.teamPlayers[0].length<2||GameState.teamPlayers[1].length<2){alert('At least 2 players per team.');return;}
  GameState.reset();initializeStats();
  showSection('game');
  await TossAnim.show('üèè','Match About to Begin!',
    GameState.teamNames[0]+' vs '+GameState.teamNames[1],
    GameState.overs+' overs per side'
  );
  await performToss();
  Utils.getElement('resultBox').style.display='none';
  Utils.log(GameState.teamNames[Utils.getBattingTeamIndex(0)]+' batting first!');
  updateBowlerOptions();updateUI();
}

// ====== WTC ======
function initializeWTC(){
  TournamentState.reset();
  const teams=['india','australia','england','newzealand','southafrica','pakistan','srilanka','westindies','bangladesh','afghanistan'];
  TournamentState.wtc.teams=teams;TournamentState.currentStage='wtc';
  teams.forEach(t=>{TournamentState.wtc.standings[t]={played:0,won:0,lost:0,drawn:0,points:0,winPercentage:0};});
  const allM=[],sp={};
  for(let i=0;i<teams.length;i++)for(let j=i+1;j<teams.length;j++){
    const k=teams[i]+'_vs_'+teams[j];
    sp[k]={team1:teams[i],team2:teams[j],matches:[],team1Wins:0,team2Wins:0,draws:0,completed:false};
    for(let n=1;n<=3;n++){const m={team1:teams[i],team2:teams[j],seriesKey:k,matchNumber:n,completed:false,result:null,pausedState:null};allM.push(m);sp[k].matches.push(m);}
  }
  TournamentState.wtc.allMatches=allM;TournamentState.wtc.seriesProgress=sp;
}

function showWTCStage(){
  const c=Utils.getElement('tournamentContent'),st=TournamentState.wtc.standings,sp=TournamentState.wtc.seriesProgress;
  const sorted=Object.keys(st).sort((a,b)=>st[b].points!==st[a].points?st[b].points-st[a].points:st[b].winPercentage-st[a].winPercentage);
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:15px">
    <h3>üèÜ World Test Championship</h3>
    <button onclick="returnToHome()" style="width:auto;padding:8px 16px;background:#718096;font-size:13px">üè† Home</button>
  </div>
  <p>Win=4pts, Draw=2pts, Loss=1pt. Top 2 play Final.</p>
  <table class="points-table"><tr><th>Rank</th><th>Team</th><th>P</th><th>W</th><th>L</th><th>D</th><th>Pts</th><th>Win%</th></tr>`;
  sorted.forEach((t,i)=>h+=`<tr class="${i<2?'qualified':''}">`+
    `<td>${i+1}</td><td>${Security.escapeHtml(CRICKET_TEAMS[t].name)}${t===TournamentState.userTeam?' üéÆ':''}</td>`+
    `<td>${st[t].played}</td><td>${st[t].won}</td><td>${st[t].lost}</td><td>${st[t].drawn}</td>`+
    `<td><strong>${st[t].points}</strong></td><td>${st[t].winPercentage.toFixed(1)}%</td></tr>`);
  h+='</table><h4 style="margin-top:20px">üìÖ Series</h4>';
  Object.entries(sp).forEach(([k,s])=>{
    const isU=s.team1===TournamentState.userTeam||s.team2===TournamentState.userTeam;
    h+=`<div style="border:2px solid ${isU?'#48bb78':'#e2e8f0'};border-radius:8px;padding:14px;margin:8px 0;background:${isU?'#f0fff4':'white'}">
      <strong>${Security.escapeHtml(CRICKET_TEAMS[s.team1].name)} vs ${Security.escapeHtml(CRICKET_TEAMS[s.team2].name)}</strong>
      <span style="color:#666;font-size:13px"> (${s.team1Wins}-${s.team2Wins}${s.draws>0?'-'+s.draws:''})</span>`;
    s.matches.forEach((m,i)=>{
      if(m.completed)h+=`<div style="font-size:13px;color:#666;padding:3px 0">Match ${m.matchNumber}: ${Security.escapeHtml(CRICKET_TEAMS[m.team1].name)} ${m.result.team1Score}/${m.result.team1Wickets} vs ${Security.escapeHtml(CRICKET_TEAMS[m.team2].name)} ${m.result.team2Score}/${m.result.team2Wickets} - <strong>${m.result.winner==='tie'?'DRAW':Security.escapeHtml(CRICKET_TEAMS[m.result.winner].name)}</strong></div>`;
      else h+=`<div style="padding:4px 0"><button onclick="playWTCMatch('${Security.escapeHtml(k)}',${i})" style="font-size:13px;padding:7px 14px;background:${m.pausedState?'#f59e0b':'#667eea'};color:white;border:none;border-radius:4px;cursor:pointer;width:auto">${m.pausedState?'‚è∏Ô∏è Continue':'‚ñ∂Ô∏è Match '+m.matchNumber}</button></div>`;
    });
    if(!isU){const inc=s.matches.filter(m=>!m.completed).length;if(inc>0)h+=`<button onclick="simulateWTCSeries('${Security.escapeHtml(k)}')" style="margin-top:5px;font-size:12px;padding:5px 10px;background:#9ca3af;color:white;border:none;border-radius:4px;cursor:pointer;width:auto">Simulate (${inc})</button>`;}
    h+='</div>';
  });
  const allDone=TournamentState.wtc.allMatches.every(m=>m.completed);
  if(allDone&&!TournamentState.wtc.final)h+=`<button onclick="generateWTCFinal()" style="margin-top:20px">Generate WTC Final ‚Üí</button>`;
  if(TournamentState.wtc.final){
    const f=TournamentState.wtc.final;
    h+=`<h4 style="margin-top:20px">üèÜ WTC FINAL</h4>`;
    if(f.completed)h+=`<div class="match-card completed"><strong>${Security.escapeHtml(CRICKET_TEAMS[f.team1].name)}</strong> ${f.result.team1Score}/${f.result.team1Wickets} vs <strong>${Security.escapeHtml(CRICKET_TEAMS[f.team2].name)}</strong> ${f.result.team2Score}/${f.result.team2Wickets}<br><span style="color:#38a169">üèÜ Champion: ${f.result.winner==='tie'?'DRAW':Security.escapeHtml(CRICKET_TEAMS[f.result.winner].name)}</span></div>`;
    else h+=`<div class="match-card" onclick="playWTCFinal()"><strong>${Security.escapeHtml(CRICKET_TEAMS[f.team1].name)}</strong> vs <strong>${Security.escapeHtml(CRICKET_TEAMS[f.team2].name)}</strong><br><span style="color:${f.pausedState?'#f59e0b':'#667eea'}">${f.pausedState?'‚è∏Ô∏è Continue':'‚ñ∂Ô∏è Play Final'}</span></div>`;
  }
  c.innerHTML=h;
}

function playWTCMatch(sKey,mIdx){
  const s=TournamentState.wtc.seriesProgress[sKey];if(!s)return;
  const match=s.matches[mIdx];if(!match)return;
  TournamentState.currentStage='wtc';TournamentState.currentPhase='series';GameState.currentMatch=match;
  match.pausedState?resumeMatch(match):playWTCMatchNew(match);
}
async function playWTCMatchNew(match){
  const isU=match.team1===TournamentState.userTeam||match.team2===TournamentState.userTeam;
  if(isU){
    GameState.isTournament=true;GameState.currentMatch=match;GameState.matchMode='test';
    const u=match.team1===TournamentState.userTeam?match.team1:match.team2;
    const o=match.team1===TournamentState.userTeam?match.team2:match.team1;
    GameState.teamNames[0]=CRICKET_TEAMS[u].name;GameState.teamNames[1]=CRICKET_TEAMS[o].name;
    GameState.teamPlayers[0]=CRICKET_TEAMS[u].players;GameState.teamPlayers[1]=CRICKET_TEAMS[o].players;
    GameState.overs=25;GameState.dayOvers=25;GameState.maxDays=5;GameState.ballsPerOver=6;GameState.totalBallsPerInnings=150;
    showSection('game');
    Utils.setText('matchTitle',`${CRICKET_TEAMS[match.team1].name} vs ${CRICKET_TEAMS[match.team2].name} - WTC Test Match ${match.matchNumber}`);
    GameState.reset();initializeStats();
    await TossAnim.show('üèè','WTC Test Match!',
      CRICKET_TEAMS[match.team1].name+' vs '+CRICKET_TEAMS[match.team2].name,
      'Test Match '+match.matchNumber+' ‚Ä¢ 25 overs/day ‚Ä¢ 5 days'
    );
    await performToss();
    Utils.log('üèè TEST MATCH: '+GameState.teamNames[Utils.getBattingTeamIndex(0)]+' batting first!');
    updateBowlerOptions();updateUI();
    Utils.getElement('pauseMatchBtn').style.display='block';
    Utils.getElement('dayOversDisplay').style.display='block';
  } else {
    const r=simulateTestMatch(match.team1,match.team2);
    updateWTCMatchResult(match,r);showWTCStage();
  }
}
function simulateTestMatch(t1,t2){
  const inn=[Math.floor(Math.random()*300)+150,Math.floor(Math.random()*300)+150,Math.floor(Math.random()*250)+100,0];
  const wk=[Math.floor(Math.random()*10)+1,Math.floor(Math.random()*10)+1,Math.floor(Math.random()*10)+1,0];
  const tgt=inn[0]+inn[2]-inn[1];
  inn[3]=tgt>0?Math.floor(Math.random()*(tgt+100)):0;
  wk[3]=inn[3]>=tgt?Math.floor(Math.random()*5):10;
  const t1t=inn[0]+inn[2],t2t=inn[1]+inn[3];
  return{team1Score:t1t,team1Wickets:wk[0]+wk[2],team2Score:t2t,team2Wickets:wk[1]+wk[3],winner:t1t>t2t?t1:t2t>t1t?t2:'tie'};
}
function simulateWTCSeries(sKey){
  const s=TournamentState.wtc.seriesProgress[sKey];
  s.matches.forEach(m=>{if(!m.completed&&m.team1!==TournamentState.userTeam&&m.team2!==TournamentState.userTeam){const r=Utils.simulateMatch(m.team1,m.team2,TournamentState.matchOvers);updateWTCMatchResult(m,r);}});
  showWTCStage();
}
function updateWTCMatchResult(match,result){
  match.completed=true;match.result=result;match.pausedState=null;
  const s=TournamentState.wtc.seriesProgress[match.seriesKey],st=TournamentState.wtc.standings;
  if(result.winner===match.team1)s.team1Wins++;else if(result.winner===match.team2)s.team2Wins++;else s.draws++;
  if(s.matches.every(m=>m.completed))s.completed=true;
  st[match.team1].played++;st[match.team2].played++;
  if(result.winner===match.team1){st[match.team1].won++;st[match.team1].points+=4;st[match.team2].lost++;st[match.team2].points+=1;}
  else if(result.winner===match.team2){st[match.team2].won++;st[match.team2].points+=4;st[match.team1].lost++;st[match.team1].points+=1;}
  else{st[match.team1].drawn++;st[match.team2].drawn++;st[match.team1].points+=2;st[match.team2].points+=2;}
  [match.team1,match.team2].forEach(t=>{st[t].winPercentage=st[t].played?(st[t].won/st[t].played)*100:0;});
}
function generateWTCFinal(){
  const st=TournamentState.wtc.standings;
  const top=Object.keys(st).sort((a,b)=>st[b].points!==st[a].points?st[b].points-st[a].points:st[b].winPercentage-st[a].winPercentage);
  TournamentState.wtc.final={team1:top[0],team2:top[1],completed:false,result:null,pausedState:null};
  showWTCStage();
}
function playWTCFinal(){
  const f=TournamentState.wtc.final;TournamentState.currentStage='wtc';TournamentState.currentPhase='final';GameState.currentMatch=f;
  f.pausedState?resumeMatch(f):playWTCMatchNew(f);
}

// ====== IPL ======
function initializeIPL(){
  TournamentState.reset();
  const teams=['csk','mi','rcb','kkr','dc','srh','pbks','rr'];
  TournamentState.ipl.teams=teams;TournamentState.currentStage='ipl';TournamentState.currentPhase='roundRobin';
  teams.forEach(t=>{TournamentState.ipl.standings[t]={played:0,won:0,lost:0,points:0,nrr:0,for:0,against:0};});
  const m=[];for(let i=0;i<teams.length;i++)for(let j=0;j<teams.length;j++)if(i!==j)m.push({team1:teams[i],team2:teams[j],completed:false,result:null,pausedState:null});
  TournamentState.ipl.roundRobinMatches=m;
}
function showIPLStage(){TournamentState.currentPhase==='roundRobin'?showIPLRR():showIPLPlayoffs();}
function showIPLRR(){
  const c=Utils.getElement('tournamentContent'),st=TournamentState.ipl.standings,m=TournamentState.ipl.roundRobinMatches;
  const sorted=Object.keys(st).sort((a,b)=>st[b].points!==st[a].points?st[b].points-st[a].points:st[b].nrr-st[a].nrr);
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:15px">
    <h3>üèè IPL Round Robin</h3>
    <button onclick="returnToHome()" style="width:auto;padding:8px 16px;background:#718096;font-size:13px">üè† Home</button>
  </div>
  <table class="points-table"><tr><th>Pos</th><th>Team</th><th>P</th><th>W</th><th>L</th><th>Pts</th><th>NRR</th></tr>`;
  sorted.forEach((t,i)=>h+=`<tr class="${i<4?'qualified':''}">`+
    `<td>${i+1}</td><td>${Security.escapeHtml(IPL_TEAMS[t].name)}${t===TournamentState.userTeam?' üéÆ':''}</td>`+
    `<td>${st[t].played}</td><td>${st[t].won}</td><td>${st[t].lost}</td>`+
    `<td><strong>${st[t].points}</strong></td><td>${st[t].nrr.toFixed(2)}</td></tr>`);
  h+='</table><h4 style="margin-top:20px">üìÖ Fixtures</h4>';
  const uM=m.filter(x=>x.team1===TournamentState.userTeam||x.team2===TournamentState.userTeam);
  const oM=m.filter(x=>x.team1!==TournamentState.userTeam&&x.team2!==TournamentState.userTeam);
  if(uM.some(x=>!x.completed)){
    h+='<h5 style="color:#48bb78;margin:12px 0">‚ö° Your Matches</h5>';
    uM.forEach((match)=>{const gi=m.indexOf(match);h+=renderIPLMatchCard(match,gi);});
  }
  const incO=oM.filter(x=>!x.completed);
  if(incO.length>0)h+=`<button onclick="simAllIPL()" style="margin:10px 0;padding:10px 20px;background:#9ca3af;color:white;border:none;border-radius:5px;cursor:pointer;width:auto">Simulate All Others (${incO.length})</button>`;
  if(m.every(x=>x.completed))h+=`<button onclick="generateIPLPlayoffs()" style="margin-top:20px">Generate Playoffs ‚Üí</button>`;
  c.innerHTML=h;
}
function renderIPLMatchCard(match,idx){
  if(match.completed){const w=match.result.winner==='tie'?'TIE':Security.escapeHtml(IPL_TEAMS[match.result.winner].name);return`<div style="padding:10px;background:#f7fafc;border-radius:5px;margin:5px 0;font-size:14px"><strong>${Security.escapeHtml(IPL_TEAMS[match.team1].name)}</strong> ${match.result.team1Score}/${match.result.team1Wickets} vs <strong>${Security.escapeHtml(IPL_TEAMS[match.team2].name)}</strong> ${match.result.team2Score}/${match.result.team2Wickets} - <strong style="color:#48bb78">${w}</strong></div>`;}
  return`<div style="padding:5px 0"><button onclick="playIPLMatch(${Number(idx)})" style="width:100%;padding:10px;background:${match.pausedState?'#f59e0b':'#667eea'};color:white;border:none;border-radius:5px;cursor:pointer">${match.pausedState?'‚è∏Ô∏è Continue: ':'‚ñ∂Ô∏è '}${Security.escapeHtml(IPL_TEAMS[match.team1].name)} vs ${Security.escapeHtml(IPL_TEAMS[match.team2].name)}</button></div>`;
}
function playIPLMatch(idx){
  const match=TournamentState.ipl.roundRobinMatches[idx];
  TournamentState.currentStage='ipl';TournamentState.currentPhase='roundRobin';GameState.currentMatch=match;
  match.pausedState?resumeMatch(match):playIPLMatchNew(match);
}
async function playIPLMatchNew(match){
  const isU=match.team1===TournamentState.userTeam||match.team2===TournamentState.userTeam;
  if(isU){
    GameState.isTournament=true;GameState.currentMatch=match;
    const u=match.team1===TournamentState.userTeam?match.team1:match.team2;
    const o=match.team1===TournamentState.userTeam?match.team2:match.team1;
    GameState.teamNames[0]=IPL_TEAMS[u].name;GameState.teamNames[1]=IPL_TEAMS[o].name;
    GameState.teamPlayers[0]=IPL_TEAMS[u].players;GameState.teamPlayers[1]=IPL_TEAMS[o].players;
    GameState.overs=TournamentState.matchOvers;GameState.totalBallsPerInnings=TournamentState.matchOvers*6;
    showSection('game');
    Utils.setText('matchTitle',`${IPL_TEAMS[match.team1].name} vs ${IPL_TEAMS[match.team2].name}`);
    GameState.reset();initializeStats();
    await TossAnim.show('üèè','IPL Match!',IPL_TEAMS[match.team1].name+' vs '+IPL_TEAMS[match.team2].name,TournamentState.matchOvers+' overs per side');
    await performToss();
    Utils.log(GameState.teamNames[Utils.getBattingTeamIndex(0)]+' batting first!');
    updateBowlerOptions();updateUI();
    Utils.getElement('pauseMatchBtn').style.display='block';
  } else {
    const r=Utils.simulateMatch(match.team1,match.team2,TournamentState.matchOvers);
    updateIPLMatchResult(match,r);showIPLStage();
  }
}
function simAllIPL(){
  TournamentState.ipl.roundRobinMatches.forEach(m=>{if(!m.completed&&m.team1!==TournamentState.userTeam&&m.team2!==TournamentState.userTeam){const r=Utils.simulateMatch(m.team1,m.team2,TournamentState.matchOvers);updateIPLMatchResult(m,r);}});
  showIPLStage();
}
function updateIPLMatchResult(match,r){
  match.completed=true;match.result=r;match.pausedState=null;
  const st=TournamentState.ipl.standings;
  st[match.team1].played++;st[match.team2].played++;
  st[match.team1].for+=r.team1Score;st[match.team1].against+=r.team2Score;
  st[match.team2].for+=r.team2Score;st[match.team2].against+=r.team1Score;
  if(r.winner===match.team1){st[match.team1].won++;st[match.team1].points+=2;st[match.team2].lost++;}
  else if(r.winner===match.team2){st[match.team2].won++;st[match.team2].points+=2;st[match.team1].lost++;}
  else{st[match.team1].points++;st[match.team2].points++;}
  [match.team1,match.team2].forEach(t=>{st[t].nrr=st[t].played?(st[t].for/st[t].played)-(st[t].against/st[t].played):0;});
}
function generateIPLPlayoffs(){
  const st=TournamentState.ipl.standings;
  const top4=Object.keys(st).sort((a,b)=>st[b].points!==st[a].points?st[b].points-st[a].points:st[b].nrr-st[a].nrr).slice(0,4);
  TournamentState.ipl.eliminator1={team1:top4[0],team2:top4[1],completed:false,result:null,pausedState:null,name:'Eliminator 1 (1st vs 2nd)'};
  TournamentState.ipl.eliminator2={team1:top4[2],team2:top4[3],completed:false,result:null,pausedState:null,name:'Eliminator 2 (3rd vs 4th)'};
  TournamentState.currentPhase='playoffs';showIPLStage();
}
function showIPLPlayoffs(){
  const c=Utils.getElement('tournamentContent');
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:15px">
    <h3>üèè IPL Playoffs</h3><button onclick="returnToHome()" style="width:auto;padding:8px 16px;background:#718096;font-size:13px">üè† Home</button>
  </div>`;
  const pm=(match,fn)=>{if(!match)return'';
    if(match.completed){const w=Security.escapeHtml(IPL_TEAMS[match.result.winner]?.name||'Unknown');return`<div style="background:#f7fafc;padding:18px;border-radius:10px;margin:12px 0;border-left:4px solid #48bb78"><h5>${Security.escapeHtml(match.name||'')}</h5><p>${Security.escapeHtml(IPL_TEAMS[match.team1].name)} ${match.result.team1Score}/${match.result.team1Wickets}</p><p>${Security.escapeHtml(IPL_TEAMS[match.team2].name)} ${match.result.team2Score}/${match.result.team2Wickets}</p><strong style="color:#48bb78">Winner: ${w}</strong></div>`;}
    return`<div style="background:white;padding:18px;border-radius:10px;margin:12px 0;border:2px solid #667eea"><h5>${Security.escapeHtml(match.name||'')}</h5><button onclick="${fn}()" style="width:100%;padding:14px;background:${match.pausedState?'#f59e0b':'#667eea'};color:white;border:none;border-radius:5px;cursor:pointer">${match.pausedState?'‚è∏Ô∏è Continue: ':'‚ñ∂Ô∏è '}${Security.escapeHtml(IPL_TEAMS[match.team1].name)} vs ${Security.escapeHtml(IPL_TEAMS[match.team2].name)}</button></div>`;};
  h+=pm(TournamentState.ipl.eliminator1,'playE1');
  h+=pm(TournamentState.ipl.eliminator2,'playE2');
  if(TournamentState.ipl.eliminator1?.completed&&TournamentState.ipl.eliminator2?.completed&&!TournamentState.ipl.eliminator3)
    h+=`<button onclick="genE3()" style="margin:15px 0">Generate Eliminator 3 ‚Üí</button>`;
  if(TournamentState.ipl.eliminator3){h+=pm(TournamentState.ipl.eliminator3,'playE3');
    if(TournamentState.ipl.eliminator3.completed&&!TournamentState.ipl.final)h+=`<button onclick="genFinal()" style="margin:15px 0">Generate Final ‚Üí</button>`;}
  if(TournamentState.ipl.final){h+='<h4 style="margin-top:30px;color:#667eea">üèÜ IPL FINAL</h4>';h+=pm(TournamentState.ipl.final,'playIPLFinalMatch');}
  c.innerHTML=h;
}
function playE1(){playIPLPlayoff(TournamentState.ipl.eliminator1);}
function playE2(){playIPLPlayoff(TournamentState.ipl.eliminator2);}
function playE3(){playIPLPlayoff(TournamentState.ipl.eliminator3);}
function playIPLFinalMatch(){TournamentState.currentPhase='final';playIPLPlayoff(TournamentState.ipl.final);}
function playIPLPlayoff(match){TournamentState.currentStage='ipl';GameState.currentMatch=match;match.pausedState?resumeMatch(match):playIPLMatchNew(match);}
function genE3(){
  const e1L=TournamentState.ipl.eliminator1.result.winner===TournamentState.ipl.eliminator1.team1?TournamentState.ipl.eliminator1.team2:TournamentState.ipl.eliminator1.team1;
  TournamentState.ipl.eliminator3={team1:TournamentState.ipl.eliminator2.result.winner,team2:e1L,completed:false,result:null,pausedState:null,name:'Eliminator 3'};
  showIPLStage();
}
function genFinal(){
  TournamentState.ipl.final={team1:TournamentState.ipl.eliminator1.result.winner,team2:TournamentState.ipl.eliminator3.result.winner,completed:false,result:null,pausedState:null,name:'IPL FINAL'};
  showIPLStage();
}

// ====== TOURNAMENT STAGE DISPLAY ======
function showTournamentStage(stage){
  const c=Utils.getElement('tournamentContent');
  const renderTable=(st,teams,qCount=3)=>{
    const sorted=[...teams].sort((a,b)=>st[b].points!==st[a].points?st[b].points-st[a].points:st[b].nrr-st[a].nrr);
    return`<table class="points-table"><thead><tr><th>Team</th><th>P</th><th>W</th><th>L</th><th>Pts</th><th>NRR</th></tr></thead><tbody>`+
      sorted.map((t,i)=>`<tr class="${i<qCount?'qualified':''}">`+`<td>${Security.escapeHtml(CRICKET_TEAMS[t].name)}</td><td>${st[t].played}</td><td>${st[t].won}</td><td>${st[t].lost}</td><td>${st[t].points}</td><td>${st[t].nrr.toFixed(2)}</td></tr>`).join('')+
      '</tbody></table>';
  };
  const renderM=(matches,stg,ph)=>{
    return '<div style="margin-top:12px">'+matches.map((m,i)=>{
      if(m.completed){const w=m.result.winner==='tie'?'TIE':Security.escapeHtml(CRICKET_TEAMS[m.result.winner].name);return`<div class="match-card completed"><strong>${Security.escapeHtml(CRICKET_TEAMS[m.team1].name)}</strong> ${m.result.team1Score}/${m.result.team1Wickets} vs <strong>${Security.escapeHtml(CRICKET_TEAMS[m.team2].name)}</strong> ${m.result.team2Score}/${m.result.team2Wickets}<br><span style="color:#38a169">Winner: ${w}</span></div>`;}
      const ip=m.pausedState;
      return`<div class="match-card${ip?' match-card-paused':''}" onclick="playTMatch('${stg}','${ph}',${i})" style="${ip?'border-color:#f59e0b;background:#fffbeb':''}"><strong>${Security.escapeHtml(CRICKET_TEAMS[m.team1].name)}</strong> vs <strong>${Security.escapeHtml(CRICKET_TEAMS[m.team2].name)}</strong>${ip?'<br><span style="color:#f59e0b;font-weight:bold">‚è∏Ô∏è PAUSED</span>':''}<br><span style="color:${ip?'#f59e0b':'#667eea'};font-size:14px">${ip?'‚ñ∂Ô∏è Continue Match':'Click to play ‚Üí'}</span></div>`;
    }).join('')+'</div>';
  };
  const done=arr=>arr.every(m=>m.completed);
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:15px">
    <span></span><button onclick="returnToHome()" style="width:auto;padding:8px 16px;background:#718096;font-size:13px">üè† Home</button></div>`;
  if(stage==='challengeLeague'){
    h+=`<h3>üèÜ Challenge League</h3><p>Top 3 from each group ‚Üí Super 6</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div><h4>Group A</h4>${renderTable(TournamentState.challengeLeague.standingsA,TournamentState.challengeLeague.groupA)}${renderM(TournamentState.challengeLeague.matchesA,'challengeLeague','groupA')}</div>
      <div><h4>Group B</h4>${renderTable(TournamentState.challengeLeague.standingsB,TournamentState.challengeLeague.groupB)}${renderM(TournamentState.challengeLeague.matchesB,'challengeLeague','groupB')}</div>
    </div>
    ${done(TournamentState.challengeLeague.matchesA)&&done(TournamentState.challengeLeague.matchesB)?`<button onclick="Tournament.advanceToSuper6();showTournamentStage('super6')" style="margin-top:15px">Advance to Super 6 ‚Üí</button>`:''}`;
  } else if(stage==='super6'){
    if(!TournamentState.super6.teams.length){c.innerHTML='<p>Complete Challenge League first!</p>';return;}
    h+=`<h3>üèÜ Super 6</h3><p>Top 4 advance to Qualifier</p>${renderTable(TournamentState.super6.standings,TournamentState.super6.teams,4)}${renderM(TournamentState.super6.matches,'super6','main')}
    ${done(TournamentState.super6.matches)?`<button onclick="Tournament.advanceToQualifier();showTournamentStage('qualifier')" style="margin-top:15px">Advance to Qualifier ‚Üí</button>`:''}`;
  } else if(stage==='qualifier'){
    if(!TournamentState.qualifier.groupA.length){c.innerHTML='<p>Complete Super 6 first!</p>';return;}
    h+=`<h3>üèÜ Qualifier</h3><p>Top 3 from each group ‚Üí World Cup</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div><h4>Group A</h4>${renderTable(TournamentState.qualifier.standingsA,TournamentState.qualifier.groupA)}${renderM(TournamentState.qualifier.matchesA,'qualifier','groupA')}</div>
      <div><h4>Group B</h4>${renderTable(TournamentState.qualifier.standingsB,TournamentState.qualifier.groupB)}${renderM(TournamentState.qualifier.matchesB,'qualifier','groupB')}</div>
    </div>
    ${done(TournamentState.qualifier.matchesA)&&done(TournamentState.qualifier.matchesB)?`<button onclick="Tournament.advanceToWorldCup();showTournamentStage('worldCup')" style="margin-top:15px">Advance to World Cup ‚Üí</button>`:''}`;
  } else if(stage==='worldCup'){
    if(!TournamentState.worldCup.teams.length){c.innerHTML='<p>Complete Qualifier first!</p>';return;}
    h+=`<h3>üèÜ World Cup</h3><p>Top 4 ‚Üí Semi-Finals</p>${renderTable(TournamentState.worldCup.standings,TournamentState.worldCup.teams,4)}${renderM(TournamentState.worldCup.matches,'worldCup','main')}`;
    if(done(TournamentState.worldCup.matches)&&!TournamentState.worldCup.semiFinals.length)h+=`<button onclick="Tournament.generateSemiFinals();showTournamentStage('worldCup')">Generate Semi-Finals ‚Üí</button>`;
    if(TournamentState.worldCup.semiFinals.length){h+=`<h3 style="margin-top:20px">üéØ Semi-Finals</h3>${renderM(TournamentState.worldCup.semiFinals,'worldCup','semis')}`;
      if(done(TournamentState.worldCup.semiFinals)&&!TournamentState.worldCup.final)h+=`<button onclick="Tournament.generateFinal();showTournamentStage('worldCup')">Generate Final ‚Üí</button>`;}
    if(TournamentState.worldCup.final){h+=`<h3 style="margin-top:20px">üèÜ FINAL</h3>${renderM([TournamentState.worldCup.final],'worldCup','final')}`;}
  }
  c.innerHTML=h;
}

function playTMatch(stage,phase,idx){
  TournamentState.currentStage=stage;TournamentState.currentPhase=phase;
  let m;
  if(stage==='challengeLeague')m=phase==='groupA'?TournamentState.challengeLeague.matchesA[idx]:TournamentState.challengeLeague.matchesB[idx];
  else if(stage==='super6')m=TournamentState.super6.matches[idx];
  else if(stage==='qualifier')m=phase==='groupA'?TournamentState.qualifier.matchesA[idx]:TournamentState.qualifier.matchesB[idx];
  else if(stage==='worldCup'){
    if(phase==='main')m=TournamentState.worldCup.matches[idx];
    else if(phase==='semis')m=TournamentState.worldCup.semiFinals[idx];
    else m=TournamentState.worldCup.final;
  }
  m.pausedState?resumeMatch(m):Tournament.playMatch(m);
}

// ====== STATS CORNER ======
function showStatsCorner(){
  const c=Utils.getElement('tournamentContent');
  const s=TournamentState.userStats;
  const tName=(TournamentState.format==='ipl'?IPL_TEAMS[TournamentState.userTeam]?.name:CRICKET_TEAMS[TournamentState.userTeam]?.name)||'Your Team';

  const pl=Object.keys(s.players||{}).map(n=>({name:n,...s.players[n]}));
  const totR=pl.reduce((a,p)=>a+(p.runs||0),0);
  const totW=pl.reduce((a,p)=>a+(p.wickets||0),0);

  const topBat=[...pl].sort((a,b)=>(b.runs||0)-(a.runs||0)).slice(0,11);
  const topBow=[...pl].filter(p=>(p.wickets||0)>0).sort((a,b)=>{
    if(b.wickets!==a.wickets) return b.wickets-a.wickets;
    return (a.runsConceded||0)-(b.runsConceded||0);
  }).slice(0,11);

  const tbl=(rows,type)=>{
    if(!rows.length) return `<p style="color:#a0aec0;font-style:italic;padding:10px 0">No data yet</p>`;
    if(type==='bat') return `<table style="width:100%;border-collapse:collapse;font-size:13px">
      <thead><tr style="background:#edf2f7"><th style="padding:8px 10px;text-align:left">#</th><th style="padding:8px 10px;text-align:left">Player</th><th style="padding:8px 10px;text-align:center">Runs</th><th style="padding:8px 10px;text-align:center">Balls</th><th style="padding:8px 10px;text-align:center">Avg</th></tr></thead>
      <tbody>${rows.map((p,i)=>`<tr style="background:${i%2?'#f7fafc':'white'}">
        <td style="padding:8px 10px;font-weight:600;color:#667eea">${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':i+1}</td>
        <td style="padding:8px 10px">${Security.escapeHtml(p.name)}</td>
        <td style="padding:8px 10px;text-align:center;font-weight:700;color:#2d3748">${p.runs||0}</td>
        <td style="padding:8px 10px;text-align:center;color:#718096">${p.balls||0}</td>
        <td style="padding:8px 10px;text-align:center;color:#718096">${(p.matches||0)>0?((p.runs||0)/(p.matches)).toFixed(1):'-'}</td>
      </tr>`).join('')}</tbody></table>`;
    return `<table style="width:100%;border-collapse:collapse;font-size:13px">
      <thead><tr style="background:#edf2f7"><th style="padding:8px 10px;text-align:left">#</th><th style="padding:8px 10px;text-align:left">Player</th><th style="padding:8px 10px;text-align:center">Wkts</th><th style="padding:8px 10px;text-align:center">Runs</th><th style="padding:8px 10px;text-align:center">Avg</th></tr></thead>
      <tbody>${rows.map((p,i)=>`<tr style="background:${i%2?'#f7fafc':'white'}">
        <td style="padding:8px 10px;font-weight:600;color:#f5576c">${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':i+1}</td>
        <td style="padding:8px 10px">${Security.escapeHtml(p.name)}</td>
        <td style="padding:8px 10px;text-align:center;font-weight:700;color:#2d3748">${p.wickets||0}</td>
        <td style="padding:8px 10px;text-align:center;color:#718096">${p.runsConceded||0}</td>
        <td style="padding:8px 10px;text-align:center;color:#718096">${(p.wickets||0)>0?((p.runsConceded||0)/(p.wickets)).toFixed(1):'-'}</td>
      </tr>`).join('')}</tbody></table>`;
  };

  const hatCnt   = (s.hatTricks||[]).length;
  const cenCnt   = (s.centuries||[]).length;
  const fifCnt   = (s.fifties||[]).length;
  const threeWkt = (s.threeWickets||[]).length;
  const fiveWkt  = (s.fiveWickets||[]).length;
  const tenWkt   = (s.tenWickets||[]).length;

  const badgeRow = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px;margin-bottom:20px">
      ${[
        ['üíØ','Centuries',cenCnt,'#667eea'],
        ['5Ô∏è‚É£0Ô∏è‚É£','Half-Tons',fifCnt,'#f59e0b'],
        ['üé©','Hat-Tricks',hatCnt,'#ef4444'],
        ['üî•','3-Wkt Hauls',threeWkt,'#48bb78'],
        ['üî•üî•','5-Wkt Hauls',fiveWkt,'#764ba2'],
        ['üí•','10-Wkt Hauls',tenWkt,'#e53e3e']
      ].map(([icon,label,count,color])=>`
        <div style="background:${color};color:white;border-radius:12px;padding:14px 10px;text-align:center">
          <div style="font-size:1.6em">${icon}</div>
          <div style="font-size:1.8em;font-weight:800;line-height:1.2">${count}</div>
          <div style="font-size:11px;opacity:0.9;margin-top:2px">${label}</div>
        </div>`).join('')}
    </div>`;

  const mlRow=(items,icon,label,color,rowFn)=> items&&items.length
    ? `<div style="background:white;border-radius:10px;padding:18px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.07);border-left:4px solid ${color}">
        <h5 style="color:${color};margin-bottom:10px;font-size:14px">${icon} ${label} (${items.length})</h5>
        <div style="max-height:180px;overflow-y:auto">${items.slice().reverse().map(rowFn).join('')}</div>
      </div>` : '';

  const milestonesHtml =
    mlRow(s.centuries,'üíØ','Centuries','#667eea',c=>`<div style="font-size:13px;padding:5px 0;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between"><span>${Security.escapeHtml(c.player)}</span><span><strong>${c.runs}</strong> (${c.balls}b) ‚Äî ${Security.escapeHtml((c.match||'').substring(0,30))}</span></div>`) +
    mlRow(s.fifties,'5Ô∏è‚É£0Ô∏è‚É£','Half-Centuries','#f59e0b',f=>`<div style="font-size:13px;padding:5px 0;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between"><span>${Security.escapeHtml(f.player)}</span><span><strong>${f.runs}</strong> (${f.balls}b) ‚Äî ${Security.escapeHtml((f.match||'').substring(0,30))}</span></div>`) +
    mlRow(s.hatTricks,'üé©','Hat-Tricks','#ef4444',h=>`<div style="font-size:13px;padding:5px 0;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between"><span>${Security.escapeHtml(h.player)}</span><span style="color:#718096">${Security.escapeHtml((h.match||'').substring(0,35))}</span></div>`) +
    mlRow(s.threeWickets,'üî•','3-Wicket Hauls','#48bb78',w=>`<div style="font-size:13px;padding:5px 0;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between"><span>${Security.escapeHtml(w.player)}</span><span><strong>${w.wickets}/${w.runs}</strong> ‚Äî ${Security.escapeHtml((w.match||'').substring(0,25))}</span></div>`) +
    mlRow(s.fiveWickets,'üî•üî•','5-Wicket Hauls','#764ba2',w=>`<div style="font-size:13px;padding:5px 0;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between"><span>${Security.escapeHtml(w.player)}</span><span><strong>${w.wickets}/${w.runs}</strong> ‚Äî ${Security.escapeHtml((w.match||'').substring(0,25))}</span></div>`) +
    mlRow(s.tenWickets,'üí•','10-Wicket Hauls','#e53e3e',w=>`<div style="font-size:13px;padding:5px 0;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between"><span>${Security.escapeHtml(w.player)}</span><span><strong>${w.wickets}/${w.runs}</strong> ‚Äî ${Security.escapeHtml((w.match||'').substring(0,25))}</span></div>`);

  const backFn = TournamentState.currentStage==='wtc'?'showWTCStage':TournamentState.currentStage==='ipl'?'showIPLStage':`showTournamentStage('${TournamentState.currentStage}')`;

  c.innerHTML=`
    <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
      <button onclick="${backFn}()" style="width:auto;padding:10px 20px;background:#718096;color:white;border:none;border-radius:5px;cursor:pointer">‚Üê Back</button>
      <button onclick="returnToHome()" style="width:auto;padding:10px 20px;background:#718096;color:white;border:none;border-radius:5px;cursor:pointer">üè† Home</button>
    </div>
    <h3 style="text-align:center;margin-bottom:4px">üìä Stats Corner</h3>
    <p style="text-align:center;color:#718096;margin-bottom:20px;font-size:14px">${Security.escapeHtml(tName)}</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px">
      <div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:18px;border-radius:12px;color:white;text-align:center">
        <div style="font-size:2.6em;font-weight:800">${totR}</div><div style="opacity:0.9;font-size:13px">Total Runs Scored</div>
      </div>
      <div style="background:linear-gradient(135deg,#f093fb,#f5576c);padding:18px;border-radius:12px;color:white;text-align:center">
        <div style="font-size:2.6em;font-weight:800">${totW}</div><div style="opacity:0.9;font-size:13px">Wickets Taken</div>
      </div>
    </div>
    ${badgeRow}
    <div style="background:white;border-radius:10px;padding:20px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.07)">
      <h4 style="color:#667eea;margin-bottom:12px">üèè Most Runs</h4>
      ${tbl(topBat,'bat')}
    </div>
    <div style="background:white;border-radius:10px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.07)">
      <h4 style="color:#f5576c;margin-bottom:12px">‚ö° Most Wickets Taken</h4>
      ${tbl(topBow,'bow')}
    </div>
    ${milestonesHtml||'<p style="text-align:center;color:#a0aec0;padding:20px">Play tournament matches to unlock milestones!</p>'}`;
}

function showMatchAnimation(t1n,t2n,r){
  const ov=Utils.getElement('celebrationOverlay'),tx=Utils.getElement('celebrationText');
  const w=r.winner==='tie'?'MATCH TIED!':Security.escapeHtml(CRICKET_TEAMS[r.winner]?.name||r.winner)+' WINS!';
  tx.textContent=`${t1n} ${r.team1Score}/${r.team1Wickets} vs ${t2n} ${r.team2Score}/${r.team2Wickets}\n\n${w}`;
  ov.style.display='flex';
  setTimeout(()=>{ov.style.display='none';
    if(TournamentState.currentStage==='wtc')showWTCStage();
    else if(TournamentState.currentStage==='ipl')showIPLStage();
    else showTournamentStage(TournamentState.currentStage);
  },3000);
}

function showGrandTrophy(teamName,title){
  const t=Utils.getElement('trophyAnimation');
  Utils.setText('trophyText',`üèÜ ${title} üèÜ\n${teamName}`);
  t.classList.add('active');
  for(let i=0;i<80;i++){const cc=document.createElement('div');cc.className='confetti';cc.style.left=Math.random()*100+'%';cc.style.animationDelay=Math.random()*3+'s';cc.style.background=['#ffd700','#ff6b6b','#4ecdc4','#45b7d1'][Math.floor(Math.random()*4)];t.appendChild(cc);}
  Music.playSFX('win');
}
function closeTrophy(){
  const t=Utils.getElement('trophyAnimation');t.classList.remove('active');
  t.querySelectorAll('.confetti').forEach(c=>c.remove());
}

// ====== GAME CORE ======
const TossAnim = {
  _resolve: null,
  show(icon, title, msg, sub) {
    return new Promise(resolve => {
      this._resolve = resolve;
      document.getElementById('tossIcon').textContent = icon;
      document.getElementById('tossTitle').textContent = title;
      document.getElementById('tossMsg').textContent = msg;
      document.getElementById('tossSubMsg').textContent = sub || '';
      const row = document.getElementById('tossChoiceRow');
      row.innerHTML = '<button class="toss-choice-btn ok" onclick="TossAnim.dismiss()">OK ‚úì</button>';
      document.getElementById('tossOverlay').classList.add('show');
    });
  },
  choose(icon, title, msg, sub, choices) {
    return new Promise(resolve => {
      this._resolve = resolve;
      document.getElementById('tossIcon').textContent = icon;
      document.getElementById('tossTitle').textContent = title;
      document.getElementById('tossMsg').textContent = msg;
      document.getElementById('tossSubMsg').textContent = sub || '';
      const row = document.getElementById('tossChoiceRow');
      row.innerHTML = choices.map(c =>
        `<button class="toss-choice-btn ${Security.escapeHtml(c.cls)}" onclick="TossAnim.pick('${Security.escapeHtml(c.value)}')">${Security.escapeHtml(c.label)}</button>`
      ).join('');
      document.getElementById('tossOverlay').classList.add('show');
    });
  },
  dismiss() {
    document.getElementById('tossOverlay').classList.remove('show');
    if (this._resolve) { const r = this._resolve; this._resolve = null; r(true); }
  },
  pick(value) {
    document.getElementById('tossOverlay').classList.remove('show');
    if (this._resolve) { const r = this._resolve; this._resolve = null; r(value); }
  }
};

async function performToss(){
  GameState.tossWinner = Math.random() < 0.5 ? GameState.userTeamIndex : GameState.compTeamIndex;
  const winner = GameState.teamNames[GameState.tossWinner];
  let decision;
  if (GameState.tossWinner === GameState.userTeamIndex) {
    decision = await TossAnim.choose('ü™ô','You Won the Toss!',winner+' won the toss!','What would you like to do?',[
      {label:'üèè Bat First',value:'bat',cls:'bat'},
      {label:'üé≥ Bowl First',value:'bowl',cls:'bowl'}
    ]);
    GameState.userBattingFirst = (decision === 'bat');
  } else {
    decision = Math.random() < 0.5 ? 'bat' : 'bowl';
    GameState.userBattingFirst = (decision === 'bowl');
    await TossAnim.show('ü™ô','Toss Lost!',`${winner} won the toss and chose to ${decision} first.`,'Get ready!');
  }
  Utils.log(winner + ' won the toss and chose to ' + decision + ' first.');
}

function initializeStats(){
  for(let i=0;i<4;i++){GameState.batsmenStats[i]=[];for(let p=0;p<11;p++)GameState.batsmenStats[i].push({runs:0,balls:0,fiftyShown:false,hundredShown:false});}
  for(let t=0;t<2;t++){GameState.bowlerStats[t]=[];for(let j=0;j<11;j++)GameState.bowlerStats[t].push({name:GameState.teamPlayers[t][j]||`Bowler ${j+1}`,runs:0,balls:0,wickets:0,hatTrickShown:false,threeWktShown:false,fiveWktShown:false,tenWktShown:false,consecutiveWickets:0});}
}

function updateBowlerOptions(){
  const sel=Utils.getElement('bowlerSelect');if(!sel)return;
  const bt=1-Utils.getBattingTeamIndex();
  sel.innerHTML='';
  GameState.bowlerStats[bt].forEach((b,i)=>{const o=document.createElement('option');o.value=i;o.textContent=b.name;sel.appendChild(o);});
  sel.disabled=GameState.currentBowler!==null;
  if(GameState.currentBowler!==null)sel.value=GameState.currentBowler;
  Utils.toggleButtons('.number-buttons button',GameState.currentBowler!==null);
}

function handleBowlerSelection(){
  const v=Utils.getValue('bowlerSelect');
  const idx=Security.validateNumber(v,0,10,null);
  if(idx===null)return;
  if(idx===GameState.lastBowler){alert('Same bowler cannot bowl consecutive overs.');Utils.getElement('bowlerSelect').value='';return;}
  GameState.currentBowler=idx;Utils.getElement('bowlerSelect').disabled=true;
  Utils.toggleButtons('.number-buttons button',true);updateUI();
}

function updateUI(){
  const b=GameState.ballsBowled[GameState.currentInnings],oc=Math.floor(b/GameState.ballsPerOver),bi=b%GameState.ballsPerOver;
  const bti=Utils.getBattingTeamIndex(),pn=GameState.teamPlayers[bti];
  const ss=GameState.batsmenStats[GameState.currentInnings][GameState.striker]||{runs:0,balls:0};
  const ns=GameState.batsmenStats[GameState.currentInnings][GameState.nonStriker]||{runs:0,balls:0};
  Utils.setText('batsmenStatus','üèè On Strike: '+(pn[GameState.striker]||'Batsman '+(GameState.striker+1))+' ('+ss.runs+' - '+ss.balls+') | Non-striker: '+(pn[GameState.nonStriker]||'Batsman '+(GameState.nonStriker+1))+' ('+ns.runs+' - '+ns.balls+')');
  Utils.setText('scoreDisplay',GameState.scores[GameState.currentInnings]+'/'+GameState.wickets[GameState.currentInnings]);
  Utils.setText('oversDisplay',oc+'.'+bi);
  if(GameState.targets[GameState.currentInnings])Utils.setText('targetDisplay',(GameState.targets[GameState.currentInnings]-GameState.scores[GameState.currentInnings])+' runs');
  else Utils.setText('targetDisplay','-');
  let bl='Balls: '+GameState.ballByBall[GameState.currentInnings].join(', ');
  if(GameState.targets[GameState.currentInnings])bl+=' | Target: '+GameState.targets[GameState.currentInnings]+' | Need: '+(GameState.targets[GameState.currentInnings]-GameState.scores[GameState.currentInnings]);
  Utils.setText('ballLog',bl);
  let bs='Bowler Stats: ';
  if(GameState.currentBowler!==null){const bt2=1-Utils.getBattingTeamIndex(),bow=GameState.bowlerStats[bt2][GameState.currentBowler];bs+=bow.name+': '+Math.floor(bow.balls/6)+'.'+bow.balls%6+' ov, '+bow.runs+'r, '+bow.wickets+'w';}
  else bs+='No bowler selected.';
  Utils.setText('bowlerStats',bs);
  const cb=GameState.totalMatchBalls,cd=Math.floor(cb/(GameState.dayOvers*GameState.ballsPerOver))+1;
  Utils.setText('dayOversDisplay','Day '+cd+' | Over '+Math.floor(cb/GameState.ballsPerOver)+'.'+cb%GameState.ballsPerOver);
  const declBtn=Utils.getElement('declareBtn');
  if(declBtn){
    const canDeclare = GameState.matchMode==='test'&&Utils.getBattingTeamIndex()===GameState.userTeamIndex&&GameState.currentInnings<=2&&GameState.currentBowler!==null&&Utils.getElement('continueDayBtn').style.display==='none';
    declBtn.style.display = canDeclare ? 'inline-block' : 'none';
  }
}

// ====== CELEBRATION ======
const Celebration={
  add(msg){GameState.celebrationQueue.push(msg);if(!GameState.celebrationInProgress)this.displayNext();},
  displayNext(){
    if(!GameState.celebrationQueue.length){GameState.celebrationInProgress=false;return;}
    GameState.celebrationInProgress=true;
    const ov=Utils.getElement('celebrationOverlay'),tx=Utils.getElement('celebrationText'),msg=GameState.celebrationQueue.shift();
    if(ov&&tx){tx.textContent=msg;ov.style.display='flex';setTimeout(()=>{ov.style.display='none';setTimeout(()=>this.displayNext(),300);},2500);}
  },
  enqueueAndPlay(q,cb){
    if(q&&q.length){q.forEach(m=>GameState.celebrationQueue.push(m));if(!GameState.celebrationInProgress)this.displayNext();
      if(cb){const t=setInterval(()=>{if(!GameState.celebrationInProgress&&!GameState.celebrationQueue.length){clearInterval(t);cb();}},200);}}
    else if(cb)cb();
  }
};

// ====== PLAY BALL ======
function playBall(userRun){
  if(GameState.currentBowler===null){alert('Select a bowler first.');return;}
  if(Utils.getElement('continueDayBtn').style.display!=='none'){alert('Day ended. Click Continue Next Day.');return;}
  const bti=Utils.getBattingTeamIndex(),bwi=1-bti,si=GameState.striker;
  const ss=GameState.batsmenStats[GameState.currentInnings][si];
  const bow=GameState.bowlerStats[bwi][GameState.currentBowler];
  const isComp=(bti===GameState.compTeamIndex);
  let batsRun=0,out=false;
  if(isComp){batsRun=AI.getSmartBattingRun();out=(userRun===batsRun);}
  else{batsRun=userRun;const cd=AI.getSmartBowlingRun();out=(batsRun===cd);GameState.recentUserRuns.push(batsRun);if(GameState.recentUserRuns.length>5)GameState.recentUserRuns.shift();}
  GameState.ballsBowled[GameState.currentInnings]++;GameState.totalMatchBalls++;bow.balls++;
  const q=[];
  if(out){
    ss.balls++;GameState.wickets[GameState.currentInnings]++;bow.wickets++;
    bow.consecutiveWickets=(bow.consecutiveWickets||0)+1;
    const pn=GameState.teamPlayers[bti][GameState.striker]||'Batsman '+(GameState.striker+1);
    Utils.log(pn+' is OUT!');GameState.striker=GameState.wickets[GameState.currentInnings]+1;
    q.push('üéØ WICKET!');
    Music.playSFX('wicket');
    if(bow.consecutiveWickets===3&&!bow.hatTrickShown){
      bow.hatTrickShown=true;q.push('üé© HAT-TRICK by '+bow.name+'!');
      if(bwi===GameState.userTeamIndex){
        GameState._matchHattricks++;
        if(GameState.isTournament)TournamentState.userStats.hatTricks.push({player:bow.name,match:GameState.teamNames[0]+' vs '+GameState.teamNames[1]});
      }
    }
    if(!bow.threeWktShown&&bow.wickets>=3){bow.threeWktShown=true;q.push('üî• 3-WICKET HAUL by '+bow.name+'!');
      if(bwi===GameState.userTeamIndex&&GameState.isTournament)TournamentState.userStats.threeWickets.push({player:bow.name,wickets:bow.wickets,runs:bow.runs,match:GameState.teamNames[0]+' vs '+GameState.teamNames[1]});
    }
    if(!bow.fiveWktShown&&bow.wickets>=5){bow.fiveWktShown=true;q.push('üî•üî• 5-WICKET HAUL by '+bow.name+'!');
      if(bwi===GameState.userTeamIndex&&GameState.isTournament)TournamentState.userStats.fiveWickets.push({player:bow.name,wickets:bow.wickets,runs:bow.runs,match:GameState.teamNames[0]+' vs '+GameState.teamNames[1]});
    }
    if(!bow.tenWktShown&&bow.wickets>=10){bow.tenWktShown=true;q.push('üí• 10-WICKET HAUL by '+bow.name+'!');}
    if(isComp)AI.banRunAfterWicket(userRun);
  } else {
    GameState.batsmenStats[GameState.currentInnings][si].runs+=batsRun;
    GameState.batsmenStats[GameState.currentInnings][si].balls++;
    GameState.scores[GameState.currentInnings]+=batsRun;
    if(GameState.targets[GameState.currentInnings]&&GameState.scores[GameState.currentInnings]>=GameState.targets[GameState.currentInnings]){
      GameState.ballByBall[GameState.currentInnings].push(batsRun);updateUI();Celebration.enqueueAndPlay(q,endInnings);return;
    }
    bow.runs+=batsRun;bow.consecutiveWickets=0;
    if(batsRun===1||batsRun===3||batsRun===5)[GameState.striker,GameState.nonStriker]=[GameState.nonStriker,GameState.striker];
    const bst=GameState.batsmenStats[GameState.currentInnings][si];
    const bpn=GameState.teamPlayers[bti][si]||'Batsman '+(si+1);
    if(bst.runs>=50&&!bst.fiftyShown){
      bst.fiftyShown=true;q.push('üèè '+bpn+' reaches FIFTY!');
      if(bti===GameState.userTeamIndex){
        GameState._matchFifties++;
        if(GameState.isTournament)TournamentState.userStats.fifties.push({player:bpn,runs:bst.runs,balls:bst.balls,match:GameState.teamNames[0]+' vs '+GameState.teamNames[1]});
      }
    }
    if(bst.runs>=100&&!bst.hundredShown){
      bst.hundredShown=true;q.push('üèè '+bpn+' reaches CENTURY!');
      if(bti===GameState.userTeamIndex){
        GameState._matchCenturies++;
        if(GameState.isTournament)TournamentState.userStats.centuries.push({player:bpn,runs:bst.runs,balls:bst.balls,match:GameState.teamNames[0]+' vs '+GameState.teamNames[1]});
      }
    }
    if(batsRun===6){q.push('üí• SIX!');Music.playSFX('six');}
    else if(batsRun===4){q.push('üéØ FOUR!');Music.playSFX('four');}
  }
  GameState.ballByBall[GameState.currentInnings].push(out?'W':batsRun);updateUI();
  if(GameState.matchMode==='test'){
    if(GameState.wickets[GameState.currentInnings]>=10){Celebration.enqueueAndPlay(q,endInnings);return;}
    if(GameState.totalMatchBalls%(GameState.dayOvers*GameState.ballsPerOver)===0&&GameState.totalMatchBalls<GameState.totalMatchBallsLimit){
      const d=Math.floor((GameState.totalMatchBalls-1)/(GameState.dayOvers*GameState.ballsPerOver))+1;
      Utils.log('--- Stumps: Day '+d+' Ends ---');
      Utils.toggleButtons('.number-buttons button',false);Utils.getElement('bowlerSelect').disabled=true;
      Utils.getElement('continueDayBtn').style.display='inline-block';return;
    }
    if(GameState.totalMatchBalls>=GameState.totalMatchBallsLimit){Celebration.enqueueAndPlay(q,()=>finishMatch('Match Drawn - Time limit reached','draw'));return;}
  }
  if(GameState.ballsBowled[GameState.currentInnings]%GameState.ballsPerOver===0){
    [GameState.striker,GameState.nonStriker]=[GameState.nonStriker,GameState.striker];
    GameState.lastBowler=GameState.currentBowler;
    const bwTi=1-bti;
    if(bwTi===GameState.compTeamIndex){
      let nb;do{nb=Math.floor(Math.random()*GameState.teamPlayers[bwTi].length);}while(nb===GameState.lastBowler&&GameState.teamPlayers[bwTi].length>1);
      GameState.currentBowler=nb;
      Utils.getElement('bowlerSelect').value=nb;Utils.getElement('bowlerSelect').disabled=true;
      Utils.toggleButtons('.number-buttons button',true);
    } else {
      GameState.currentBowler=null;Utils.getElement('bowlerSelect').disabled=false;
      Utils.toggleButtons('.number-buttons button',false);Utils.log('End of over. Select next bowler.');
    }
  }
  if(GameState.wickets[GameState.currentInnings]>=10||(GameState.ballsBowled[GameState.currentInnings]>=GameState.totalBallsPerInnings&&GameState.matchMode!=='test')){Celebration.enqueueAndPlay(q,endInnings);return;}
  Celebration.enqueueAndPlay(q);
}

function continueNextDay(){
  GameState.currentBowler=null;GameState.lastBowler=null;
  Utils.getElement('bowlerSelect').disabled=false;
  Utils.toggleButtons('.number-buttons button',false);
  Utils.getElement('continueDayBtn').style.display='none';
  const nd=Math.floor(GameState.totalMatchBalls/(GameState.dayOvers*GameState.ballsPerOver))+1;
  Utils.log('--- Day '+nd+' begins ---');updateUI();
}

function endInnings(){
  const bti=Utils.getBattingTeamIndex();
  Utils.log(GameState.teamNames[bti]+' innings over: '+GameState.scores[GameState.currentInnings]+'/'+GameState.wickets[GameState.currentInnings]);
  if(GameState.matchMode==='test')handleTestEnd(bti);else handleLimitedEnd(bti);
}

function handleTestEnd(bti){
  if(GameState.currentInnings===1){
    const d=GameState.scores[0]-GameState.scores[1];
    Utils.log(d>0?GameState.teamNames[Utils.getBattingTeamIndex(1)]+' trail by '+d:d<0?GameState.teamNames[Utils.getBattingTeamIndex(1)]+' lead by '+Math.abs(d):'Scores level');
    const lead=GameState.scores[0]-GameState.scores[1];
    const battingFirstTeam=Utils.getBattingTeamIndex(0);
    if(lead>=150){
      const firstBatTeam=battingFirstTeam;
      if(firstBatTeam===GameState.userTeamIndex){
        TossAnim.choose('üìã','Follow-On Available!','You lead by '+lead+' runs. Enforce the follow-on?','Opponent bats again immediately',[
          {label:'üìã Enforce Follow-On',value:'yes',cls:'followon'},
          {label:'üèè No, Bat Again',value:'no',cls:'nofollow'}
        ]).then(choice=>{
          if(choice==='yes'){Utils.log('Follow-on enforced! '+GameState.teamNames[1-firstBatTeam]+' bat again.');}
          GameState.currentInnings=2;GameState.striker=0;GameState.nonStriker=1;updateBowlerOptions();updateUI();
        });
        return;
      } else {
        if(Math.random()<0.7){
          Utils.log('Follow-on enforced!');
          TossAnim.show('üìã','Follow-On Enforced!',GameState.teamNames[battingFirstTeam]+' enforce the follow-on!','Lead: '+lead+' runs').then(()=>{
            GameState.currentInnings=2;GameState.striker=0;GameState.nonStriker=1;updateBowlerOptions();updateUI();
          });
          return;
        }
      }
    }
  }
  if(GameState.currentInnings<3){GameState.currentInnings++;GameState.striker=0;GameState.nonStriker=1;updateBowlerOptions();updateUI();}
  else{
    const t1=GameState.scores[0]+GameState.scores[2],t2=GameState.scores[1]+GameState.scores[3];
    let res;if(t2===t1)res='Match TIED ü§ù';else if(t2>t1)res=GameState.teamNames[GameState.compTeamIndex]+' WIN by '+(t2-t1)+' runs';else res=GameState.teamNames[GameState.userTeamIndex]+' WIN by '+(t1-t2)+' runs';
    handleMatchComplete(res,t1,t2);
  }
}

function handleMatchComplete(resultText,t1Score,t2Score){
  if(GameState.isTournament&&GameState.currentMatch){
    const match=GameState.currentMatch,u=TournamentState.userTeam,uIs1=match.team1===u;
    let s1,s2;
    if(uIs1){s1=GameState.userBattingFirst?t1Score:t2Score;s2=GameState.userBattingFirst?t2Score:t1Score;}
    else{s2=GameState.userBattingFirst?t1Score:t2Score;s1=GameState.userBattingFirst?t2Score:t1Score;}
    const winner=s1>s2?match.team1:s2>s1?match.team2:'tie';
    const result={team1Score:s1,team1Wickets:GameState.wickets[0]+GameState.wickets[2],team2Score:s2,team2Wickets:GameState.wickets[1]+GameState.wickets[3],winner};
    match.completed=true;match.result=result;match.pausedState=null;
    if(TournamentState.currentStage==='wtc')updateWTCMatchResult(match,result);
    if(TournamentState.currentStage==='wtc'&&TournamentState.currentPhase==='final'&&result.winner===u){
      finishMatch(resultText,'win');TournamentHistory.addWin(TournamentState.format,u,CRICKET_TEAMS[u].name);
      saveTournamentNow();DataManager.deleteTournamentSlot(TournamentState._slotId);
      setTimeout(()=>showGrandTrophy(CRICKET_TEAMS[u].name,'WTC CHAMPIONS!'),2000);return;
    }
  }
  finishMatch(resultText,'win');
}

function handleLimitedEnd(bti){
  if(GameState.currentInnings===0){
    GameState.targets[1]=GameState.scores[0]+1;GameState.currentInnings=1;GameState.striker=0;GameState.nonStriker=1;
    Utils.log(GameState.teamNames[Utils.getBattingTeamIndex(1)]+' need '+GameState.targets[1]+' to win.');
    updateBowlerOptions();updateUI();
  } else {
    const s0=GameState.scores[0],s1=GameState.scores[1];
    if(s1===s0){finishMatch('Match TIED ü§ù','tie');return;}
    let winner,res;
    if(s1<s0){winner=Utils.getBattingTeamIndex(0);res=GameState.teamNames[winner]+' WIN by '+(s0-s1)+' runs';}
    else{winner=Utils.getBattingTeamIndex(1);res=GameState.teamNames[winner]+' WIN by '+(10-GameState.wickets[1])+' wickets';}
    if(GameState.isTournament&&GameState.currentMatch){
      const match=GameState.currentMatch,u=TournamentState.userTeam,uIs1=match.team1===u;
      let ts1,ts2,tw1,tw2;
      if(uIs1){ts1=GameState.userBattingFirst?s0:s1;tw1=GameState.userBattingFirst?GameState.wickets[0]:GameState.wickets[1];ts2=GameState.userBattingFirst?s1:s0;tw2=GameState.userBattingFirst?GameState.wickets[1]:GameState.wickets[0];}
      else{ts2=GameState.userBattingFirst?s0:s1;tw2=GameState.userBattingFirst?GameState.wickets[0]:GameState.wickets[1];ts1=GameState.userBattingFirst?s1:s0;tw1=GameState.userBattingFirst?GameState.wickets[1]:GameState.wickets[0];}
      const mWinner=ts1>ts2?match.team1:ts2>ts1?match.team2:'tie';
      const result={team1Score:ts1,team1Wickets:tw1,team2Score:ts2,team2Wickets:tw2,winner:mWinner};
      match.completed=true;match.result=result;match.pausedState=null;
      Utils.getElement('pauseMatchBtn').style.display='none';
      const stg=TournamentState.currentStage,ph=TournamentState.currentPhase;
      if(stg==='challengeLeague'){const st=ph==='groupA'?TournamentState.challengeLeague.standingsA:TournamentState.challengeLeague.standingsB;Tournament.updateStandings(st,match.team1,match.team2,result);}
      else if(stg==='super6')Tournament.updateStandings(TournamentState.super6.standings,match.team1,match.team2,result);
      else if(stg==='qualifier'){const st=ph==='groupA'?TournamentState.qualifier.standingsA:TournamentState.qualifier.standingsB;Tournament.updateStandings(st,match.team1,match.team2,result);}
      else if(stg==='worldCup'&&ph==='main')Tournament.updateStandings(TournamentState.worldCup.standings,match.team1,match.team2,result);
      else if(stg==='ipl')updateIPLMatchResult(match,result);
      const isFinal=(stg==='worldCup'&&ph==='final')||(stg==='ipl'&&ph==='final');
      if(isFinal&&mWinner===u){
        finishMatch(res,'win');
        const tn=TournamentState.format==='ipl'?IPL_TEAMS[u].name:CRICKET_TEAMS[u].name;
        TournamentHistory.addWin(TournamentState.format,u,tn);
        saveTournamentNow();DataManager.deleteTournamentSlot(TournamentState._slotId);
        const title=stg==='ipl'?'IPL CHAMPIONS!':TournamentState.format==='t20WorldCup'?'T20 WORLD CUP CHAMPIONS!':'ODI WORLD CUP CHAMPIONS!';
        setTimeout(()=>showGrandTrophy(tn,title),2000);return;
      }
    }
    finishMatch(res,'win');
  }
}

function updateUserStats(){
  if(!GameState.isTournament)return;
  const uti=GameState.userTeamIndex;
  const mn=GameState.teamNames[0]+' vs '+GameState.teamNames[1];
  if(!TournamentState.userStats.playerInnings)TournamentState.userStats.playerInnings={};
  if(!TournamentState.userStats.players)TournamentState.userStats.players={};

  for(let inn=0;inn<4;inn++){
    if(inn>=2&&GameState.scores[inn]===0&&GameState.wickets[inn]===0&&GameState.ballsBowled[inn]===0)continue;
    const bti2=Utils.getBattingTeamIndex(inn);
    const bwi2=1-bti2;

    if(bti2===uti){
      const bsArr=GameState.batsmenStats[inn];if(!bsArr||!bsArr.length)continue;
      bsArr.forEach((bat,idx)=>{
        if(!bat||bat.balls===0)return;
        const pn=GameState.teamPlayers[uti][idx];if(!pn)return;
        if(!TournamentState.userStats.players[pn])TournamentState.userStats.players[pn]={runs:0,balls:0,wickets:0,runsConceded:0,matches:0};
        const ik=mn+'_Inn'+(inn+1)+'_Bat_'+pn;
        if(TournamentState.userStats.playerInnings[ik])return;
        TournamentState.userStats.playerInnings[ik]={runs:bat.runs,balls:bat.balls};
        const p=TournamentState.userStats.players[pn];
        p.runs+=bat.runs;p.balls+=bat.balls;p.matches++;
        if(bat.runs>TournamentState.userStats.highestScore.runs)
          TournamentState.userStats.highestScore={runs:bat.runs,player:pn,match:mn};
      });
    }

    if(bwi2===uti){
      const bwArr=GameState.bowlerStats[uti];if(!bwArr||!bwArr.length)continue;
      bwArr.forEach(bow=>{
        if(!bow||!bow.name||bow.balls===0)return;
        if(!TournamentState.userStats.players[bow.name])
          TournamentState.userStats.players[bow.name]={runs:0,balls:0,wickets:0,runsConceded:0,matches:0};
        const ik=mn+'_Inn'+(inn+1)+'_Bowl_'+bow.name;
        if(TournamentState.userStats.playerInnings[ik])return;
        TournamentState.userStats.playerInnings[ik]={wickets:bow.wickets,runs:bow.runs,balls:bow.balls};
        const p=TournamentState.userStats.players[bow.name];
        p.wickets+=(bow.wickets||0);
        p.runsConceded+=(bow.runs||0);
        const best=TournamentState.userStats.bestBowling;
        if(bow.wickets>best.wickets||(bow.wickets===best.wickets&&bow.runs<best.runs))
          TournamentState.userStats.bestBowling={wickets:bow.wickets,runs:bow.runs,player:bow.name,match:mn};
      });
    }
  }
}

function declareBattingInnings(){
  if(GameState.matchMode!=='test')return;
  if(Utils.getBattingTeamIndex()!==GameState.userTeamIndex)return;
  TossAnim.show('üè≥Ô∏è','Declaration!',
    GameState.teamNames[GameState.userTeamIndex]+' declare on '+GameState.scores[GameState.currentInnings]+'/'+GameState.wickets[GameState.currentInnings],
    'Good luck with the bowling!'
  ).then(()=>{
    Utils.log(GameState.teamNames[GameState.userTeamIndex]+' DECLARED on '+GameState.scores[GameState.currentInnings]+'/'+GameState.wickets[GameState.currentInnings]+'!');
    endInnings();
  });
}

function finishMatch(resultText,resultType){
  Utils.log('üèÜ '+resultText);showScorecard();
  if(GameState.isTournament){updateUserStats();saveTournamentNow();}
  let result='draw';
  if(resultType==='win'){result=resultText.includes(GameState.teamNames[GameState.userTeamIndex])?'won':'lost';}
  else if(resultType==='tie')result='draw';
  const _ubi=GameState.userBattingFirst;

  let userWkTaken=0;
  if(GameState.matchMode==='test'){
    for(let inn=0;inn<4;inn++){
      const bti=Utils.getBattingTeamIndex(inn);
      if(bti!==GameState.userTeamIndex) userWkTaken+=GameState.wickets[inn];
    }
  } else {
    userWkTaken=_ubi?GameState.wickets[1]:GameState.wickets[0];
  }

  DataManager.saveMatch({
    teamNames:[...GameState.teamNames],result,
    userRuns:GameState.scores[_ubi?0:1],
    userWickets:GameState.wickets[_ubi?0:1],
    userWkTaken,
    oppRuns:GameState.scores[_ubi?1:0],
    oppWickets:GameState.wickets[_ubi?1:0],
    format:GameState.matchMode,
    tournament:GameState.isTournament?TournamentState.format:null,
    overs:GameState.overs,
    hattricksInMatch:GameState._matchHattricks,
    centuriesInMatch:GameState._matchCenturies,
    fiftiesInMatch:GameState._matchFifties
  });

  Utils.toggleButtons('.number-buttons button',false);Utils.getElement('bowlerSelect').disabled=true;
  const rb=Utils.getElement('resultBox');
  if(rb){
    rb.className=resultType;rb.innerHTML='';
    const bd=document.createElement('div');
    const pb=document.createElement('button');pb.textContent='üìÑ Download Scorecard (PDF)';
    pb.onclick=downloadPDF;pb.style.cssText='margin:5px;width:auto';bd.appendChild(pb);
    if(GameState.isTournament){
      const bb=document.createElement('button');bb.textContent='‚Üê Back to Tournament';bb.style.cssText='margin:5px;width:auto';
      bb.onclick=()=>{showSection('tournament');if(TournamentState.currentStage==='wtc')showWTCStage();else if(TournamentState.currentStage==='ipl')showIPLStage();else showTournamentStage(TournamentState.currentStage);};
      bd.appendChild(bb);
    }
    rb.appendChild(bd);rb.style.display='block';
  }
}

function showScorecard(){
  const el=Utils.getElement('log');if(!el)return;
  let h='<hr><h3>üìä Scorecard</h3>';
  for(let i=0;i<4;i++){
    const ti=Utils.getBattingTeamIndex(i);
    if(GameState.scores[i]===0&&GameState.wickets[i]===0&&GameState.ballsBowled[i]===0)continue;
    const wkts=GameState.wickets[i];
    h+=`<h4>${Security.escapeHtml(GameState.teamNames[ti])} - Inn ${(i%2)+1}: ${GameState.scores[i]}/${wkts}</h4><strong>Batsmen:</strong><br>`;
    for(let p=0;p<GameState.teamPlayers[ti].length;p++){
      const s=GameState.batsmenStats[i][p];
      if(!s||s.balls===0)continue;
      const pName=Security.escapeHtml(GameState.teamPlayers[ti][p]||('Batsman '+(p+1)));
      const isOut = p < wkts;
      if(isOut) h+=`${pName}: ${s.runs}(${s.balls})<br>`;
      else h+=`<strong>${pName}*: ${s.runs}(${s.balls}) not out</strong><br>`;
    }
    h+='<br><strong>Bowlers:</strong><br>';
    GameState.bowlerStats[1-ti].forEach(b=>{if(b.balls>0)h+=`${Security.escapeHtml(b.name)}: ${Math.floor(b.balls/6)}.${b.balls%6} ov, ${b.runs}r, ${b.wickets}w<br>`;});
  }
  el.innerHTML+=h;
}

// ====== PDF DOWNLOAD ======
function downloadPDF(){
  if(typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined'){
    if(typeof jsPDF !== 'undefined'){
      _generatePDF(jsPDF);
    } else {
      showToast('‚è≥ PDF library loading... Please try again in a moment.', '#f59e0b');
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
      script.onload = () => {
        if(window.jspdf && window.jspdf.jsPDF) _generatePDF(window.jspdf.jsPDF);
        else showToast('‚ùå PDF library failed to load.', '#ef4444');
      };
      script.onerror = () => showToast('‚ùå Could not load PDF library. Check your connection.', '#ef4444');
      document.head.appendChild(script);
    }
    return;
  }
  _generatePDF(window.jspdf.jsPDF);
}

function _generatePDF(jsPDFClass){
  try {
    const doc = new jsPDFClass({ orientation: 'p', unit: 'mm', format: 'a4' });
    let y = 20;
    const lm = 20, rw = 170;

    doc.setFillColor(102, 126, 234);
    doc.rect(0, 0, 210, 18, 'F');
    doc.setTextColor(255,255,255);
    doc.setFontSize(14);
    doc.setFont('helvetica','bold');
    doc.text('üèè Hand Cricket ‚Äî Match Scorecard', lm, 12);
    doc.setTextColor(0,0,0);
    y = 25;

    doc.setFontSize(10);
    doc.setFont('helvetica','normal');
    doc.text('Date: ' + new Date().toLocaleString(), lm, y); y += 8;

    for(let i=0;i<4;i++){
      const ti=Utils.getBattingTeamIndex(i);
      if(GameState.scores[i]===0&&GameState.wickets[i]===0&&GameState.ballsBowled[i]===0)continue;
      if(y > 250){ doc.addPage(); y = 20; }

      doc.setFillColor(240, 242, 255);
      doc.rect(lm-2, y-4, rw+4, 9, 'F');
      doc.setFont('helvetica','bold');
      doc.setFontSize(12);
      const tn = (GameState.teamNames[ti]||'Team').substring(0,40);
      doc.text(`${tn} ‚Äî Inn ${(i%2)+1}: ${GameState.scores[i]}/${GameState.wickets[i]}`, lm, y);
      y += 10;

      doc.setFont('helvetica','bold');doc.setFontSize(10);
      doc.text('BATTING', lm, y); y += 6;
      doc.setFont('helvetica','normal');doc.setFontSize(9);

      const wkts = GameState.wickets[i];
      for(let p=0;p<GameState.teamPlayers[ti].length;p++){
        const s=GameState.batsmenStats[i][p];
        if(!s||s.balls===0)continue;
        if(y>275){doc.addPage();y=20;}
        const pn=(GameState.teamPlayers[ti][p]||('Batsman '+(p+1))).substring(0,30);
        const isOut = p < wkts;
        const status = isOut ? `${s.runs} (${s.balls} b)` : `${s.runs}* (${s.balls} b) - not out`;
        doc.text(`  ${pn}:  ${status}`, lm, y); y += 5;
      }

      y += 4;
      doc.setFont('helvetica','bold');doc.setFontSize(10);
      doc.text('BOWLING', lm, y); y += 6;
      doc.setFont('helvetica','normal');doc.setFontSize(9);
      GameState.bowlerStats[1-ti].forEach(b=>{
        if(b.balls===0)return;
        if(y>275){doc.addPage();y=20;}
        const bname=(b.name||'Bowler').substring(0,30);
        doc.text(`  ${bname}:  ${Math.floor(b.balls/6)}.${b.balls%6} ov | ${b.runs} runs | ${b.wickets} wkts`, lm, y); y+=5;
      });
      y += 8;
    }

    doc.setFontSize(8);doc.setTextColor(150,150,150);
    doc.text('Generated by Hand Cricket v'+APP_VERSION, lm, 290);

    doc.save('Hand-Cricket-Scorecard-' + Date.now() + '.pdf');
    showToast('‚úÖ Scorecard downloaded!', '#48bb78');
  } catch(e) {
    console.error('PDF generation error:', e);
    showToast('‚ùå PDF generation failed: ' + e.message, '#ef4444');
  }
}

// ====== PAUSE / RESUME ======
function pauseMatch(){
  if(!GameState.isTournament||!GameState.currentMatch)return;

  const gsSnapshot=JSON.parse(JSON.stringify(GameState));
  gsSnapshot.currentMatch=null;
  const pausedState={
    gameState:gsSnapshot,
    logContent:Utils.getElement('log')?.innerHTML||'',
    ballLogContent:Utils.getElement('ballLog')?.textContent||'',
    bowlerStatsContent:Utils.getElement('bowlerStats')?.textContent||''
  };

  GameState.currentMatch.pausedState=pausedState;

  _stampPausedState(pausedState, GameState.currentMatch,
                    TournamentState.currentStage, TournamentState.currentPhase);

  saveTournamentNow();

  const stage=TournamentState.currentStage;
  showSection('tournament');
  if(stage==='wtc')showWTCStage();
  else if(stage==='ipl')showIPLStage();
  else showTournamentStage(stage);
}

function resumeMatch(match){
  if(!match||!match.pausedState){
    alert('No saved match data. Starting fresh.');
    if(match.team1===TournamentState.userTeam||match.team2===TournamentState.userTeam){
      if(TournamentState.currentStage==='wtc')playWTCMatchNew(match);
      else if(TournamentState.currentStage==='ipl')playIPLMatchNew(match);
      else Tournament.playMatch(match);
    }
    return;
  }
  const sv=match.pausedState;
  const gs=JSON.parse(JSON.stringify(sv.gameState));
  const fields=['teamNames','teamPlayers','overs','ballsPerOver','totalBallsPerInnings','matchMode','currentInnings','striker','nonStriker','currentBowler','lastBowler','scores','wickets','ballsBowled','targets','batsmenStats','ballByBall','bowlerStats','userTeamIndex','compTeamIndex','userBattingFirst','tossWinner','dayOvers','maxDays','totalMatchBalls','recentUserRuns','lastBattingRuns','bannedRuns','bannedCounter','lastBowlingRuns','lastUserInputs','overKillMode','killOverNumber','isTournament','_matchHattricks','_matchCenturies','_matchFifties'];
  fields.forEach(f=>{if(gs[f]!==undefined)GameState[f]=gs[f];});
  GameState.recentUserRuns=gs.recentUserRuns||[];GameState.lastBattingRuns=gs.lastBattingRuns||[];
  GameState.bannedRuns=gs.bannedRuns||[];GameState.bannedCounter=gs.bannedCounter||{};
  GameState.celebrationQueue=[];GameState.celebrationInProgress=false;
  GameState.currentMatch=match;
  showSection('game');
  const getTeamObj=(k)=>CRICKET_TEAMS[k]||IPL_TEAMS[k]||{name:k};
  const t1n=getTeamObj(match.team1).name,t2n=getTeamObj(match.team2).name;
  Utils.setText('matchTitle',t1n+' vs '+t2n);
  const logEl=Utils.getElement('log'),blEl=Utils.getElement('ballLog'),bsEl=Utils.getElement('bowlerStats');
  if(logEl)logEl.innerHTML=sv.logContent||'';
  if(blEl)blEl.textContent=sv.ballLogContent||'';
  if(bsEl)bsEl.textContent=sv.bowlerStatsContent||'';
  updateBowlerOptions();updateUI();
  const hasBowler=GameState.currentBowler!==null;
  Utils.toggleButtons('.number-buttons button',hasBowler);
  Utils.getElement('bowlerSelect').disabled=hasBowler;
  Utils.getElement('pauseMatchBtn').style.display='block';
  Utils.getElement('continueDayBtn').style.display='none';
  Utils.log('Match resumed!');
}

// ====== DOM READY ======
window.addEventListener('DOMContentLoaded',()=>{
  DataMigration.run();

  try {
    if(typeof firebase!=='undefined'){
      app=firebase.initializeApp(firebaseConfig);
      auth=firebase.auth();
      db=firebase.firestore();
      firebaseInitialized=true;
      auth.onAuthStateChanged(u=>{currentUser=u;updateAuthUI();if(u)loadProgressFromCloud();});
      console.log('‚úÖ Firebase initialized');
    } else {
      console.log('‚ÑπÔ∏è Firebase not loaded - local mode active');
    }
  } catch(e){console.error('Firebase init error:',e);}

  updatePredefinedTeams(PREDEFINED_TEAMS);
  TournamentHistory.displayHistory();
  checkResumeBtnVisibility();
  const hb=document.getElementById('globalHomeBtn');if(hb)hb.style.display='none';
  const hm=document.getElementById('historyModal');if(hm)hm.addEventListener('click',function(e){if(e.target===this)closeHistoryModal();});
  const rm=document.getElementById('resumeModal');if(rm)rm.addEventListener('click',function(e){if(e.target===this)closeResumeModal();});
  console.log('üèè Hand Cricket v'+APP_VERSION+' loaded!');
  console.log('üíæ Saved tournaments:',DataManager.getPendingTournaments().length,'| Match history:',DataManager.getMatchHistory().length);
});
</script>
</body>
</html>


